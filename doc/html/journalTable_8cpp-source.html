<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>General Ledger: journalTable.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>journalTable.cpp</h1><a href="journalTable_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="preprocessor">#include &lt;qtable.h&gt;</span>
00002 <span class="preprocessor">#include &lt;qstringlist.h&gt;</span>
00003 <span class="preprocessor">#include &lt;qptrlist.h&gt;</span>
00004 <span class="preprocessor">#include &lt;qevent.h&gt;</span>
00005 <span class="preprocessor">#include &lt;qdialog.h&gt;</span>
00006 <span class="preprocessor">#include &lt;qlayout.h&gt;</span>
00007 <span class="preprocessor">#include &lt;qlabel.h&gt;</span>
00008 <span class="preprocessor">#include &lt;qpushbutton.h&gt;</span>
00009 
00010 <span class="preprocessor">#include "config.h"</span>
00011 <span class="preprocessor">#include "<a class="code" href="database_8h.html">database.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="journalTable_8h.html">journalTable.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="journalDescEdit_8h.html">journalDescEdit.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="accountEditItem_8h.html">accountEditItem.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="dateEdit_8h.html">dateEdit.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="moneyEditItem_8h.html">moneyEditItem.h</a>"</span>
00017 
<a name="l00018"></a><a class="code" href="classJournalTable.html#a0">00018</a> <a class="code" href="classJournalTable.html#a0">JournalTable::JournalTable</a>(QWidget *parent, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
00019     : QTable(parent,name)  
00020 {
00021     <a class="code" href="classJournalTable.html#r0">db</a> = <a class="code" href="classDatabase.html#e0">Database::instance</a>();
00022     
00023     connect(<a class="code" href="classJournalTable.html#r0">db</a>, SIGNAL(accountsChanged()), <span class="keyword">this</span>, SLOT(<a class="code" href="classJournalTable.html#k2">updateAccounts</a>()));
00024         
00025     setLeftMargin(0);
00026     setVScrollBarMode(QScrollView::AlwaysOn);
00027     setSelectionMode(QTable::SingleRow);
00028     setFocusStyle(QTable::SpreadSheet);
00029     
00030     insertColumns(0,6);
00031     
00032     QStringList labels;
00033     labels &lt;&lt; <span class="stringliteral">"Date"</span> &lt;&lt; <span class="stringliteral">"Account"</span> &lt;&lt; <span class="stringliteral">"Reference"</span> &lt;&lt; <span class="stringliteral">"Description"</span> &lt;&lt; <span class="stringliteral">"Debit"</span> &lt;&lt; <span class="stringliteral">"Credit"</span>;
00034     setColumnLabels(labels);
00035               
00036     setColumnStretchable(3, <span class="keyword">true</span>);
00037     
00038     <a class="code" href="classJournalTable.html#r5">accounts</a> = <a class="code" href="classJournalTable.html#r0">db</a>-&gt;<a class="code" href="classDatabase.html#a36">getAccountsList</a>();
00039     
00040     <a class="code" href="classJournalTable.html#a5">populate</a>();
00041     
00042     <a class="code" href="classJournalTable.html#r4">inserting</a> = <span class="keyword">false</span>;
00043     <a class="code" href="classJournalTable.html#r1">editing</a> = <span class="keyword">false</span>;
00044     
00045     connect(<span class="keyword">this</span>, SIGNAL(currentChanged(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>)), <span class="keyword">this</span>, SLOT(<a class="code" href="classJournalTable.html#k1">editingChanged</a>(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>)));
00046     connect(<span class="keyword">this</span>, SIGNAL(valueChanged(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>)), <span class="keyword">this</span>, SLOT(<a class="code" href="classJournalTable.html#k0">updateDb</a>(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>)));    
00047 }
00048 
<a name="l00049"></a><a class="code" href="classJournalTable.html#a1">00049</a> <a class="code" href="classJournalTable.html#a1">JournalTable::~JournalTable</a>()
00050 {}
00051 
<a name="l00052"></a><a class="code" href="classJournalTable.html#a5">00052</a> <span class="keywordtype">void</span> <a class="code" href="classJournalTable.html#a5">JournalTable::populate</a>()
00053 {
00054     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> row = 0; row &lt;= numRows(); row++)
00055         removeRow(0);
00056     
00057     QPtrList&lt;QStringList&gt;* data = <a class="code" href="classJournalTable.html#r0">db</a>-&gt;<a class="code" href="classDatabase.html#a38">getJournalTmpData</a>();
00058     QPtrListIterator&lt;QStringList&gt; it(*data);
00059     
00060     QStringList *stringList;
00061     <span class="keywordflow">while</span>((stringList = it.current()) != 0)
00062     {
00063         ++it;
00064         insertRows(0);
00065         setItem(0, 0, <span class="keyword">new</span> <a class="code" href="classDateEdit.html">DateEdit</a>(<span class="keyword">this</span>, stringList-&gt;operator[](1)));
00066         setItem(0, 1, <span class="keyword">new</span> <a class="code" href="classAccountEditItem.html">AccountEditItem</a>(<span class="keyword">this</span>, <a class="code" href="classJournalTable.html#r5">accounts</a>, stringList-&gt;operator[](2), stringList-&gt;operator[](0)));
00067         setItem(0, 2, <span class="keyword">new</span> QTableItem(<span class="keyword">this</span>, QTableItem::OnTyping, stringList-&gt;operator[](3)));
00068         setItem(0, 3, <span class="keyword">new</span> <a class="code" href="classJournalDescEdit.html">JournalDescEdit</a>(<span class="keyword">this</span>, stringList-&gt;operator[](4)));
00069         setItem(0, 4, <span class="keyword">new</span> <a class="code" href="classMoneyEditItem.html">MoneyEditItem</a>(<span class="keyword">this</span>, stringList-&gt;operator[](5)));
00070         setItem(0, 5, <span class="keyword">new</span> <a class="code" href="classMoneyEditItem.html">MoneyEditItem</a>(<span class="keyword">this</span>, stringList-&gt;operator[](6)));
00071         <span class="keyword">delete</span> stringList;
00072     }
00073 
00074     <span class="keyword">delete</span> data;
00075 
00076     <span class="keywordflow">if</span>(numRows())
00077     {
00078         setCurrentCell(0,0);
00079         <a class="code" href="classJournalTable.html#r2">editingRow</a> = 0;
00080         <a class="code" href="classJournalTable.html#r3">editingCol</a> = 0;
00081     }
00082 }
00083 
<a name="l00084"></a><a class="code" href="classJournalTable.html#d0">00084</a> <span class="keywordtype">void</span> <a class="code" href="classJournalTable.html#d0">JournalTable::insert</a>()
00085 {
00086     <a class="code" href="classJournalTable.html#r4">inserting</a> = <span class="keyword">true</span>;
00087 
00088     <span class="keywordtype">int</span> newRow = numRows();
00089     insertRows(newRow);
00090 
00091     <a class="code" href="classJournalTable.html#r1">editing</a> = <span class="keyword">true</span>;
00092     <a class="code" href="classJournalTable.html#r2">editingRow</a> = newRow;
00093     <a class="code" href="classJournalTable.html#r3">editingCol</a> = 0;
00094 
00095     ensureCellVisible(newRow, 0);
00096     setItem(newRow, 0, <span class="keyword">new</span> <a class="code" href="classDateEdit.html">DateEdit</a>(<span class="keyword">this</span>, <span class="stringliteral">""</span>));
00097     setItem(newRow, 1, <span class="keyword">new</span> <a class="code" href="classAccountEditItem.html">AccountEditItem</a>(<span class="keyword">this</span>, <a class="code" href="classJournalTable.html#r5">accounts</a>, <span class="stringliteral">""</span>, <a class="code" href="classJournalTable.html#r0">db</a>-&gt;<a class="code" href="classDatabase.html#a53">nextJournalTmpKey</a>()));
00098     setItem(newRow, 2, <span class="keyword">new</span> QTableItem(<span class="keyword">this</span>, QTableItem::OnTyping));
00099     setItem(newRow, 3, <span class="keyword">new</span> <a class="code" href="classJournalDescEdit.html">JournalDescEdit</a>(<span class="keyword">this</span>, <span class="stringliteral">""</span>));
00100     setItem(newRow, 4, <span class="keyword">new</span> <a class="code" href="classMoneyEditItem.html">MoneyEditItem</a>(<span class="keyword">this</span>, <span class="stringliteral">""</span>));
00101     setItem(newRow, 5, <span class="keyword">new</span> <a class="code" href="classMoneyEditItem.html">MoneyEditItem</a>(<span class="keyword">this</span>, <span class="stringliteral">""</span>));
00102     setCurrentCell(newRow,0);
00103 
00104     beginEdit(newRow, 0, <span class="keyword">false</span>);
00105 }
00106 
<a name="l00107"></a><a class="code" href="classJournalTable.html#a2">00107</a> <span class="keywordtype">bool</span> <a class="code" href="classJournalTable.html#a2">JournalTable::isInserting</a>()<span class="keyword"> const</span>
00108 <span class="keyword"></span>{
00109     <span class="keywordflow">return</span> <a class="code" href="classJournalTable.html#r4">inserting</a>;
00110 }
00111 
<a name="l00112"></a><a class="code" href="classJournalTable.html#d1">00112</a> <span class="keywordtype">void</span> <a class="code" href="classJournalTable.html#d1">JournalTable::remove</a>(<span class="keywordtype">int</span> row)
00113 {
00114     QString key = ((<a class="code" href="classAccountEditItem.html">AccountEditItem</a>*)(item(row, 1)))-&gt;getKey();
00115     
00116     QDialog dialog;
00117     dialog.setCaption(<span class="stringliteral">"Delete Record"</span>);
00118 
00119     QVBoxLayout vBoxLayout(&amp;dialog);
00120     vBoxLayout.setMargin(5);
00121     vBoxLayout.setSpacing(5);
00122 
00123     QLabel label(<span class="stringliteral">"&lt;nobr&gt;Are you sure you want to delete the selected record?&lt;/nobr&gt;"</span>, &amp;dialog);
00124 
00125     vBoxLayout.addWidget(&amp;label);
00126 
00127     vBoxLayout.addSpacing(10);
00128 
00129     QHBoxLayout hBoxLayout(&amp;vBoxLayout);
00130     hBoxLayout.setSpacing(5);
00131 
00132     QPushButton buttonDelete(QIconSet(QPixmap::fromMimeSource(ICON_PATH + <span class="stringliteral">"/deleteButton.png"</span>)),
00133                              <span class="stringliteral">"Delete"</span>, &amp;dialog);
00134     connect(&amp;buttonDelete, SIGNAL(clicked()), &amp;dialog, SLOT(accept()));
00135 
00136     QPushButton buttonDontDelete(QIconSet(QPixmap::fromMimeSource(ICON_PATH + <span class="stringliteral">"/okButton.png"</span>)),
00137                                  <span class="stringliteral">"Don't Delete"</span>, &amp;dialog);
00138     connect(&amp;buttonDontDelete, SIGNAL(clicked()), &amp;dialog, SLOT(reject()));
00139 
00140     buttonDontDelete.setDefault(<span class="keyword">true</span>);
00141 
00142     hBoxLayout.addStretch();
00143     hBoxLayout.addWidget(&amp;buttonDelete);
00144     hBoxLayout.addWidget(&amp;buttonDontDelete);
00145 
00146     <span class="keywordflow">if</span>(dialog.exec())
00147     {
00148         <a class="code" href="classJournalTable.html#r0">db</a>-&gt;<a class="code" href="classDatabase.html#a42">deleteJournalTmp</a>(key);
00149         removeRow(row);
00150     }
00151     <span class="keywordflow">if</span>(row &gt; 0)
00152         setCurrentCell(row - 1, 0);
00153 }
00154 
<a name="l00155"></a><a class="code" href="classJournalTable.html#k0">00155</a> <span class="keywordtype">void</span> <a class="code" href="classJournalTable.html#k0">JournalTable::updateDb</a>(<span class="keywordtype">int</span> row, <span class="keywordtype">int</span> col)
00156 {
00157     QString key = ((<a class="code" href="classAccountEditItem.html">AccountEditItem</a>*)(item(row, 1)))-&gt;getKey();
00158     QString date = text(row, 0);
00159     QString account = text(row, 1);
00160     QString reference = text(row, 2);
00161     QString desc = text(row, 3);
00162     QString debit = text(row, 4);
00163     QString credit = text(row, 5);
00164     <a class="code" href="classJournalTable.html#r0">db</a>-&gt;<a class="code" href="classDatabase.html#a41">updateJournalTmp</a>(key, date, account, reference, desc, debit, credit);
00165 
00166     <span class="keywordflow">if</span>(<a class="code" href="classJournalTable.html#r4">inserting</a> &amp;&amp; col == 1 &amp;&amp; text(row, 3) == <span class="stringliteral">""</span>)
00167         setText(row, 3, <a class="code" href="classJournalTable.html#r0">db</a>-&gt;<a class="code" href="classDatabase.html#a54">getAccountDesc</a>(account));
00168 }
00169 
<a name="l00170"></a><a class="code" href="classJournalTable.html#a6">00170</a> <span class="keywordtype">void</span> <a class="code" href="classJournalTable.html#a6">JournalTable::clearTable</a>()
00171 {
00172     <span class="keywordtype">int</span> rows = numRows();
00173     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> row = 0; row &lt;= rows; row++)
00174         removeRow(0);
00175 }
00176 
<a name="l00177"></a><a class="code" href="classJournalTable.html#k1">00177</a> <span class="keywordtype">void</span> <a class="code" href="classJournalTable.html#k1">JournalTable::editingChanged</a>(<span class="keywordtype">int</span> newRow, <span class="keywordtype">int</span> newCol)
00178 {
00179     <a class="code" href="classJournalTable.html#r2">editingRow</a> = newRow;
00180     <a class="code" href="classJournalTable.html#r3">editingCol</a> = newCol;
00181 }
00182 
<a name="l00183"></a><a class="code" href="classJournalTable.html#d2">00183</a> <span class="keywordtype">void</span> <a class="code" href="classJournalTable.html#d2">JournalTable::keyPressEvent</a>(QKeyEvent *event)
00184 {
00185     <span class="keywordflow">switch</span>(event-&gt;key())
00186     {
00187         <span class="keywordflow">case</span> Key_Insert:
00188             <a class="code" href="classJournalTable.html#d0">insert</a>();
00189             <span class="keywordflow">break</span>;
00190         <span class="keywordflow">case</span> Key_Delete:
00191             <a class="code" href="classJournalTable.html#d1">remove</a>(currentRow());
00192             <span class="keywordflow">break</span>;
00193         <span class="keywordflow">case</span> Key_Enter:
00194         <span class="keywordflow">case</span> Key_Return:
00195         <span class="keywordflow">case</span> Key_Tab:
00196             <span class="keywordflow">if</span>(<a class="code" href="classJournalTable.html#r1">editing</a>)
00197             {
00198                 endEdit(<a class="code" href="classJournalTable.html#r2">editingRow</a>, <a class="code" href="classJournalTable.html#r3">editingCol</a>, <span class="keyword">true</span>, <span class="keyword">true</span>);
00199                 <span class="keywordflow">if</span>(<a class="code" href="classJournalTable.html#r3">editingCol</a> == 5)
00200                 {
00201                     <a class="code" href="classJournalTable.html#r3">editingCol</a> = 0;
00202                     <span class="keywordflow">if</span>(<a class="code" href="classJournalTable.html#r2">editingRow</a> == (numRows() - 1))
00203                     {
00204                         <a class="code" href="classJournalTable.html#r4">inserting</a> = <span class="keyword">false</span>;
00205                         <a class="code" href="classJournalTable.html#r1">editing</a> = <span class="keyword">false</span>;
00206                         setCurrentCell(<a class="code" href="classJournalTable.html#r2">editingRow</a>, 0);
00207                         <span class="keywordflow">break</span>;
00208                     }
00209                     <a class="code" href="classJournalTable.html#r2">editingRow</a>++;
00210                 }
00211                 <span class="keywordflow">else</span>
00212                 {
00213                     <a class="code" href="classJournalTable.html#r3">editingCol</a>++;
00214                 }
00215             }
00216             setCurrentCell(<a class="code" href="classJournalTable.html#r2">editingRow</a>, <a class="code" href="classJournalTable.html#r3">editingCol</a>);
00217 
00218             beginEdit(<a class="code" href="classJournalTable.html#r2">editingRow</a>, <a class="code" href="classJournalTable.html#r3">editingCol</a>, <span class="keyword">false</span>);
00219 
00220             <a class="code" href="classJournalTable.html#r1">editing</a> = <span class="keyword">true</span>;
00221             <span class="keywordflow">break</span>;
00222         <span class="keywordflow">case</span> Key_Escape:
00223             <span class="keywordflow">if</span>(<a class="code" href="classJournalTable.html#r1">editing</a>)
00224             {
00225                 endEdit(<a class="code" href="classJournalTable.html#r2">editingRow</a>, <a class="code" href="classJournalTable.html#r3">editingCol</a>, <span class="keyword">true</span>, <span class="keyword">true</span>);
00226                 <a class="code" href="classJournalTable.html#r1">editing</a> = <span class="keyword">false</span>;
00227             }
00228             <span class="keywordflow">else</span>
00229                 emit <a class="code" href="classJournalTable.html#l0">goToMain</a>();
00230             <span class="keywordflow">break</span>;
00231         <span class="keywordflow">case</span> Key_F1:
00232             emit <a class="code" href="classJournalTable.html#l0">goToMain</a>();
00233             <span class="keywordflow">break</span>;
00234         <span class="keywordflow">case</span> Key_F2:
00235             emit <a class="code" href="classJournalTable.html#l1">goToAccounts</a>();
00236             <span class="keywordflow">break</span>;
00237         <span class="keywordflow">case</span> Key_F3:
00238             <span class="keywordflow">break</span>;
00239         <span class="keywordflow">case</span> Key_F4:
00240             emit <a class="code" href="classJournalTable.html#l2">goToReports</a>();
00241             <span class="keywordflow">break</span>;
00242         <span class="keywordflow">case</span> Key_F5:
00243             emit <a class="code" href="classJournalTable.html#l3">goToHelp</a>();
00244             <span class="keywordflow">break</span>;
00245         <span class="keywordflow">default</span>:
00246             QTable::keyPressEvent(event);
00247     }
00248 }
00249 
<a name="l00250"></a><a class="code" href="classJournalTable.html#a3">00250</a> <span class="keywordtype">int</span> <a class="code" href="classJournalTable.html#a3">JournalTable::debitColWidth</a>()
00251 {
00252     <span class="keywordflow">return</span> columnWidth(4);
00253 }
00254 
<a name="l00255"></a><a class="code" href="classJournalTable.html#a4">00255</a> <span class="keywordtype">int</span> <a class="code" href="classJournalTable.html#a4">JournalTable::creditColWidth</a>()
00256 {
00257     <span class="keywordflow">return</span> columnWidth(5);
00258 }
00259 
<a name="l00260"></a><a class="code" href="classJournalTable.html#k2">00260</a> <span class="keywordtype">void</span> <a class="code" href="classJournalTable.html#k2">JournalTable::updateAccounts</a>()
00261 {
00262     <a class="code" href="classJournalTable.html#r5">accounts</a> = <a class="code" href="classJournalTable.html#r0">db</a>-&gt;<a class="code" href="classDatabase.html#a36">getAccountsList</a>();
00263 }
00264 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Fri Sep 17 18:11:40 2004 for General Ledger by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
