<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>General Ledger: database.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>database.cpp</h1><a href="database_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="preprocessor">#include &lt;sstream&gt;</span>
00002 <span class="keyword">using</span> std::ostringstream;
00003 
00004 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00005 <span class="keyword">using</span> std::system;
00006 <span class="keyword">using</span> std::div;
00007 
00008 <span class="preprocessor">#include &lt;cstdio&gt;</span>
00009 <span class="keyword">using</span> std::remove;
00010 
00011 <span class="preprocessor">#include &lt;qstring.h&gt;</span>
00012 <span class="preprocessor">#include &lt;qstringlist.h&gt;</span>
00013 <span class="preprocessor">#include &lt;qsqldatabase.h&gt;</span>
00014 <span class="preprocessor">#include &lt;qsqlquery.h&gt;</span>
00015 <span class="preprocessor">#include &lt;qdir.h&gt;</span>
00016 <span class="preprocessor">#include &lt;qfile.h&gt;</span>
00017 <span class="preprocessor">#include &lt;qtextstream.h&gt;</span>
00018 <span class="preprocessor">#include &lt;qptrlist.h&gt;</span>
00019 <span class="preprocessor">#include &lt;qdialog.h&gt;</span>
00020 <span class="preprocessor">#include &lt;qlayout.h&gt;</span>
00021 <span class="preprocessor">#include &lt;qpushbutton.h&gt;</span>
00022 <span class="preprocessor">#include &lt;qlabel.h&gt;</span>
00023 <span class="preprocessor">#include &lt;qtable.h&gt;</span>
00024 <span class="preprocessor">#include &lt;qvbuttongroup.h&gt;</span>
00025 <span class="preprocessor">#include &lt;qradiobutton.h&gt;</span>
00026 <span class="preprocessor">#include &lt;qframe.h&gt;</span>
00027 <span class="preprocessor">#include &lt;qdatetime.h&gt;</span>
00028 <span class="preprocessor">#include &lt;qregexp.h&gt;</span>
00029 
00030 <span class="preprocessor">#include "config.h"</span>
00031 <span class="preprocessor">#include "<a class="code" href="database_8h.html">database.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="settings_8h.html">settings.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="editorElement_8h.html">editorElement.h</a>"</span>
00034 
<a name="l00035"></a><a class="code" href="classDatabase.html#d0">00035</a> <a class="code" href="classDatabase.html#d0">Database::Database</a>() : QObject()
00036 {
00037 <span class="preprocessor">#ifdef Q_WS_WIN</span>
00038 <span class="preprocessor"></span>    <a class="code" href="classDatabase.html#r2">connection</a> = QSqlDatabase::addDatabase(<span class="stringliteral">"QSQLITEX"</span>);
00039 <span class="preprocessor">#else</span>
00040 <span class="preprocessor"></span>    <a class="code" href="classDatabase.html#r2">connection</a> = QSqlDatabase::addDatabase(<span class="stringliteral">"QSQLITE"</span>);
00041 <span class="preprocessor">#endif</span>
00042 <span class="preprocessor"></span>    <a class="code" href="classDatabase.html#r5">report</a> = <span class="keyword">new</span> <a class="code" href="structDatabase_1_1ReportStruct.html">ReportStruct</a>;
00043     <a class="code" href="classDatabase.html#r6">journalTmpReport</a> = <span class="keyword">new</span> <a class="code" href="structDatabase_1_1JournalTmpReport.html">JournalTmpReport</a>;
00044     <a class="code" href="classDatabase.html#r7">accountsList</a> = <span class="keyword">new</span> QStringList;
00045 
00046     <a class="code" href="classDatabase.html#r0">settings</a> = <a class="code" href="classSettings.html#e0">Settings::instance</a>();
00047 
00048     <a class="code" href="classDatabase.html#r1">clientPath</a> = <a class="code" href="classDatabase.html#r0">settings</a>-&gt;<a class="code" href="classSettings.html#a1">getClientPath</a>();
00049     
00050     <a class="code" href="classDatabase.html#r4">curDb</a> = <a class="code" href="classDatabase.html#r0">settings</a>-&gt;<a class="code" href="classSettings.html#a7">getDefaultDb</a>();
00051     <a class="code" href="classDatabase.html#r3">curClient</a> = <a class="code" href="classDatabase.html#r0">settings</a>-&gt;<a class="code" href="classSettings.html#a9">getDefaultClient</a>();
00052 }
00053 
<a name="l00054"></a><a class="code" href="classDatabase.html#d1">00054</a> <a class="code" href="classDatabase.html#d1">Database::~Database</a>()
00055 {
00056     <a class="code" href="classDatabase.html#a3">closeDb</a>();
00057 
00058     <span class="keyword">delete</span> <a class="code" href="classDatabase.html#r5">report</a>;
00059     <span class="keyword">delete</span> <a class="code" href="classDatabase.html#r6">journalTmpReport</a>;
00060     <span class="keyword">delete</span> <a class="code" href="classDatabase.html#r7">accountsList</a>;
00061 
00062     <a class="code" href="classDatabase.html#r0">settings</a>-&gt;<a class="code" href="classSettings.html#a8">setDefaultDb</a>(<a class="code" href="classDatabase.html#r4">curDb</a>);
00063     <a class="code" href="classDatabase.html#r0">settings</a>-&gt;<a class="code" href="classSettings.html#a10">setDefaultClient</a>(<a class="code" href="classDatabase.html#r3">curClient</a>);
00064 }
00065 
<a name="l00066"></a><a class="code" href="classDatabase.html#e0">00066</a> <a class="code" href="classDatabase.html">Database</a>* <a class="code" href="classDatabase.html#e0">Database::instance</a>()
00067 {
00068     <span class="keywordflow">if</span>(<a class="code" href="classDatabase.html#v0">db</a> == 0)
00069         <a class="code" href="classDatabase.html#v0">db</a> = <span class="keyword">new</span> <a class="code" href="classDatabase.html">Database</a>;
00070     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#v0">db</a>;
00071 }
00072 
<a name="l00073"></a><a class="code" href="classDatabase.html#a0">00073</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a0">Database::destroy</a>()
00074 {
00075     <span class="keywordflow">if</span>(<a class="code" href="classDatabase.html#v0">db</a> != 0)
00076         <span class="keyword">delete</span> <a class="code" href="classDatabase.html#v0">db</a>;
00077 }
00078 
<a name="l00079"></a><a class="code" href="classDatabase.html#a1">00079</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#a1">Database::openNew</a>(QString file, QString password)
00080 {
00081     <a class="code" href="classDatabase.html#r1">clientPath</a> = <a class="code" href="classDatabase.html#r0">settings</a>-&gt;<a class="code" href="classSettings.html#a1">getClientPath</a>();
00082 
00083     QString file2(file);
00084 
00085     <span class="keywordflow">if</span>(password != QString::null)
00086     {
00087         file2.append(<span class="stringliteral">".db_"</span>);
00088         file.append(<span class="stringliteral">".dbx"</span>);
00089 
00090         QFile encDb(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + file);
00091         <span class="keywordflow">if</span>(!encDb.open( IO_ReadOnly ))
00092             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00093 
00094         QFile encDb2(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + file + <span class="stringliteral">"2"</span>);
00095         <span class="keywordflow">if</span>(!encDb2.open( IO_WriteOnly ))
00096             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00097 
00098         QDataStream encStream2(&amp;encDb2);
00099 
00100         QDataStream encStream(&amp;encDb);
00101         <span class="keywordtype">char</span> *string;
00102         encStream &gt;&gt; string;
00103         <span class="keyword">delete</span> string;
00104 
00105         <span class="keywordtype">char</span> *byte = <span class="keyword">new</span> <span class="keywordtype">char</span>;
00106         <span class="keywordflow">while</span>(!encStream.atEnd())
00107         {
00108             encStream.readRawBytes(byte, 1);
00109             encStream2.writeRawBytes(byte, 1);
00110         }
00111         <span class="keyword">delete</span> byte;
00112 
00113         encStream.unsetDevice();
00114         encStream2.unsetDevice();
00115         encDb.close();
00116         encDb2.close();
00117 
00118         <span class="keywordtype">int</span> retVal = system(QString(CRYPT_PATH + <span class="stringliteral">"/aescrypt2 1 \""</span> + <a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + file + <span class="stringliteral">"2\" \""</span>
00119                             + <a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + file2 + <span class="stringliteral">"\" \""</span> + password + <span class="stringliteral">"\""</span>).ascii());
00120 
00121         remove(QString(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + file + <span class="stringliteral">"2"</span>).ascii());
00122 
00123         <span class="keywordflow">if</span>(retVal != 0)
00124             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00125     }
00126     <span class="keywordflow">else</span>
00127         file2.append(<span class="stringliteral">".db"</span>);
00128     
00129     <span class="keywordflow">if</span>(<a class="code" href="classDatabase.html#r2">connection</a>-&gt;isOpen()) <a class="code" href="classDatabase.html#r2">connection</a>-&gt;close();
00130     <a class="code" href="classDatabase.html#r2">connection</a>-&gt;setDatabaseName(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + file2);
00131     <span class="keywordflow">if</span>(!<a class="code" href="classDatabase.html#r2">connection</a>-&gt;open())
00132     {
00133         <a class="code" href="classDatabase.html#r2">connection</a>-&gt;lastError().showMessage();
00134         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00135     }
00136     
00137     <a class="code" href="classDatabase.html#r4">curDb</a> = file2;
00138     
00139     QSqlQuery query(<span class="stringliteral">"SELECT name FROM main"</span>);
00140     <span class="keywordflow">if</span>(query.next())
00141         <a class="code" href="classDatabase.html#r3">curClient</a> = query.value(0).toString();
00142     <span class="keywordflow">else</span>
00143         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00144   
00145     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00146 }
00147 
<a name="l00148"></a><a class="code" href="classDatabase.html#a2">00148</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#a2">Database::createNew</a>(QString name, QString yearEnd)
00149 {
00150     <a class="code" href="classDatabase.html#r1">clientPath</a> = <a class="code" href="classDatabase.html#r0">settings</a>-&gt;<a class="code" href="classSettings.html#a1">getClientPath</a>();
00151 
00152     QString file(name);
00153     
00154     file.replace(QChar(<span class="charliteral">' '</span>), <span class="stringliteral">"_"</span>);
00155     file.replace(QChar(<span class="charliteral">'/'</span>), <span class="stringliteral">"-"</span>);
00156     file.replace(QChar(<span class="charliteral">'\\'</span>), <span class="stringliteral">"-"</span>);
00157     file.append(<span class="stringliteral">".db"</span>);
00158     
00159     <span class="keywordflow">if</span>(<a class="code" href="classDatabase.html#r2">connection</a>-&gt;isOpen()) <a class="code" href="classDatabase.html#r2">connection</a>-&gt;close();
00160     <a class="code" href="classDatabase.html#r2">connection</a>-&gt;setDatabaseName(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + file);
00161     <span class="keywordflow">if</span> (!<a class="code" href="classDatabase.html#r2">connection</a>-&gt;open())
00162     {
00163         <a class="code" href="classDatabase.html#r2">connection</a>-&gt;lastError().showMessage();
00164         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00165     }
00166     
00167     <a class="code" href="classDatabase.html#r4">curDb</a> = file;
00168     <a class="code" href="classDatabase.html#r3">curClient</a> = name;
00169         
00170     QSqlQuery createMain(<span class="stringliteral">"CREATE TABLE main (name, yearEnd)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00171     QSqlQuery createAccounts(<span class="stringliteral">"CREATE TABLE accounts (key, id, desc, PRIMARY KEY (key))"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00172     QSqlQuery createAccountsIndex(<span class="stringliteral">"CREATE INDEX accountsIndex ON accounts (id)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00173     QSqlQuery createJournal(<span class="stringliteral">"CREATE TABLE journal (date, account, reference, "</span>
00174             <span class="stringliteral">"desc, debit, credit)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00175     QSqlQuery createJournalTmp(<span class="stringliteral">"CREATE TABLE journalTmp (key, date, account, reference, "</span>
00176             <span class="stringliteral">"desc, debit, credit, PRIMARY KEY (key))"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00177     QSqlQuery createBalanceAssets(<span class="stringliteral">"CREATE TABLE balanceAssets (key, type, desc, begin, end)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00178     QSqlQuery createBalanceLiabilities(<span class="stringliteral">"CREATE TABLE balanceLiabilities (key, type, desc, begin, end)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00179     QSqlQuery createBalanceEquities(<span class="stringliteral">"CREATE TABLE balanceEquities (key, type, desc, begin, end)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00180     QSqlQuery createIncomeSvcIncome(<span class="stringliteral">"CREATE TABLE incomeSvcIncome (key, type, desc, begin, end)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00181     QSqlQuery createIncomeSvcExpenses(<span class="stringliteral">"CREATE TABLE incomeSvcExpenses (key, type, desc, begin, end)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00182     QSqlQuery createIncomeRetailIncome(<span class="stringliteral">"CREATE TABLE incomeRetailIncome (key, type, desc, begin, end)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00183     QSqlQuery createIncomeRetailCOS(<span class="stringliteral">"CREATE TABLE incomeRetailCOS (key, type, desc, begin, end)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00184     QSqlQuery createIncomeRetailExpenses(<span class="stringliteral">"CREATE TABLE incomeRetailExpenses (key, type, desc, begin, end)"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00185     
00186     QSqlQuery(<span class="stringliteral">"INSERT INTO main VALUES(\""</span> + name + <span class="stringliteral">"\", \""</span> + yearEnd + <span class="stringliteral">"\")"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00187     
00188     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00189 }
00190 
<a name="l00191"></a><a class="code" href="classDatabase.html#a3">00191</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a3">Database::closeDb</a>()
00192 {
00193     <span class="keywordflow">if</span>(<a class="code" href="classDatabase.html#r2">connection</a>-&gt;isOpen()) <a class="code" href="classDatabase.html#r2">connection</a>-&gt;close();
00194 
00195     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> = QString::null;
00196     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> = QString::null;
00197     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a> = QString::null;
00198     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> = QString::null;
00199     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o4">html</a> = QString::null;
00200 
00201     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o0">header</a> = QString::null;
00202     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o1">data</a> = QString::null;
00203 
00204     <span class="keywordflow">if</span>(<a class="code" href="classDatabase.html#r4">curDb</a>.right(4) == <span class="stringliteral">".db_"</span>)
00205     {
00206         remove(QString(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + <a class="code" href="classDatabase.html#r4">curDb</a>));
00207         remove(QString(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + curDb.left(curDb.length() - 1)));
00208         curDb = curDb.left(curDb.length() - 1).append(<span class="stringliteral">"x"</span>);
00209     }
00210 }
00211 
<a name="l00212"></a><a class="code" href="classDatabase.html#a4">00212</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a4">Database::copyDb</a>(QString file)<span class="keyword"> const</span>
00213 <span class="keyword"></span>{
00214     QString origFile;
00215     <span class="keywordtype">bool</span> encrypted;
00216     <span class="keywordflow">if</span>(<a class="code" href="classDatabase.html#r4">curDb</a>.right(4) == <span class="stringliteral">".db_"</span>)
00217     {
00218         encrypted = <span class="keyword">true</span>;
00219         origFile = <a class="code" href="classDatabase.html#r4">curDb</a>.left(<a class="code" href="classDatabase.html#r4">curDb</a>.length() - 1).append(<span class="stringliteral">"x"</span>);
00220     }
00221     <span class="keywordflow">else</span>
00222     {
00223         encrypted = <span class="keyword">false</span>;
00224         origFile = <a class="code" href="classDatabase.html#r4">curDb</a>;
00225     }
00226 
00227     QFile origDb(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + origFile);
00228 
00229     <span class="keywordflow">if</span>(file.right(3) == <span class="stringliteral">".db"</span> &amp;&amp; encrypted)
00230         file = file.left(file.length() - 3).append(<span class="stringliteral">".dbx"</span>);
00231     <span class="keywordflow">if</span>(file.right(4) == <span class="stringliteral">".dbx"</span> &amp;&amp; !encrypted)
00232         file = file.left(file.length() - 4).append(<span class="stringliteral">".db"</span>);
00233     <span class="keywordflow">if</span>(file.right(3) != <span class="stringliteral">".db"</span> &amp;&amp; file.right(4) != <span class="stringliteral">".dbx"</span> &amp;&amp; encrypted)
00234         file = file.append(<span class="stringliteral">".dbx"</span>);
00235     <span class="keywordflow">if</span>(file.right(3) != <span class="stringliteral">".db"</span> &amp;&amp; file.right(4) != <span class="stringliteral">".dbx"</span> &amp;&amp; !encrypted)
00236         file = file.append(<span class="stringliteral">".db"</span>);
00237 
00238     QFile newDb(file);
00239     
00240     <span class="keywordflow">if</span>( !origDb.open(IO_ReadOnly | IO_Raw) )
00241     {
00242         qDebug(<span class="stringliteral">"origDb not open"</span>);
00243         qDebug(origDb.errorString());
00244         <span class="keywordflow">return</span>;
00245     }
00246     <span class="keywordflow">if</span>( !newDb.open(IO_WriteOnly) )
00247     {
00248         qDebug(<span class="stringliteral">"newDb not open"</span>);
00249         qDebug(newDb.errorString());
00250         <span class="keywordflow">return</span>;
00251     }
00252     
00253     <span class="keywordflow">while</span>(!origDb.atEnd())
00254         newDb.putch(origDb.getch());
00255     
00256     newDb.close();
00257     origDb.close();
00258 }
00259 
<a name="l00260"></a><a class="code" href="classDatabase.html#a5">00260</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a5">Database::encryptDb</a>(QString password)
00261 {
00262     system(QString(CRYPT_PATH + <span class="stringliteral">"/aescrypt2 0 \""</span> + <a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + <a class="code" href="classDatabase.html#r4">curDb</a> + <span class="stringliteral">"\" \""</span>
00263             + <a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + <a class="code" href="classDatabase.html#r4">curDb</a> + <span class="stringliteral">"x2\" \""</span> + password + <span class="stringliteral">"\""</span>).ascii());
00264 
00265     QFile encDb2(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + <a class="code" href="classDatabase.html#r4">curDb</a> + <span class="stringliteral">"x2"</span>);
00266     <span class="keywordflow">if</span>(!encDb2.open( IO_ReadOnly ))
00267         <span class="keywordflow">return</span>;
00268     QDataStream encStream2(&amp;encDb2);
00269 
00270     QFile encDb(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + curDb + <span class="stringliteral">"x"</span>);
00271     encDb.open( IO_WriteOnly );
00272     QDataStream encStream(&amp;encDb);
00273 
00274     encStream &lt;&lt; QString(<span class="stringliteral">"enc:"</span> + <a class="code" href="classDatabase.html#r3">curClient</a>).ascii();
00275 
00276     <span class="keywordtype">char</span> *byte = <span class="keyword">new</span> <span class="keywordtype">char</span>;
00277     <span class="keywordflow">while</span>(!encStream2.atEnd())
00278     {
00279         encStream2.readRawBytes(byte, 1);
00280         encStream.writeRawBytes(byte, 1);
00281     }
00282     <span class="keyword">delete</span> byte;
00283 
00284     encStream.unsetDevice();
00285     encDb.close();
00286     encStream2.unsetDevice();
00287     encDb2.close();
00288 
00289     remove(QString(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + curDb + <span class="stringliteral">"x2"</span>).ascii());
00290 
00291     QString oldCurDb = curDb;
00292 
00293     <a class="code" href="classDatabase.html#a1">openNew</a>(<a class="code" href="classDatabase.html#r3">curClient</a>, password);
00294 
00295     remove(QString(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + oldCurDb).ascii());
00296 }
00297 
<a name="l00298"></a><a class="code" href="classDatabase.html#a6">00298</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a6">Database::decryptDb</a>()
00299 {
00300     QFile origDb(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + <a class="code" href="classDatabase.html#r4">curDb</a>);
00301 
00302     curDb.truncate(curDb.length() - 4);
00303 
00304     QFile newDb(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + curDb + <span class="stringliteral">".db"</span>);
00305 
00306     <span class="keywordflow">if</span>( !origDb.open(IO_ReadOnly | IO_Raw) )
00307     {
00308         qDebug(<span class="stringliteral">"origDb not open"</span>);
00309         qDebug(origDb.errorString());
00310         <span class="keywordflow">return</span>;
00311     }
00312     <span class="keywordflow">if</span>( !newDb.open(IO_WriteOnly) )
00313     {
00314         qDebug(<span class="stringliteral">"newDb not open"</span>);
00315         qDebug(newDb.errorString());
00316         <span class="keywordflow">return</span>;
00317     }
00318     
00319     <span class="keywordflow">while</span>(!origDb.atEnd())
00320         newDb.putch(origDb.getch());
00321     
00322     newDb.close();
00323     origDb.close();
00324 
00325     remove(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + curDb + <span class="stringliteral">".db_"</span>);
00326     remove(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + curDb + <span class="stringliteral">".dbx"</span>);
00327 
00328     curDb.append(<span class="stringliteral">".db"</span>);
00329 }
00330 
<a name="l00331"></a><a class="code" href="classDatabase.html#a7">00331</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#a7">Database::isEncrypted</a>()<span class="keyword"> const</span>
00332 <span class="keyword"></span>{
00333     <span class="keywordflow">if</span>(<a class="code" href="classDatabase.html#r4">curDb</a>.right(4) == <span class="stringliteral">".db_"</span>)
00334         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00335     <span class="keywordflow">else</span>
00336         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00337 }
00338 
<a name="l00339"></a><a class="code" href="classDatabase.html#a8">00339</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a8">Database::importDb</a>(QString file)<span class="keyword"> const</span>
00340 <span class="keyword"></span>{
00341     QRegExp regexp(<span class="stringliteral">"[\\/\\\\]([^\\/\\\\]*)(\\.dbx?)$"</span>);
00342     regexp.search(file);
00343 
00344     QString ext = regexp.cap(2);
00345 
00346     QString newFile = <a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + regexp.cap(1);
00347 
00348     QFile origDb(file);
00349 
00350     QFile newDb(newFile + ext);
00351 
00352     <span class="keywordtype">int</span> i = 0;
00353     <span class="keywordflow">while</span>(newDb.exists())
00354         newDb.setName(newFile + QString::number(i++) + ext);
00355 
00356     <span class="keywordflow">if</span>( !origDb.open(IO_ReadOnly | IO_Raw) )
00357     {
00358         qDebug(<span class="stringliteral">"origDb not open"</span>);
00359         qDebug(origDb.errorString());
00360         <span class="keywordflow">return</span>;
00361     }
00362     <span class="keywordflow">if</span>( !newDb.open(IO_WriteOnly) )
00363     {
00364         qDebug(<span class="stringliteral">"newDb not open"</span>);
00365         qDebug(newDb.errorString());
00366         <span class="keywordflow">return</span>;
00367     }
00368     
00369     <span class="keywordflow">while</span>(!origDb.atEnd())
00370         newDb.putch(origDb.getch());
00371     
00372     newDb.close();
00373     origDb.close();
00374 }
00375 
<a name="l00376"></a><a class="code" href="classDatabase.html#a9">00376</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a9">Database::editName</a>(QString name)
00377 {
00378     <span class="keywordflow">if</span>(!<a class="code" href="classDatabase.html#r2">connection</a>-&gt;open())
00379     {
00380         <a class="code" href="classDatabase.html#r2">connection</a>-&gt;lastError().showMessage();
00381         <span class="keywordflow">return</span>;
00382     }
00383     
00384     QSqlQuery update(<span class="stringliteral">"UPDATE main SET name = '"</span> + name + <span class="stringliteral">"'"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00385     <a class="code" href="classDatabase.html#r3">curClient</a> = name;
00386 }
00387 
<a name="l00388"></a><a class="code" href="classDatabase.html#a10">00388</a> QString <a class="code" href="classDatabase.html#a10">Database::getCurDb</a>()<span class="keyword"> const</span>
00389 <span class="keyword"></span>{
00390     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#r4">curDb</a>;
00391 }
00392 
<a name="l00393"></a><a class="code" href="classDatabase.html#a11">00393</a> QString <a class="code" href="classDatabase.html#a11">Database::getCurClient</a>()<span class="keyword"> const</span>
00394 <span class="keyword"></span>{
00395     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#r3">curClient</a>;
00396 }
00397 
<a name="l00398"></a><a class="code" href="classDatabase.html#a12">00398</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#a12">Database::curClientExists</a>()<span class="keyword"> const</span>
00399 <span class="keyword"></span>{
00400     QFile file(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + <a class="code" href="classDatabase.html#r4">curDb</a>);
00401     <span class="keywordflow">if</span>(file.exists())
00402         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00403     <span class="keywordflow">else</span>
00404         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00405 }
00406 
<a name="l00407"></a><a class="code" href="classDatabase.html#a13">00407</a> QStringList <a class="code" href="classDatabase.html#a13">Database::getClientList</a>()<span class="keyword"> const</span>
00408 <span class="keyword"></span>{
00409     QStringList list;
00410     
00411 <span class="preprocessor">#ifdef Q_WS_WIN</span>
00412 <span class="preprocessor"></span>        QSqlDatabase *connectionTemp = QSqlDatabase::addDatabase(<span class="stringliteral">"QSQLITEX"</span>, <span class="stringliteral">"temp"</span>);
00413 <span class="preprocessor">#else</span>
00414 <span class="preprocessor"></span>        QSqlDatabase *connectionTemp = QSqlDatabase::addDatabase(<span class="stringliteral">"QSQLITE"</span>, <span class="stringliteral">"temp"</span>);
00415 <span class="preprocessor">#endif </span>
00416 <span class="preprocessor"></span>    
00417     QDir dir(<a class="code" href="classDatabase.html#r1">clientPath</a>);
00418     QStringList::Iterator it;
00419     QStringList files = dir.entryList(<span class="stringliteral">"*.db"</span>, QDir::Files);
00420     it = files.begin();
00421     <span class="keywordflow">while</span>(it != files.end())
00422     {
00423         connectionTemp-&gt;setDatabaseName(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + *it);
00424         <span class="keywordflow">if</span>(connectionTemp-&gt;open())
00425         {
00426             QSqlQuery query(<span class="stringliteral">"SELECT name FROM main"</span>, connectionTemp);
00427             <span class="keywordflow">if</span>(query.next())
00428                 list &lt;&lt; (query.value(0).toString() + <span class="stringliteral">"    ("</span> + *it + <span class="stringliteral">")"</span>);
00429             connectionTemp-&gt;close();
00430         }
00431         ++it;
00432     }
00433 
00434     QFile encDb;
00435     QDataStream encStream;
00436 
00437     files = dir.entryList(<span class="stringliteral">"*.dbx"</span>, QDir::Files);
00438     it = files.begin();
00439     <span class="keywordflow">while</span>(it != files.end())
00440     {
00441         encDb.setName(<a class="code" href="classDatabase.html#r1">clientPath</a> + <span class="stringliteral">"/"</span> + *it);
00442         encDb.open( IO_ReadOnly );
00443         encStream.setDevice(&amp;encDb);
00444 
00445         <span class="keywordtype">char</span> *string;
00446         encStream &gt;&gt; string;
00447         QString qstring(string);
00448 
00449         <span class="keywordflow">if</span>(qstring.startsWith(<span class="stringliteral">"enc:"</span>))
00450             list &lt;&lt; (qstring.mid(4) + <span class="stringliteral">"    ("</span> + *it + <span class="stringliteral">")"</span>);
00451 
00452         <span class="keyword">delete</span> string;
00453         encStream.unsetDevice();
00454         encDb.close();
00455         ++it;
00456     }
00457     
00458     <span class="keywordflow">return</span> list;
00459 }
00460 
<a name="l00461"></a><a class="code" href="classDatabase.html#a14">00461</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a14">Database::exportCSV</a>(QString table, QString file)<span class="keyword"> const</span>
00462 <span class="keyword"></span>{
00463     <span class="keywordflow">if</span>(file.right(4) != <span class="stringliteral">".csv"</span>)
00464         file.append(<span class="stringliteral">".csv"</span>);
00465 
00466     QFile destFile(file);
00467     
00468     <span class="keywordflow">if</span>(destFile.open(IO_WriteOnly))
00469     {
00470         QTextStream destStream(&amp;destFile);
00471         
00472         QSqlQuery query(<span class="stringliteral">"SELECT * FROM "</span> + table);
00473         
00474         <span class="keywordflow">if</span>(table == <span class="stringliteral">"accounts"</span>)
00475         {
00476             destStream &lt;&lt; <span class="stringliteral">"Account ID,Account Description\n"</span>;
00477         
00478             <span class="keywordflow">while</span>(query.next())
00479                 destStream &lt;&lt; query.value(1).toString() &lt;&lt; <span class="stringliteral">","</span> &lt;&lt; query.value(2).toString() &lt;&lt; <span class="stringliteral">"\n"</span>;
00480         }
00481         <span class="keywordflow">if</span>(table == <span class="stringliteral">"journalTmp"</span>)
00482         {
00483             destStream &lt;&lt; <span class="stringliteral">"Date,Account,Reference,Description,Debit,Credit\n"</span>;
00484             
00485             <span class="keywordflow">while</span>(query.next())
00486             {
00487                 destStream &lt;&lt; query.value(1).toString() &lt;&lt; <span class="stringliteral">","</span> &lt;&lt; query.value(2).toString() &lt;&lt; <span class="stringliteral">","</span>
00488                         &lt;&lt; query.value(3).toString() &lt;&lt; <span class="stringliteral">","</span> &lt;&lt; query.value(4).toString() &lt;&lt; <span class="stringliteral">","</span>
00489                         &lt;&lt; query.value(5).toString() &lt;&lt; <span class="stringliteral">","</span> &lt;&lt; query.value(6).toString() &lt;&lt; <span class="stringliteral">"\n"</span>;
00490             }
00491         }
00492     }
00493     destFile.close();
00494 }
00495 
<a name="l00496"></a><a class="code" href="classDatabase.html#a15">00496</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a15">Database::importCSV</a>(QString table, QString file)
00497 {
00498     QFile origFile(file);
00499     
00500     <span class="keywordflow">if</span>(origFile.open(IO_ReadOnly))
00501     {
00502         QTextStream origStream(&amp;origFile);
00503         QStringList data;
00504         QPtrList&lt;QStringList&gt; values;
00505         QStringList *list;
00506         
00507         <span class="keywordtype">int</span> i = 0;
00508         QString line;
00509         <span class="keywordflow">while</span>(!origStream.atEnd())
00510         {
00511             line = origStream.readLine();
00512             data &lt;&lt; line;
00513             
00514             <span class="keywordflow">if</span>(i &lt; 3)
00515             {
00516                 list = <span class="keyword">new</span> QStringList(QStringList::split(<span class="stringliteral">","</span>, line));
00517                 values.append(list);
00518             }
00519             i++;
00520         }
00521         
00522         <span class="keywordflow">if</span>(!values.isEmpty())
00523         {
00524             QDialog dialog;
00525             dialog.setCaption(<span class="stringliteral">"Import CSV Data"</span>);
00526             
00527             QVBoxLayout vBoxLayout(&amp;dialog);
00528             vBoxLayout.setMargin(5);
00529             vBoxLayout.setSpacing(5);
00530             
00531             QLabel label(<span class="stringliteral">"&lt;nobr&gt;The first three records of the file are shown.&lt;/nobr&gt;&lt;br&gt;"</span>
00532                     <span class="stringliteral">"&lt;nobr&gt;Choose whether the first record is a header or data.&lt;/nobr&gt;"</span>, &amp;dialog);
00533             
00534             QTable dataTable(3, values.first()-&gt;count(), &amp;dialog);
00535             dataTable.setLeftMargin(0);
00536             dataTable.setTopMargin(0);
00537             dataTable.setSelectionMode(QTable::SingleRow);
00538             dataTable.setFocusStyle(QTable::FollowStyle);
00539             
00540             <span class="keywordtype">int</span> row = 0;
00541             <span class="keywordtype">int</span> col = 0;
00542             <span class="keywordflow">for</span>(list = values.first(); list; list = values.next())
00543             {
00544                 col = 0;
00545                 <span class="keywordflow">for</span>(QStringList::Iterator it = list-&gt;begin(); it != list-&gt;end(); it++)
00546                 {
00547                     dataTable.setItem(row, col, <span class="keyword">new</span> QTableItem(&amp;dataTable, QTableItem::Never, *it));
00548                     col++;
00549                 }
00550                 row++;
00551             }
00552             dataTable.setColumnStretchable((col - 1), <span class="keyword">true</span>);
00553             dataTable.selectRow(0);
00554             
00555             QVButtonGroup buttonGroup(&amp;dialog);
00556             QRadioButton headerButton(<span class="stringliteral">"The first record is a header"</span>, &amp;buttonGroup);
00557             headerButton.setChecked(<span class="keyword">true</span>);
00558             QRadioButton dataButton(<span class="stringliteral">"The first record is data"</span>, &amp;buttonGroup);
00559         
00560             QFrame okCancelFrame(&amp;dialog);
00561             QHBoxLayout okCancelLayout(&amp;okCancelFrame);
00562             okCancelLayout.setSpacing(5);
00563         
00564             QPushButton okButton(QIconSet(QPixmap::fromMimeSource(ICON_PATH + <span class="stringliteral">"/okButton.png"</span>)),
00565                                  <span class="stringliteral">"OK"</span>, &amp;okCancelFrame);
00566             connect(&amp;okButton, SIGNAL(clicked()), &amp;dialog, SLOT(accept()));
00567             QPushButton cancelButton(QIconSet(QPixmap::fromMimeSource(ICON_PATH + <span class="stringliteral">"/cancelButton.png"</span>)),
00568                                      <span class="stringliteral">"Cancel"</span>, &amp;okCancelFrame);
00569             connect(&amp;cancelButton, SIGNAL(clicked()), &amp;dialog, SLOT(reject()));
00570             
00571             okCancelLayout.addStretch();
00572             okCancelLayout.addWidget(&amp;okButton);
00573             okCancelLayout.addWidget(&amp;cancelButton);
00574         
00575             vBoxLayout.addWidget(&amp;label);
00576             vBoxLayout.addWidget(&amp;dataTable);
00577             vBoxLayout.addWidget(&amp;buttonGroup);
00578             vBoxLayout.addSpacing(10);
00579             vBoxLayout.addWidget(&amp;okCancelFrame);
00580             
00581             <span class="keywordflow">if</span>(dialog.exec())
00582             {
00583                 QSqlQuery query(<span class="stringliteral">"SELECT key FROM "</span> + table, <a class="code" href="classDatabase.html#r2">connection</a>);
00584                 <span class="keywordtype">int</span> key = 0;
00585                 <span class="keywordflow">while</span>(query.next())
00586                 {
00587                     <span class="keywordflow">if</span>(key &lt; query.value(0).toInt())
00588                         key = query.value(0).toInt();
00589                 }
00590                 key++;
00591                 
00592                 <span class="keywordtype">int</span> firstLine;
00593                 <span class="keywordflow">if</span>(headerButton.isChecked())
00594                     firstLine = 1;
00595                 <span class="keywordflow">else</span>
00596                     firstLine = 0;
00597                 
00598                 <span class="keywordtype">int</span> curLine = 0;
00599                 <span class="keywordflow">for</span>(QStringList::Iterator it = data.begin(); it != data.end(); it++)
00600                 {
00601                     <span class="keywordflow">if</span>(curLine &lt; firstLine)  {curLine++; <span class="keywordflow">continue</span>;}
00602                     
00603                     (*it).replace(<span class="charliteral">','</span>, <span class="stringliteral">"\", \""</span>);
00604                     
00605                     <span class="keywordflow">if</span>(table == <span class="stringliteral">"accounts"</span>)
00606                     {
00607                         query.prepare(<span class="stringliteral">"SELECT id FROM accounts"</span>);
00608                         query.exec();
00609                         
00610                         QRegExp regexp(<span class="stringliteral">"^(\\d+)"</span>);
00611                         <span class="keywordtype">int</span> pos = regexp.search(*it);
00612                         QString givenKey;
00613                         <span class="keywordflow">if</span>(pos &gt; -1)
00614                             givenKey = regexp.cap(1);
00615                         
00616                         <span class="keywordtype">bool</span> isNew = <span class="keyword">true</span>;
00617                         <span class="keywordflow">while</span>(query.next())
00618                         {
00619                             <span class="keywordflow">if</span>(givenKey == query.value(0).toString())
00620                                 isNew = <span class="keyword">false</span>;
00621                         }
00622                         
00623                         <span class="keywordflow">if</span>(!isNew)
00624                         {
00625                             QString existingKey;
00626                             
00627                             query.prepare(<span class="stringliteral">"SELECT key FROM accounts WHERE id = "</span> + givenKey);
00628                             query.exec();
00629                             <span class="keywordflow">if</span>(query.next())
00630                                 existingKey = query.value(0).toString();
00631                             
00632                             query.prepare(<span class="stringliteral">"INSERT OR REPLACE INTO accounts VALUES(\""</span> + existingKey +
00633                                     <span class="stringliteral">"\", \""</span> + *it + <span class="stringliteral">"\")"</span>);
00634                         }
00635                         <span class="keywordflow">else</span>
00636                         {
00637                             QString newKey;
00638                             newKey.setNum(key++);
00639                             query.prepare(<span class="stringliteral">"INSERT INTO accounts VALUES(\""</span> + newKey + <span class="stringliteral">"\", \""</span> + *it + <span class="stringliteral">"\")"</span>);
00640                         }
00641 
00642                         emit <a class="code" href="classDatabase.html#l0">accountsChanged</a>();
00643                     }
00644                     <span class="keywordflow">else</span>
00645                     {
00646                         QString newKey;
00647                         newKey.setNum(key++);
00648                         query.prepare(<span class="stringliteral">"INSERT INTO "</span> + table + <span class="stringliteral">" VALUES(\""</span> + newKey + <span class="stringliteral">"\", \""</span> + *it + <span class="stringliteral">"\")"</span>);
00649                     }
00650                     query.exec();
00651                 }
00652             }
00653         }
00654     }
00655 
00656     <span class="keywordflow">if</span>(table == <span class="stringliteral">"journalTmp"</span>)
00657         emit <a class="code" href="classDatabase.html#l1">journalTmpChanged</a>();
00658     
00659     origFile.close();
00660 }
00661 
<a name="l00662"></a><a class="code" href="classDatabase.html#a16">00662</a> QStringList <a class="code" href="classDatabase.html#a16">Database::getPeriodBegin</a>()<span class="keyword"> const</span>
00663 <span class="keyword"></span>{
00664     QStringList range;
00665     QString yearEnd;
00666     
00667     QDate date = QDate::currentDate();
00668     QString curYear = date.toString(<span class="stringliteral">"yy"</span>);
00669     
00670     QSqlQuery query(<span class="stringliteral">"SELECT yearEnd FROM main"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00671     <span class="keywordflow">if</span>(query.next())
00672         yearEnd = query.value(0).toString();
00673     
00674     <span class="keywordtype">int</span> startMonth = 0;
00675     
00676     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Jan"</span>))
00677         startMonth = 2;
00678     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Feb"</span>))
00679         startMonth = 3;
00680     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Mar"</span>))
00681         startMonth = 4;
00682     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Apr"</span>))
00683         startMonth = 5;
00684     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"May"</span>))
00685         startMonth = 6;
00686     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Jun"</span>))
00687         startMonth = 7;
00688     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Jul"</span>))
00689         startMonth = 8;
00690     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Aug"</span>))
00691         startMonth = 9;
00692     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Sep"</span>))
00693         startMonth = 10;
00694     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Oct"</span>))
00695         startMonth = 11;
00696     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Nov"</span>))
00697         startMonth = 12;
00698     <span class="keywordflow">if</span>(yearEnd.startsWith(<span class="stringliteral">"Dec"</span>))
00699         startMonth = 1;
00700     
00701     <span class="keywordflow">if</span>(startMonth &gt; date.month())
00702     {
00703         curYear.setNum(curYear.toInt() - 1);
00704         <span class="keywordflow">if</span>(curYear.toInt() &lt; 10)
00705             curYear.insert(0, <span class="stringliteral">"0"</span>);
00706     }
00707         
00708     <span class="keywordtype">int</span> period = 1;
00709     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = startMonth; i &lt;= 12; i++)
00710     {
00711         QString monthString;
00712         QString periodString;
00713         
00714         monthString.setNum(i);
00715         <span class="keywordflow">if</span>(i &lt; 10)
00716             monthString.insert(0, <span class="stringliteral">"0"</span>);
00717         
00718         range &lt;&lt; (<span class="stringliteral">"Period "</span> + periodString.setNum(period++) + <span class="stringliteral">" ("</span> + monthString + <span class="stringliteral">"/01/"</span> + curYear + <span class="stringliteral">")"</span>);
00719     }
00720     
00721     QString nextYear;
00722     nextYear.setNum(curYear.toInt() + 1);
00723     <span class="keywordflow">if</span>(nextYear.toInt() &lt; 10)
00724         nextYear.insert(0, <span class="stringliteral">"0"</span>);
00725     
00726     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt; startMonth; i++)
00727     {
00728         QString monthString;
00729         QString periodString;
00730 
00731         monthString.setNum(i);        
00732         <span class="keywordflow">if</span>(i &lt; 10)
00733             monthString.insert(0, <span class="stringliteral">"0"</span>);
00734         
00735         range &lt;&lt; (<span class="stringliteral">"Period "</span> + periodString.setNum(period++) + <span class="stringliteral">" ("</span> + monthString + <span class="stringliteral">"/01/"</span> + nextYear + <span class="stringliteral">")"</span>);
00736     }
00737     
00738     <span class="keywordflow">return</span> range;
00739 }
00740 
<a name="l00741"></a><a class="code" href="classDatabase.html#a17">00741</a> QStringList <a class="code" href="classDatabase.html#a17">Database::getPeriodEnd</a>()<span class="keyword"> const</span>
00742 <span class="keyword"></span>{
00743     QStringList periodEnd;
00744     QStringList periodBegin = <a class="code" href="classDatabase.html#a16">getPeriodBegin</a>();
00745     
00746     QDate date = QDate::currentDate();
00747     
00748     QRegExp regexp(<span class="stringliteral">"^(Period \\d+ \\()(\\d\\d)/\\d\\d/(\\d\\d)\\)"</span>);
00749     
00750     <span class="keywordflow">for</span>(QStringList::Iterator it = periodBegin.begin(); it != periodBegin.end(); ++it)
00751     {
00752         QString periodString;
00753         
00754         QString month;
00755         QString year;
00756         
00757         <span class="keywordflow">if</span>(regexp.search(*it) != -1)
00758         {
00759             periodString += regexp.cap(1);
00760             month = regexp.cap(2);
00761             year = regexp.cap(3);
00762             
00763             <span class="keywordflow">if</span>(month == <span class="stringliteral">"01"</span>)
00764                 periodString += <span class="stringliteral">"01/31/"</span> + year + <span class="stringliteral">")"</span>;
00765             <span class="keywordflow">if</span>(month == <span class="stringliteral">"02"</span>)
00766             {
00767                 QString testYear(<span class="stringliteral">"20"</span> + year);
00768                 <span class="keywordflow">if</span>(date.leapYear(testYear.toInt()))
00769                     periodString += <span class="stringliteral">"02/29/"</span> + year + <span class="stringliteral">")"</span>;
00770                 <span class="keywordflow">else</span>
00771                     periodString += <span class="stringliteral">"02/28/"</span> + year + <span class="stringliteral">")"</span>;
00772             }
00773             <span class="keywordflow">if</span>(month == <span class="stringliteral">"03"</span>)
00774                 periodString += <span class="stringliteral">"03/31/"</span> + year + <span class="stringliteral">")"</span>;
00775             <span class="keywordflow">if</span>(month == <span class="stringliteral">"04"</span>)
00776                 periodString += <span class="stringliteral">"04/30/"</span> + year + <span class="stringliteral">")"</span>;
00777             <span class="keywordflow">if</span>(month == <span class="stringliteral">"05"</span>)
00778                 periodString += <span class="stringliteral">"05/31/"</span> + year + <span class="stringliteral">")"</span>;
00779             <span class="keywordflow">if</span>(month == <span class="stringliteral">"06"</span>)
00780                 periodString += <span class="stringliteral">"06/30/"</span> + year + <span class="stringliteral">")"</span>;
00781             <span class="keywordflow">if</span>(month == <span class="stringliteral">"07"</span>)
00782                 periodString += <span class="stringliteral">"07/31/"</span> + year + <span class="stringliteral">")"</span>;
00783             <span class="keywordflow">if</span>(month == <span class="stringliteral">"08"</span>)
00784                 periodString += <span class="stringliteral">"08/31/"</span> + year + <span class="stringliteral">")"</span>;
00785             <span class="keywordflow">if</span>(month == <span class="stringliteral">"09"</span>)
00786                 periodString += <span class="stringliteral">"09/30/"</span> + year + <span class="stringliteral">")"</span>;
00787             <span class="keywordflow">if</span>(month == <span class="stringliteral">"10"</span>)
00788                 periodString += <span class="stringliteral">"10/31/"</span> + year + <span class="stringliteral">")"</span>;
00789             <span class="keywordflow">if</span>(month == <span class="stringliteral">"11"</span>)
00790                 periodString += <span class="stringliteral">"11/30/"</span> + year + <span class="stringliteral">")"</span>;
00791             <span class="keywordflow">if</span>(month == <span class="stringliteral">"12"</span>)
00792                 periodString += <span class="stringliteral">"12/31/"</span> + year + <span class="stringliteral">")"</span>;
00793         }
00794         
00795         periodEnd &lt;&lt; periodString;
00796     }
00797     
00798     <span class="keywordflow">return</span> periodEnd;
00799 }
00800 
<a name="l00801"></a><a class="code" href="classDatabase.html#a18">00801</a> QPtrList&lt;EditorElement&gt; <a class="code" href="classDatabase.html#a18">Database::getElements</a>(editorCategories category)
00802 {
00803     QPtrList&lt;EditorElement&gt; tmpList;
00804 
00805     <span class="keywordflow">if</span>(!<a class="code" href="classDatabase.html#r2">connection</a>-&gt;open())
00806     {
00807         <a class="code" href="classDatabase.html#r2">connection</a>-&gt;lastError().showMessage();
00808         <span class="keywordflow">return</span> tmpList;
00809     }
00810     
00811     QString table;
00812     <span class="keywordflow">switch</span>(category)
00813     {
00814         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w0">balanceAssets</a>:
00815             table = <span class="stringliteral">"balanceAssets"</span>;
00816             <span class="keywordflow">break</span>;
00817         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w1">balanceLiabilities</a>:
00818             table = <span class="stringliteral">"balanceLiabilities"</span>;
00819             <span class="keywordflow">break</span>;
00820         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w2">balanceEquities</a>:
00821             table = <span class="stringliteral">"balanceEquities"</span>;
00822             <span class="keywordflow">break</span>;
00823         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w3">incomeSvcIncome</a>:
00824             table = <span class="stringliteral">"incomeSvcIncome"</span>;
00825             <span class="keywordflow">break</span>;
00826         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w4">incomeSvcExpenses</a>:
00827             table = <span class="stringliteral">"incomeSvcExpenses"</span>;
00828             <span class="keywordflow">break</span>;
00829         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w5">incomeRetailIncome</a>:
00830             table = <span class="stringliteral">"incomeRetailIncome"</span>;
00831             <span class="keywordflow">break</span>;
00832         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w6">incomeRetailCOS</a>:
00833             table = <span class="stringliteral">"incomeRetailCOS"</span>;
00834             <span class="keywordflow">break</span>;
00835         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w7">incomeRetailExpenses</a>:
00836             table = <span class="stringliteral">"incomeRetailExpenses"</span>;
00837             <span class="keywordflow">break</span>;
00838     }
00839 
00840     QSqlQuery query(<span class="stringliteral">"SELECT * FROM "</span> + table + <span class="stringliteral">" ORDER BY key"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00841     
00842     <span class="keywordflow">while</span>(query.next())
00843     {
00844         <a class="code" href="classEditorElement.html">EditorElement</a> *element = <span class="keyword">new</span> <a class="code" href="classEditorElement.html">EditorElement</a>(
00845                 category,
00846                 query.value(0).toString(),
00847                 query.value(1).toString(),
00848                 query.value(2).toString(),
00849                 query.value(3).toString(),
00850                 query.value(4).toString());
00851         tmpList.append(element);
00852     }
00853     <span class="keywordflow">return</span> tmpList;
00854 }
00855 
<a name="l00856"></a><a class="code" href="classDatabase.html#a19">00856</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a19">Database::createElement</a>(editorCategories category, QString type,
00857                              QString desc, QString accountBegin, QString accountEnd)
00858 {
00859     <span class="keywordflow">if</span>(!<a class="code" href="classDatabase.html#r2">connection</a>-&gt;open())
00860     {
00861         <a class="code" href="classDatabase.html#r2">connection</a>-&gt;lastError().showMessage();
00862         <span class="keywordflow">return</span>;
00863     }
00864     
00865     QString table;
00866     <span class="keywordflow">switch</span>(category)
00867     {
00868         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w0">balanceAssets</a>:
00869             table = <span class="stringliteral">"balanceAssets"</span>;
00870             <span class="keywordflow">break</span>;
00871         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w1">balanceLiabilities</a>:
00872             table = <span class="stringliteral">"balanceLiabilities"</span>;
00873             <span class="keywordflow">break</span>;
00874         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w2">balanceEquities</a>:
00875             table = <span class="stringliteral">"balanceEquities"</span>;
00876             <span class="keywordflow">break</span>;
00877         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w3">incomeSvcIncome</a>:
00878             table = <span class="stringliteral">"incomeSvcIncome"</span>;
00879             <span class="keywordflow">break</span>;
00880         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w4">incomeSvcExpenses</a>:
00881             table = <span class="stringliteral">"incomeSvcExpenses"</span>;
00882             <span class="keywordflow">break</span>;
00883         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w5">incomeRetailIncome</a>:
00884             table = <span class="stringliteral">"incomeRetailIncome"</span>;
00885             <span class="keywordflow">break</span>;
00886         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w6">incomeRetailCOS</a>:
00887             table = <span class="stringliteral">"incomeRetailCOS"</span>;
00888             <span class="keywordflow">break</span>;
00889         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w7">incomeRetailExpenses</a>:
00890             table = <span class="stringliteral">"incomeRetailExpenses"</span>;
00891             <span class="keywordflow">break</span>;
00892     }
00893     
00894     QSqlQuery queryLast(<span class="stringliteral">"SELECT key FROM "</span> + table + <span class="stringliteral">" ORDER BY key"</span>);
00895     
00896     QString oneUp;
00897     <span class="keywordflow">if</span>(queryLast.last())
00898         oneUp.setNum(queryLast.value(0).toInt() + 1);
00899     <span class="keywordflow">else</span>
00900         oneUp.setNum(1);
00901     
00902     <span class="keywordflow">if</span>(type == <span class="stringliteral">"0"</span>)
00903     {
00904         QSqlQuery queryDesc(<span class="stringliteral">"SELECT desc FROM accounts WHERE id = \""</span> + accountBegin + <span class="stringliteral">"\""</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00905         <span class="keywordflow">if</span>(queryDesc.next())
00906             desc = queryDesc.value(0).toString();
00907     }
00908     
00909     QSqlQuery queryInsert(<span class="stringliteral">"INSERT INTO "</span> + table + <span class="stringliteral">" VALUES( \""</span> + oneUp + <span class="stringliteral">"\", \""</span> +
00910             type + <span class="stringliteral">"\", \""</span> + desc + <span class="stringliteral">"\", \""</span> + accountBegin + <span class="stringliteral">"\", \""</span> + accountEnd + <span class="stringliteral">"\")"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
00911 }
00912 
<a name="l00913"></a><a class="code" href="classDatabase.html#a20">00913</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a20">Database::removeElement</a>(editorCategories category, QString key)
00914 {
00915     <span class="keywordflow">if</span>(!<a class="code" href="classDatabase.html#r2">connection</a>-&gt;open())
00916     {
00917         <a class="code" href="classDatabase.html#r2">connection</a>-&gt;lastError().showMessage();
00918         <span class="keywordflow">return</span>;
00919     }
00920     
00921     QString table;
00922     <span class="keywordflow">switch</span>(category)
00923     {
00924         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w0">balanceAssets</a>:
00925             table = <span class="stringliteral">"balanceAssets"</span>;
00926             <span class="keywordflow">break</span>;
00927         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w1">balanceLiabilities</a>:
00928             table = <span class="stringliteral">"balanceLiabilities"</span>;
00929             <span class="keywordflow">break</span>;
00930         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w2">balanceEquities</a>:
00931             table = <span class="stringliteral">"balanceEquities"</span>;
00932             <span class="keywordflow">break</span>;
00933         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w3">incomeSvcIncome</a>:
00934             table = <span class="stringliteral">"incomeSvcIncome"</span>;
00935             <span class="keywordflow">break</span>;
00936         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w4">incomeSvcExpenses</a>:
00937             table = <span class="stringliteral">"incomeSvcExpenses"</span>;
00938             <span class="keywordflow">break</span>;
00939         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w5">incomeRetailIncome</a>:
00940             table = <span class="stringliteral">"incomeRetailIncome"</span>;
00941             <span class="keywordflow">break</span>;
00942         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w6">incomeRetailCOS</a>:
00943             table = <span class="stringliteral">"incomeRetailCOS"</span>;
00944             <span class="keywordflow">break</span>;
00945         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w7">incomeRetailExpenses</a>:
00946             table = <span class="stringliteral">"incomeRetailExpenses"</span>;
00947             <span class="keywordflow">break</span>;
00948     }
00949 
00950     QSqlQuery query(<span class="stringliteral">"DELETE FROM "</span> + table + <span class="stringliteral">" WHERE key = "</span> + key, <a class="code" href="classDatabase.html#r2">connection</a>);
00951 }
00952 
<a name="l00953"></a><a class="code" href="classDatabase.html#a21">00953</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a21">Database::moveElement</a>(editorCategories category, QString key, <span class="keywordtype">bool</span> up)
00954 {
00955     <span class="keywordflow">if</span>(key == <span class="stringliteral">"1"</span> &amp;&amp; up) <span class="keywordflow">return</span>;
00956     
00957     <span class="keywordflow">if</span>(!<a class="code" href="classDatabase.html#r2">connection</a>-&gt;open())
00958     {
00959         <a class="code" href="classDatabase.html#r2">connection</a>-&gt;lastError().showMessage();
00960         <span class="keywordflow">return</span>;
00961     }
00962     
00963     QString oneUp;
00964     oneUp.setNum(key.toInt() - 1);
00965     QString oneDown;
00966     oneDown.setNum(key.toInt() + 1);
00967 
00968     QString queryLastString(<span class="stringliteral">"SELECT key FROM "</span>);
00969     QString queryUpdateString(<span class="stringliteral">"UPDATE "</span>);
00970     
00971     QString table;
00972     <span class="keywordflow">switch</span>(category)
00973     {
00974         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w0">balanceAssets</a>:
00975             table = <span class="stringliteral">"balanceAssets"</span>;
00976             <span class="keywordflow">break</span>;
00977         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w1">balanceLiabilities</a>:
00978             table = <span class="stringliteral">"balanceLiabilities"</span>;
00979             <span class="keywordflow">break</span>;
00980         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w2">balanceEquities</a>:
00981             table = <span class="stringliteral">"balanceEquities"</span>;
00982             <span class="keywordflow">break</span>;
00983         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w3">incomeSvcIncome</a>:
00984             table = <span class="stringliteral">"incomeSvcIncome"</span>;
00985             <span class="keywordflow">break</span>;
00986         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w4">incomeSvcExpenses</a>:
00987             table = <span class="stringliteral">"incomeSvcExpenses"</span>;
00988             <span class="keywordflow">break</span>;
00989         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w5">incomeRetailIncome</a>:
00990             table = <span class="stringliteral">"incomeRetailIncome"</span>;
00991             <span class="keywordflow">break</span>;
00992         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w6">incomeRetailCOS</a>:
00993             table = <span class="stringliteral">"incomeRetailCOS"</span>;
00994             <span class="keywordflow">break</span>;
00995         <span class="keywordflow">case</span> <a class="code" href="classDatabase.html#w8w7">incomeRetailExpenses</a>:
00996             table = <span class="stringliteral">"incomeRetailExpenses"</span>;
00997             <span class="keywordflow">break</span>;
00998     }
00999 
01000     queryLastString += table + <span class="stringliteral">" ORDER BY key"</span>;
01001     QSqlQuery queryLast(queryLastString, <a class="code" href="classDatabase.html#r2">connection</a>);
01002     queryLast.last();
01003     <span class="keywordflow">if</span>(queryLast.value(0).toString() == key &amp;&amp; !up) <span class="keywordflow">return</span>;
01004     
01005     queryUpdateString += table + <span class="stringliteral">" SET key = "</span>;
01006     
01007     QString upOrDown;
01008     <span class="keywordflow">if</span>(up)
01009         upOrDown = oneUp;
01010     <span class="keywordflow">else</span>
01011         upOrDown = oneDown;
01012     queryUpdateString += <span class="stringliteral">"0 WHERE key = "</span>;
01013     queryUpdateString += key;
01014 
01015     QSqlQuery queryUpdate(queryUpdateString, <a class="code" href="classDatabase.html#r2">connection</a>);
01016     
01017     QSqlQuery queryUpdate2(<span class="stringliteral">"UPDATE "</span> + table + <span class="stringliteral">" SET key = "</span> + key + <span class="stringliteral">" WHERE key = "</span> + upOrDown, <a class="code" href="classDatabase.html#r2">connection</a>);
01018     QSqlQuery queryUpdate3(<span class="stringliteral">"UPDATE "</span> + table + <span class="stringliteral">" SET key = "</span> + upOrDown + <span class="stringliteral">" WHERE key = 0"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
01019 }
01020 
<a name="l01021"></a><a class="code" href="classDatabase.html#a22">01021</a> <a class="code" href="classDatabase.html">Database</a>* <a class="code" href="classDatabase.html#a22">Database::getGeneralDetail</a>(QString periodBegin, QString periodEnd,
01022                                      QString accountBegin, QString accountEnd)
01023 {
01024     QPtrList&lt;QStringList&gt; accounts;
01025     
01026     <span class="keywordtype">bool</span> allAccounts = <span class="keyword">false</span>;
01027     <span class="keywordflow">if</span>(accountBegin == <span class="stringliteral">""</span> &amp;&amp; accountEnd == <span class="stringliteral">""</span>)
01028         allAccounts = <span class="keyword">true</span>;
01029     
01030     QSqlQuery query(<a class="code" href="classDatabase.html#r2">connection</a>);
01031     <span class="keywordflow">if</span>(allAccounts)
01032         query.prepare(<span class="stringliteral">"SELECT * FROM accounts ORDER BY id"</span>);
01033     <span class="keywordflow">else</span>
01034         query.prepare(<span class="stringliteral">"SELECT * FROM accounts WHERE id &gt;= "</span> + accountBegin
01035                       + <span class="stringliteral">" AND id &lt;= "</span> + accountEnd + <span class="stringliteral">" ORDER BY id"</span>);
01036     query.exec();
01037 
01038     <span class="keywordflow">while</span>(query.next())
01039     {
01040         QStringList* <a class="code" href="classDatabase.html#r7">accountsList</a> = <span class="keyword">new</span> QStringList;
01041         *accountsList &lt;&lt; query.value(1).toString() &lt;&lt; query.value(2).toString();
01042         accounts.append(accountsList);
01043     }
01044     
01045     QRegExp dateRegexp(<span class="stringliteral">"Period \\d+ \\((\\d\\d)/(\\d\\d)/(\\d\\d)\\)"</span>);
01046     
01047     dateRegexp.search(periodBegin);
01048     QDate periodBeginDate(dateRegexp.cap(3).insert(0,<span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), dateRegexp.cap(2).toInt());
01049     
01050     dateRegexp.search(periodEnd);
01051     QDate periodEndDate(dateRegexp.cap(3).insert(0,<span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), dateRegexp.cap(2).toInt());
01052     
01053     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> = <span class="stringliteral">"Account ID,Account Description,Date,Reference,Description,Debit Amt,Credit Amt,Balance\n"</span>;
01054     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> = <span class="stringliteral">"&lt;center&gt;&lt;h1&gt;"</span>;
01055     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <a class="code" href="classDatabase.html#r3">curClient</a>;
01056     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;/h1&gt;&lt;/center&gt;\n"</span>;
01057     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h2&gt;General Ledger Detail&lt;/h2&gt;&lt;/center&gt;\n"</span>;
01058     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h3&gt;For the Period From "</span> + periodBeginDate.toString(<span class="stringliteral">"MMM d, yyyy"</span>)
01059             + <span class="stringliteral">" to "</span> + periodEndDate.toString(<span class="stringliteral">"MMM d, yyyy"</span>) + <span class="stringliteral">"&lt;/h3&gt;&lt;/center&gt;\n"</span>;
01060     
01061     <span class="keywordflow">if</span>(allAccounts)
01062         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h4&gt;All Accounts&lt;/h4&gt;&lt;/center&gt;\n"</span>;
01063     <span class="keywordflow">else</span>
01064         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h4&gt;Account Range: "</span> + accountBegin + <span class="stringliteral">" to "</span> + accountEnd + <span class="stringliteral">"&lt;/h4&gt;&lt;/center&gt;\n"</span>;
01065     
01066     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;table width=\"100%\"&gt;&lt;tr&gt;"</span>
01067             <span class="stringliteral">"&lt;td width=\"19%\"&gt;&lt;b&gt;Account ID&lt;br&gt;Account Description&lt;/b&gt;&lt;/td&gt;"</span>
01068             <span class="stringliteral">"&lt;td width=\"10%\"&gt;&lt;b&gt;Date&lt;/b&gt;&lt;/td&gt;"</span>
01069             <span class="stringliteral">"&lt;td width=\"10%\"&gt;&lt;b&gt;Reference&lt;/b&gt;&lt;/td&gt;"</span>
01070             <span class="stringliteral">"&lt;td width=\"31%\"&gt;&lt;b&gt;Description&lt;/b&gt;&lt;/td&gt;"</span>
01071             <span class="stringliteral">"&lt;td align=\"right\" width=\"10%\"&gt;&lt;b&gt;Debit Amt&lt;/b&gt;&lt;/td&gt;"</span>
01072             <span class="stringliteral">"&lt;td align=\"right\" width=\"10%\"&gt;&lt;b&gt;Credit Amt&lt;/b&gt;&lt;/td&gt;"</span>
01073             <span class="stringliteral">"&lt;td align=\"right\" width=\"10%\"&gt;&lt;b&gt;Balance&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;"</span>;
01074 
01075     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> = <span class="stringliteral">"&lt;table width=\"100%\"&gt;"</span>;
01076     
01077     QString beginningBalance;
01078     QString periodChangeBalance;
01079     QString endingBalance;
01080     QString debitBalance;
01081     QString creditBalance;
01082     
01083     QString entryYear;
01084     QString entryMonth;
01085     QString entryDay;
01086     QDate entryDate;
01087     
01088     <span class="keywordtype">bool</span> inDateRange;
01089     
01090     QDate curDate = QDate::currentDate();
01091     
01092     <span class="keywordflow">for</span>(QPtrList&lt;QStringList&gt;::Iterator it = accounts.begin(); it != accounts.end(); ++it)
01093     {
01094         query.prepare(<span class="stringliteral">"SELECT date, reference, desc, debit, credit FROM journal WHERE account = "</span> + (**it)[1]);
01095         query.exec();
01096         
01097         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"19%\"&gt;"</span> + (**it)[0] + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"10%\"&gt;"</span>
01098                 + periodBeginDate.toString(<span class="stringliteral">"MM/dd/yy"</span>) +
01099                 <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"10%\"&gt; &lt;/td&gt;&lt;td width=\"31%\"&gt;Beginning Balance&lt;/td&gt;&lt;td width=\"10%\"&gt; &lt;/td&gt;"</span>
01100                 <span class="stringliteral">"&lt;td width=\"10%\"&gt; &lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;(BALANCE)&lt;/td&gt;&lt;/tr&gt;"</span>;
01101         
01102         <span class="keywordtype">bool</span> accountDescDisplayed = <span class="keyword">false</span>;
01103         
01104         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += (**it)[0] + <span class="stringliteral">","</span> + (**it)[1] + <span class="stringliteral">","</span> + periodBeginDate.toString(<span class="stringliteral">"MM/dd/yy"</span>) +
01105                 <span class="stringliteral">",,Beginning Balance,,,(BALANCE)\n"</span>;
01106         
01107         beginningBalance = <span class="stringliteral">"0.00"</span>;
01108         periodChangeBalance = <span class="stringliteral">"0.00"</span>;
01109         endingBalance = <span class="stringliteral">"0.00"</span>;
01110         debitBalance = <span class="stringliteral">"0.00"</span>;
01111         creditBalance = <span class="stringliteral">"0.00"</span>;
01112         
01113         <span class="keywordflow">if</span>(query.first())
01114         {
01115             query.seek(-1);
01116             
01117             inDateRange = <span class="keyword">false</span>;
01118             
01119             <span class="keywordflow">while</span>(query.next())
01120             {
01121                 QString entryYear = query.value(0).toString().right(2);
01122                     
01123                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01124                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
01125                 <span class="keywordflow">else</span>
01126                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
01127                 
01128                 QString entryMonth = query.value(0).toString().left(2);
01129                 QString entryDay = query.value(0).toString().mid(3,2);
01130                 
01131                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01132                 
01133                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate &amp;&amp; entryDate &lt;= periodEndDate)
01134                 {
01135                     inDateRange = <span class="keyword">true</span>;
01136                     
01137                     <span class="keywordflow">if</span>(!accountDescDisplayed)
01138                     {
01139                         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"19%\"&gt;"</span> + (**it)[1] + <span class="stringliteral">"&lt;/td&gt;"</span>;
01140                         accountDescDisplayed = <span class="keyword">true</span>;
01141                     }
01142                     <span class="keywordflow">else</span>
01143                         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"19%\"&gt; &lt;/td&gt;"</span>;
01144                     
01145                     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;td width=\"10%\"&gt;"</span> + query.value(0).toString() + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"10%\"&gt;"</span>
01146                             + query.value(1).toString() + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"31%\"&gt;"</span>
01147                             + query.value(2).toString() + <span class="stringliteral">"&lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;"</span>
01148                             + <a class="code" href="classDatabase.html#a48">addCommas</a>(query.value(3).toString()) + <span class="stringliteral">"&lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;"</span>
01149                             + <a class="code" href="classDatabase.html#a48">addCommas</a>(query.value(4).toString()) + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"10%\"&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01150                     
01151                     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += (**it)[0] + <span class="stringliteral">","</span> + (**it)[1] + <span class="stringliteral">","</span>
01152                             + query.value(0).toString() + <span class="stringliteral">","</span> + query.value(1).toString()
01153                             + <span class="stringliteral">","</span> + query.value(2).toString() + <span class="stringliteral">","</span> + query.value(3).toString()
01154                             + <span class="stringliteral">","</span> + query.value(4).toString() + <span class="stringliteral">",\n"</span>;
01155                     
01156                     debitBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(debitBalance, query.value(3).toString());
01157                     creditBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(creditBalance, query.value(4).toString());
01158                     
01159                     periodChangeBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(debitBalance, QString(creditBalance).insert(0,<span class="stringliteral">"-"</span>));
01160             
01161                 }
01162                 <span class="keywordflow">if</span>(entryDate &lt; periodBeginDate)
01163                 {
01164                     beginningBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(beginningBalance, query.value(3).toString());
01165                     beginningBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(beginningBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(4).toString()));
01166                 }
01167             }
01168             
01169             <span class="keywordflow">if</span>(inDateRange)
01170             {   
01171                 <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"19%\"&gt; &lt;/td&gt;&lt;td width=\"10%\"&gt; &lt;/td&gt;&lt;td width=\"10%\"&gt; &lt;/td&gt;"</span>
01172                         <span class="stringliteral">"&lt;td width=\"31%\"&gt;Current Period Change&lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;"</span>
01173                         + <a class="code" href="classDatabase.html#a48">addCommas</a>(debitBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;"</span>
01174                         + <a class="code" href="classDatabase.html#a48">addCommas</a>(creditBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;"</span>
01175                         + <a class="code" href="classDatabase.html#a48">addCommas</a>(periodChangeBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01176                 
01177                 <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">",,,Current Period Change,"</span> + debitBalance + <span class="stringliteral">","</span> + creditBalance
01178                         + <span class="stringliteral">","</span> + periodChangeBalance + <span class="stringliteral">"\n"</span>;
01179             }
01180         }
01181         <span class="keywordflow">else</span>
01182         {
01183             <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"19%\"&gt;"</span> + (**it)[1] + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01184             accountDescDisplayed = <span class="keyword">true</span>;
01185         }
01186         
01187         <span class="keywordflow">if</span>(!accountDescDisplayed)
01188             <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"19%\"&gt;"</span> + (**it)[1] + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;"</span>;
01189         
01190         <span class="keywordflow">if</span>(beginningBalance == <span class="stringliteral">"0.00"</span> &amp;&amp; debitBalance == <span class="stringliteral">"0.00"</span> &amp;&amp; creditBalance == <span class="stringliteral">"0.00"</span>)
01191             endingBalance = <span class="stringliteral">""</span>;
01192         <span class="keywordflow">else</span>
01193             endingBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(beginningBalance, periodChangeBalance);
01194         
01195         <span class="keywordflow">if</span>(beginningBalance == <span class="stringliteral">"0.00"</span>)
01196             beginningBalance = <span class="stringliteral">""</span>;
01197         
01198         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> = (<a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a>).replace(<span class="stringliteral">"(BALANCE)"</span>, <a class="code" href="classDatabase.html#a48">addCommas</a>(beginningBalance));
01199         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> = (<a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a>).replace(<span class="stringliteral">"(BALANCE)"</span>, beginningBalance);
01200         
01201         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"19%\"&gt; &lt;/td&gt;&lt;td width=\"10%\"&gt;&lt;b&gt;"</span>
01202                 + periodEndDate.toString(<span class="stringliteral">"MM/dd/yy"</span>) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;"</span>
01203                 <span class="stringliteral">"&lt;td width=\"10%\"&gt; &lt;/td&gt;&lt;td width=\"31%\"&gt;&lt;b&gt;Ending Balance&lt;/b&gt;&lt;/td&gt;"</span>
01204                 <span class="stringliteral">"&lt;td width=\"10%\"&gt; &lt;/td&gt;&lt;td width=\"10%\"&gt; &lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;&lt;b&gt;"</span>
01205                 + <a class="code" href="classDatabase.html#a48">addCommas</a>(endingBalance) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01206         
01207         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">","</span> + periodEndDate.toString(<span class="stringliteral">"MM/dd/yy"</span>) + <span class="stringliteral">",,Ending Balance,,,"</span>
01208                 + endingBalance + <span class="stringliteral">"\n"</span>;
01209 
01210         <span class="keyword">delete</span> *it;
01211         
01212     }
01213 
01214     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;/table&gt;"</span>;
01215     
01216     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a> = <span class="stringliteral">"&lt;qt&gt;"</span> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> + <span class="stringliteral">"&lt;/qt&gt;"</span>;
01217     
01218     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o4">html</a> = <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a>.replace(
01219             <span class="stringliteral">"&lt;qt&gt;"</span>, <span class="stringliteral">"&lt;html&gt;&lt;head&gt;&lt;title&gt;"</span> + <a class="code" href="classDatabase.html#r3">curClient</a> +
01220             <span class="stringliteral">" - General Ledger Detail&lt;/title&gt;&lt;/head&gt;&lt;body&gt;\n"</span>).replace(
01221                     <span class="stringliteral">"&lt;/qt&gt;"</span>, <span class="stringliteral">"&lt;/body&gt;&lt;/html&gt;"</span>);
01222     
01223     <span class="keywordflow">return</span> <span class="keyword">this</span>;
01224 }
01225 
<a name="l01226"></a><a class="code" href="classDatabase.html#a23">01226</a> <a class="code" href="classDatabase.html">Database</a>* <a class="code" href="classDatabase.html#a23">Database::getGeneralTrialBalance</a>(QString periodEnd, QString accountBegin, QString accountEnd)
01227 {
01228     QPtrList&lt;QStringList&gt; accounts;
01229     
01230     <span class="keywordtype">bool</span> allAccounts = <span class="keyword">false</span>;
01231     <span class="keywordflow">if</span>(accountBegin == <span class="stringliteral">""</span> &amp;&amp; accountEnd == <span class="stringliteral">""</span>)
01232         allAccounts = <span class="keyword">true</span>;
01233    
01234     QSqlQuery query(<a class="code" href="classDatabase.html#r2">connection</a>);
01235     <span class="keywordflow">if</span>(allAccounts)
01236         query.prepare(<span class="stringliteral">"SELECT * FROM accounts ORDER BY id"</span>);
01237     <span class="keywordflow">else</span>
01238         query.prepare(<span class="stringliteral">"SELECT * FROM accounts WHERE id &gt;= "</span> + accountBegin
01239                       + <span class="stringliteral">" AND id &lt;= "</span> + accountEnd + <span class="stringliteral">" ORDER BY id"</span>);
01240     query.exec();
01241 
01242     <span class="keywordflow">while</span>(query.next())
01243     {
01244         QStringList* <a class="code" href="classDatabase.html#r7">accountsList</a> = <span class="keyword">new</span> QStringList;
01245         *accountsList &lt;&lt; query.value(1).toString() &lt;&lt; query.value(2).toString();
01246         accounts.append(accountsList);
01247     }
01248     
01249     QDate curDate = QDate::currentDate();
01250     
01251     QRegExp dateRegexp(<span class="stringliteral">"Period \\d+ \\((\\d\\d)/(\\d\\d)/(\\d\\d)\\)"</span>);
01252     dateRegexp.search(periodEnd);
01253     
01254     QDate periodDate(dateRegexp.cap(3).insert(0,<span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), dateRegexp.cap(2).toInt());
01255     
01256     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> = <span class="stringliteral">"Account ID,Account Description,Debit Amt,Credit Amt\n"</span>;
01257     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> = <span class="stringliteral">"&lt;center&gt;&lt;h1&gt;"</span>;
01258     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <a class="code" href="classDatabase.html#r3">curClient</a>;
01259     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;/h1&gt;&lt;/center&gt;\n"</span>;
01260     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h2&gt;General Ledger Trial Balance&lt;/h2&gt;&lt;/center&gt;\n"</span>;
01261     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h3&gt;As of "</span> + periodDate.toString(<span class="stringliteral">"MMM d, yyyy"</span>) + <span class="stringliteral">"&lt;/h3&gt;&lt;/center&gt;\n"</span>;
01262     
01263     <span class="keywordflow">if</span>(allAccounts)
01264         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h4&gt;All Accounts&lt;/h4&gt;&lt;/center&gt;\n"</span>;
01265     <span class="keywordflow">else</span>
01266         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h4&gt;Account Range: "</span> + accountBegin + <span class="stringliteral">" to "</span> + accountEnd + <span class="stringliteral">"&lt;/h4&gt;&lt;/center&gt;\n"</span>;
01267     
01268     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;table width=\"100%\"&gt;&lt;tr&gt;&lt;td width=\"19%\"&gt;&lt;b&gt;Account ID&lt;/b&gt;&lt;/td&gt;"</span>
01269             <span class="stringliteral">"&lt;td width=\"31%\"&gt;&lt;b&gt;Account Description&lt;/b&gt;&lt;/td&gt;"</span>
01270             <span class="stringliteral">"&lt;td align=\"right\" width=\"10%\"&gt;&lt;b&gt;Debit Amt&lt;/b&gt;&lt;/td&gt;"</span>
01271             <span class="stringliteral">"&lt;td align=\"right\" width=\"10%\"&gt;&lt;b&gt;Credit Amt&lt;/b&gt;&lt;/td&gt;&lt;td width=\"30%\"&gt; &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;"</span>;
01272 
01273     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> = <span class="stringliteral">"&lt;table width=\"100%\"&gt;"</span>;
01274     
01275     QString debit = <span class="stringliteral">"0.00"</span>;
01276     QString credit = <span class="stringliteral">"0.00"</span>;
01277     QString totalDebit = <span class="stringliteral">"0.00"</span>;
01278     QString totalCredit = <span class="stringliteral">"0.00"</span>;
01279     
01280     QString entryYear;
01281     QString entryMonth;
01282     QString entryDay;
01283     QDate entryDate;
01284     
01285     <span class="keywordflow">for</span>(QPtrList&lt;QStringList&gt;::Iterator it = accounts.begin(); it != accounts.end(); ++it)
01286     {
01287         query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + (**it)[0]);
01288         query.exec();
01289         
01290         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"19%\"&gt;"</span> + (**it)[0] + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"31%\"&gt;"</span> + (**it)[1]
01291                 + <span class="stringliteral">"&lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;"</span>;
01292         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += (**it)[0] + <span class="stringliteral">","</span> + (**it)[1] + <span class="stringliteral">","</span>;
01293         
01294         <span class="keywordflow">if</span>(query.first())
01295         {
01296             debit = <span class="stringliteral">"0.00"</span>;
01297             credit = <span class="stringliteral">"0.00"</span>;
01298             
01299             query.seek(-1);
01300             <span class="keywordflow">while</span>(query.next())
01301             {
01302                 QString entryYear = query.value(0).toString().right(2);
01303                 
01304                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01305                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
01306                 <span class="keywordflow">else</span>
01307                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
01308                 
01309                 QString entryMonth = query.value(0).toString().left(2);
01310                 QString entryDay = query.value(0).toString().mid(3,2);
01311                 
01312                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01313                 <span class="keywordflow">if</span>(entryDate &gt; periodDate)
01314                     <span class="keywordflow">continue</span>;
01315                 
01316                 debit = <a class="code" href="classDatabase.html#a46">addCurrency</a>(debit, query.value(1).toString());
01317                 credit = <a class="code" href="classDatabase.html#a46">addCurrency</a>(credit, query.value(2).toString());
01318             }
01319             
01320             totalDebit = <a class="code" href="classDatabase.html#a46">addCurrency</a>(totalDebit, debit);
01321             totalCredit = <a class="code" href="classDatabase.html#a46">addCurrency</a>(totalCredit, credit);
01322             
01323             <span class="keywordflow">if</span>(debit != <span class="stringliteral">"0.00"</span>)
01324                 <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <a class="code" href="classDatabase.html#a48">addCommas</a>(debit);
01325             <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;"</span>;
01326             <span class="keywordflow">if</span>(credit != <span class="stringliteral">"0.00"</span>)
01327                 <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <a class="code" href="classDatabase.html#a48">addCommas</a>(credit);
01328             <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"30%\"&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01329             
01330             <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += debit + <span class="stringliteral">","</span> + credit + <span class="stringliteral">"\n"</span>;
01331         }
01332         <span class="keywordflow">else</span>
01333         {
01334             <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"10%\"&gt; &lt;/td&gt;&lt;td width=\"30%\"&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01335             <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">",\n"</span>;
01336         }
01337 
01338         <span class="keyword">delete</span> *it;
01339     }
01340     
01341     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;td&gt; &lt;/td&gt;&lt;td&gt; &lt;/td&gt;&lt;td&gt; &lt;/td&gt;"</span>
01342             <span class="stringliteral">"&lt;/tr&gt;&lt;tr&gt;&lt;td width=\"19%\"&gt; &lt;/td&gt;&lt;td width=\"31%\"&gt;&lt;b&gt;Total:&lt;/b&gt;&lt;/td&gt;"</span>
01343             <span class="stringliteral">"&lt;td align=\"right\" width=\"10%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a48">addCommas</a>(totalDebit)
01344             + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;td align=\"right\" width=\"10%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a48">addCommas</a>(totalCredit) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;"</span>
01345             <span class="stringliteral">"&lt;td width=\"30%\"&gt; &lt;/td&gt;&lt;/tr&gt;\n&lt;/table&gt;"</span>;
01346 
01347     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">",,,,,Total:,"</span> + totalDebit + <span class="stringliteral">","</span> + totalCredit + <span class="stringliteral">",\n"</span>;
01348     
01349     
01350     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a> = <span class="stringliteral">"&lt;qt&gt;"</span> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> + <span class="stringliteral">"&lt;/qt&gt;"</span>;
01351     
01352     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o4">html</a> = <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a>.replace(
01353             <span class="stringliteral">"&lt;qt&gt;"</span>, <span class="stringliteral">"&lt;html&gt;&lt;head&gt;&lt;title&gt;"</span> + <a class="code" href="classDatabase.html#r3">curClient</a> +
01354             <span class="stringliteral">" - General Ledger Trial Balance&lt;/title&gt;&lt;/head&gt;&lt;body&gt;\n"</span>).replace(
01355             <span class="stringliteral">"&lt;/qt&gt;"</span>, <span class="stringliteral">"&lt;/body&gt;&lt;/html&gt;"</span>);
01356     
01357     <span class="keywordflow">return</span> <span class="keyword">this</span>;
01358 }
01359 
<a name="l01360"></a><a class="code" href="classDatabase.html#a24">01360</a> <a class="code" href="classDatabase.html">Database</a>* <a class="code" href="classDatabase.html#a24">Database::getBalanceReport</a>(QString periodEnd)
01361 {
01362 
01363     QRegExp dateRegexp(<span class="stringliteral">"Period \\d+ \\((\\d\\d)/(\\d\\d)/(\\d\\d)\\)"</span>);
01364     dateRegexp.search(periodEnd);
01365     
01366     QDate curDate = QDate::currentDate();
01367     QDate periodDate(dateRegexp.cap(3).insert(0,<span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), dateRegexp.cap(2).toInt());
01368     QString entryYear;
01369     QString entryMonth;
01370     QString entryDay;
01371     QDate entryDate;
01372 
01373     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> = <span class="stringliteral">"Account Description,Balance\n"</span>;
01374     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> = <span class="stringliteral">"&lt;center&gt;&lt;h1&gt;"</span>;
01375     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <a class="code" href="classDatabase.html#r3">curClient</a>;
01376     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;/h1&gt;&lt;/center&gt;\n"</span>;
01377     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h2&gt;Balance Sheet&lt;/h2&gt;&lt;/center&gt;\n"</span>;
01378     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h3&gt;"</span> + periodDate.toString(<span class="stringliteral">"MMM d, yyyy"</span>) + <span class="stringliteral">"&lt;/h3&gt;\n"</span>;
01379 
01380     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;table width=\"60%\"&gt;&lt;tr&gt;"</span>
01381             <span class="stringliteral">"&lt;td width=\"70%\"&gt;&lt;b&gt;Account Description&lt;/b&gt;&lt;/td&gt;"</span>
01382             <span class="stringliteral">"&lt;td align=\"right\" width=\"30%\"&gt;&lt;b&gt;Balance&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;"</span>;
01383 
01384     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> = <span class="stringliteral">"&lt;center&gt;&lt;table width=\"60%\"&gt;"</span>;
01385 
01386     QStringList assetsList;
01387     QStringList liabilitiesList;
01388     QStringList equitiesList;
01389 
01390     QSqlQuery query(<span class="stringliteral">"SELECT * FROM balanceAssets"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
01391     <span class="keywordflow">while</span>(query.next())
01392     {
01393         assetsList &lt;&lt; (query.value(0).toString() + <span class="stringliteral">"\n"</span> + query.value(1).toString()
01394                 + <span class="stringliteral">"\n"</span> + query.value(2).toString() + <span class="stringliteral">"\n"</span> + query.value(3).toString()
01395                 + <span class="stringliteral">"\n"</span> + query.value(4).toString());
01396     }
01397     assetsList.sort();
01398 
01399     query.prepare(<span class="stringliteral">"SELECT * FROM balanceLiabilities"</span>);
01400     query.exec();
01401     <span class="keywordflow">while</span>(query.next())
01402     {
01403         liabilitiesList &lt;&lt; (query.value(0).toString() + <span class="stringliteral">"\n"</span> + query.value(1).toString()
01404                 + <span class="stringliteral">"\n"</span> + query.value(2).toString() + <span class="stringliteral">"\n"</span> + query.value(3).toString()
01405                 + <span class="stringliteral">"\n"</span> + query.value(4).toString());
01406     }
01407     liabilitiesList.sort();
01408 
01409     query.prepare(<span class="stringliteral">"SELECT * FROM balanceEquities"</span>);
01410     query.exec();
01411     <span class="keywordflow">while</span>(query.next())
01412     {
01413         equitiesList &lt;&lt; (query.value(0).toString() + <span class="stringliteral">"\n"</span> + query.value(1).toString()
01414                 + <span class="stringliteral">"\n"</span> + query.value(2).toString() + <span class="stringliteral">"\n"</span> + query.value(3).toString()
01415                 + <span class="stringliteral">"\n"</span> + query.value(4).toString());
01416     }
01417     equitiesList.sort();
01418 
01419 
01420     QString sectionBalance;
01421     QString accountBalance;
01422 
01423     QString type;
01424     QString desc;
01425     QString accountBegin;
01426     QString accountEnd;
01427     
01428     QRegExp regexp(<span class="stringliteral">".*\n(.*)\n(.*)\n(.*)\n(.*)"</span>);
01429 
01430     sectionBalance = <span class="stringliteral">"0.00"</span>;
01431     <span class="keywordflow">for</span>(QStringList::Iterator listIt = assetsList.begin(); listIt != assetsList.end(); ++listIt)
01432     {
01433         regexp.search(*listIt);
01434         type = regexp.cap(1);
01435         desc = regexp.cap(2);
01436         accountBegin = regexp.cap(3);
01437         accountEnd = regexp.cap(4);
01438 
01439         accountBalance = <span class="stringliteral">"0.00"</span>;
01440         <span class="keywordflow">if</span>(type == <span class="stringliteral">"0"</span>)  <span class="comment">// one account</span>
01441         {
01442             query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + accountBegin);
01443             query.exec();
01444             <span class="keywordflow">while</span>(query.next())
01445             {
01446                 entryYear = query.value(0).toString().right(2);
01447                 
01448                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01449                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
01450                 <span class="keywordflow">else</span>
01451                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
01452                 
01453                 entryMonth = query.value(0).toString().left(2);
01454                 entryDay = query.value(0).toString().mid(3,2);
01455                 
01456                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01457                 <span class="keywordflow">if</span>(entryDate &gt; periodDate)
01458                     <span class="keywordflow">continue</span>;
01459 
01460                 <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
01461                     accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
01462                 <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
01463                     accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
01464             }
01465         }
01466         <span class="keywordflow">else</span>  <span class="comment">// begin and end accounts</span>
01467         {
01468             QStringList accounts;
01469 
01470             query.prepare(<span class="stringliteral">"SELECT id FROM accounts"</span>);
01471             query.exec();
01472             <span class="keywordflow">while</span>(query.next())
01473             {
01474                 <span class="keywordflow">if</span>(query.value(0).toInt() &gt;= accountBegin.toInt()
01475                    &amp;&amp; query.value(0).toInt() &lt;= accountEnd.toInt())
01476                     accounts &lt;&lt; query.value(0).toString();
01477             }
01478 
01479             <span class="keywordflow">for</span>(QStringList::Iterator it = accounts.begin(); it != accounts.end(); ++it)
01480             {
01481                 query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + *it);
01482                 query.exec();
01483                 <span class="keywordflow">while</span>(query.next())
01484                 {
01485                     entryYear = query.value(0).toString().right(2);
01486                 
01487                     <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01488                         entryYear.insert(0, <span class="stringliteral">"20"</span>);
01489                     <span class="keywordflow">else</span>
01490                         entryYear.insert(0, <span class="stringliteral">"19"</span>);
01491                 
01492                     entryMonth = query.value(0).toString().left(2);
01493                     entryDay = query.value(0).toString().mid(3,2);
01494                 
01495                     entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01496                     <span class="keywordflow">if</span>(entryDate &gt; periodDate)
01497                         <span class="keywordflow">continue</span>;
01498 
01499                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
01500                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
01501                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
01502                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
01503                 }
01504             }
01505         }
01506 
01507         sectionBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(sectionBalance, accountBalance);
01508 
01509         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"70%\"&gt;"</span> + desc + <span class="stringliteral">"&lt;/td&gt;"</span>
01510                 <span class="stringliteral">"&lt;td align=\"right\" width=\"30%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01511         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += desc + <span class="stringliteral">","</span> + accountBalance + <span class="stringliteral">"\n"</span>;
01512     }
01513 
01514     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01515     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"70%\"&gt;&lt;b&gt;Total Assets&lt;/b&gt;&lt;/td&gt;"</span>
01516             <span class="stringliteral">"&lt;td align=\"right\" width=\"30%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(sectionBalance) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01517     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01518     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Total Assets,"</span> + sectionBalance + <span class="stringliteral">"\n"</span>;
01519 
01520 
01521     sectionBalance = <span class="stringliteral">"0.00"</span>;
01522     <span class="keywordflow">for</span>(QStringList::Iterator listIt = liabilitiesList.begin(); listIt != liabilitiesList.end(); ++listIt)
01523     {
01524         regexp.search(*listIt);
01525         type = regexp.cap(1);
01526         desc = regexp.cap(2);
01527         accountBegin = regexp.cap(3);
01528         accountEnd = regexp.cap(4);
01529 
01530         accountBalance = <span class="stringliteral">"0.00"</span>;
01531         <span class="keywordflow">if</span>(type == <span class="stringliteral">"0"</span>)  <span class="comment">// one account</span>
01532         {
01533             query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + accountBegin);
01534             query.exec();
01535             <span class="keywordflow">while</span>(query.next())
01536             {
01537                 entryYear = query.value(0).toString().right(2);
01538                 
01539                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01540                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
01541                 <span class="keywordflow">else</span>
01542                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
01543                 
01544                 entryMonth = query.value(0).toString().left(2);
01545                 entryDay = query.value(0).toString().mid(3,2);
01546 
01547                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01548                 <span class="keywordflow">if</span>(entryDate &gt; periodDate)
01549                     <span class="keywordflow">continue</span>;
01550 
01551                 <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
01552                 {
01553                     accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(1).toString()));
01554                 }
01555                 <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
01556                 {
01557                     accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(2).toString());
01558                 }
01559             }
01560         }
01561         <span class="keywordflow">else</span>  <span class="comment">// begin and end accounts</span>
01562         {
01563             QStringList accounts;
01564 
01565             query.prepare(<span class="stringliteral">"SELECT id FROM accounts"</span>);
01566             query.exec();
01567             <span class="keywordflow">while</span>(query.next())
01568             {
01569                 <span class="keywordflow">if</span>(query.value(0).toInt() &gt;= accountBegin.toInt()
01570                    &amp;&amp; query.value(0).toInt() &lt;= accountEnd.toInt())
01571                     accounts &lt;&lt; query.value(0).toString();
01572             }
01573 
01574             <span class="keywordflow">for</span>(QStringList::Iterator it = accounts.begin(); it != accounts.end(); ++it)
01575             {
01576                 query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + *it);
01577                 query.exec();
01578                 <span class="keywordflow">while</span>(query.next())
01579                 {
01580                     entryYear = query.value(0).toString().right(2);
01581                 
01582                     <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01583                         entryYear.insert(0, <span class="stringliteral">"20"</span>);
01584                     <span class="keywordflow">else</span>
01585                         entryYear.insert(0, <span class="stringliteral">"19"</span>);
01586                 
01587                     entryMonth = query.value(0).toString().left(2);
01588                     entryDay = query.value(0).toString().mid(3,2);
01589 
01590                     entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01591                     <span class="keywordflow">if</span>(entryDate &gt; periodDate)
01592                         <span class="keywordflow">continue</span>;
01593 
01594                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
01595                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(1).toString()));
01596                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
01597                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(2).toString());
01598                 }
01599             }
01600         }
01601 
01602         sectionBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(sectionBalance, accountBalance);
01603 
01604         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"70%\"&gt;"</span> + desc + <span class="stringliteral">"&lt;/td&gt;"</span>
01605                 <span class="stringliteral">"&lt;td align=\"right\" width=\"30%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01606         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += desc + <span class="stringliteral">","</span> + accountBalance + <span class="stringliteral">"\n"</span>;
01607     }
01608 
01609     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01610     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"70%\"&gt;&lt;b&gt;Total Liabilities&lt;/b&gt;&lt;/td&gt;"</span>
01611             <span class="stringliteral">"&lt;td align=\"right\" width=\"30%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(sectionBalance) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01612     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01613     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Total Liabilities,"</span> + sectionBalance + <span class="stringliteral">"\n"</span>;
01614 
01615 
01616     sectionBalance = <span class="stringliteral">"0.00"</span>;
01617     <span class="keywordflow">for</span>(QStringList::Iterator listIt = equitiesList.begin(); listIt != equitiesList.end(); ++listIt)
01618     {
01619         regexp.search(*listIt);
01620         type = regexp.cap(1);
01621         desc = regexp.cap(2);
01622         accountBegin = regexp.cap(3);
01623         accountEnd = regexp.cap(4);
01624 
01625         accountBalance = <span class="stringliteral">"0.00"</span>;
01626         <span class="keywordflow">if</span>(type == <span class="stringliteral">"0"</span>)  <span class="comment">// one account</span>
01627         {
01628             query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + accountBegin);
01629             query.exec();
01630             <span class="keywordflow">while</span>(query.next())
01631             {
01632                 entryYear = query.value(0).toString().right(2);
01633                 
01634                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01635                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
01636                 <span class="keywordflow">else</span>
01637                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
01638                 
01639                 entryMonth = query.value(0).toString().left(2);
01640                 entryDay = query.value(0).toString().mid(3,2);
01641                 
01642                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01643                 <span class="keywordflow">if</span>(entryDate &gt; periodDate)
01644                     <span class="keywordflow">continue</span>;
01645 
01646                 <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
01647                 {
01648                     accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(1).toString()));
01649                 }
01650                 <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
01651                 {
01652                     accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(2).toString());
01653                 }
01654             }
01655         }
01656         <span class="keywordflow">else</span>  <span class="comment">// begin and end accounts</span>
01657         {
01658             QStringList accounts;
01659 
01660             query.prepare(<span class="stringliteral">"SELECT id FROM accounts"</span>);
01661             query.exec();
01662             <span class="keywordflow">while</span>(query.next())
01663             {
01664                 <span class="keywordflow">if</span>(query.value(0).toInt() &gt;= accountBegin.toInt()
01665                    &amp;&amp; query.value(0).toInt() &lt;= accountEnd.toInt())
01666                     accounts &lt;&lt; query.value(0).toString();
01667             }
01668 
01669             <span class="keywordflow">for</span>(QStringList::Iterator it = accounts.begin(); it != accounts.end(); ++it)
01670             {
01671                 query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + *it);
01672                 query.exec();
01673                 <span class="keywordflow">while</span>(query.next())
01674                 {
01675                     entryYear = query.value(0).toString().right(2);
01676                 
01677                     <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01678                         entryYear.insert(0, <span class="stringliteral">"20"</span>);
01679                     <span class="keywordflow">else</span>
01680                         entryYear.insert(0, <span class="stringliteral">"19"</span>);
01681                 
01682                     entryMonth = query.value(0).toString().left(2);
01683                     entryDay = query.value(0).toString().mid(3,2);
01684                 
01685                     entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01686                     <span class="keywordflow">if</span>(entryDate &gt; periodDate)
01687                         <span class="keywordflow">continue</span>;
01688 
01689                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
01690                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(1).toString()));
01691                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
01692                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(2).toString());
01693                 }
01694             }
01695         }
01696 
01697         sectionBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(sectionBalance, accountBalance);
01698 
01699         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"70%\"&gt;"</span> + desc + <span class="stringliteral">"&lt;/td&gt;"</span>
01700                 <span class="stringliteral">"&lt;td align=\"right\" width=\"30%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01701         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += desc + <span class="stringliteral">","</span> + accountBalance + <span class="stringliteral">"\n"</span>;
01702     }
01703     
01704     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01705     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"70%\"&gt;&lt;b&gt;Total Equities&lt;/b&gt;&lt;/td&gt;"</span>
01706             <span class="stringliteral">"&lt;td align=\"right\" width=\"30%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(sectionBalance) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01707     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01708     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Total Equities,"</span> + sectionBalance + <span class="stringliteral">"\n"</span>;
01709 
01710     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;/table&gt;&lt;/center&gt;"</span>;
01711 
01712     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a> = <span class="stringliteral">"&lt;qt&gt;"</span> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> + <span class="stringliteral">"&lt;/qt&gt;"</span>;
01713     
01714     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o4">html</a> = <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a>.replace(
01715             <span class="stringliteral">"&lt;qt&gt;"</span>, <span class="stringliteral">"&lt;html&gt;&lt;head&gt;&lt;title&gt;"</span> + <a class="code" href="classDatabase.html#r3">curClient</a> +
01716             <span class="stringliteral">" - Balance Sheet&lt;/title&gt;&lt;/head&gt;&lt;body&gt;\n"</span>).replace(
01717                     <span class="stringliteral">"&lt;/qt&gt;"</span>, <span class="stringliteral">"&lt;/body&gt;&lt;/html&gt;"</span>);
01718 
01719     <span class="keywordflow">return</span> <span class="keyword">this</span>;
01720 }
01721 
<a name="l01722"></a><a class="code" href="classDatabase.html#a25">01722</a> <a class="code" href="classDatabase.html">Database</a>* <a class="code" href="classDatabase.html#a25">Database::getChartAccounts</a>()
01723 {
01724     QSqlQuery query(<span class="stringliteral">"SELECT * FROM accounts ORDER BY id"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
01725     
01726     QDate date = QDate::currentDate();
01727     
01728     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> = <span class="stringliteral">"Account ID,Account Description\n"</span>;
01729     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> = <span class="stringliteral">"&lt;center&gt;&lt;h1&gt;"</span>;
01730     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <a class="code" href="classDatabase.html#r3">curClient</a>;
01731     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;/h1&gt;&lt;/center&gt;\n"</span>;
01732     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h2&gt;Chart of Accounts&lt;/h2&gt;&lt;/center&gt;\n"</span>;
01733     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h3&gt;As of "</span> + date.toString(<span class="stringliteral">"MMM d, yyyy"</span>) + <span class="stringliteral">"&lt;/h3&gt;&lt;/center&gt;\n"</span>;
01734 
01735     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;table width=\"100%\"&gt;&lt;tr&gt;&lt;td width=\"15%\"&gt;&lt;b&gt;Account ID&lt;/b&gt;&lt;/td&gt;"</span>
01736             <span class="stringliteral">"&lt;td width=\"40%\"&gt;&lt;b&gt;Account Description&lt;/b&gt;&lt;/td&gt;&lt;td width=\"45%\"&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
01737 
01738     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> = <span class="stringliteral">"&lt;table width=\"100%\"&gt;"</span>;
01739     
01740     QStringList <a class="code" href="classDatabase.html#a31">reportString</a>;
01741     QStringList <a class="code" href="classDatabase.html#a32">reportCSV</a>;
01742     
01743     <span class="keywordflow">while</span>(query.next())
01744     {
01745         reportCSV &lt;&lt; (query.value(1).toString() + <span class="stringliteral">","</span> + query.value(2).toString() + <span class="stringliteral">"\n"</span>);
01746         reportString &lt;&lt; (<span class="stringliteral">"&lt;tr&gt;&lt;td width=\"15%\"&gt;"</span> + query.value(1).toString() + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"40%\"&gt;"</span> +
01747                 query.value(2).toString() + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"45%\"&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>);
01748     }
01749     
01750     
01751     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += reportString.join(<span class="stringliteral">""</span>) + <span class="stringliteral">"&lt;/table&gt;"</span>;
01752     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += reportCSV.join(<span class="stringliteral">""</span>);
01753     
01754     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a> = <span class="stringliteral">"&lt;qt&gt;"</span> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> + <span class="stringliteral">"&lt;/qt&gt;"</span>;
01755     
01756     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o4">html</a> = <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a>.replace(
01757             <span class="stringliteral">"&lt;qt&gt;"</span>, <span class="stringliteral">"&lt;html&gt;&lt;head&gt;&lt;title&gt;"</span> + <a class="code" href="classDatabase.html#r3">curClient</a> + <span class="stringliteral">" - Chart of Accounts&lt;/title&gt;&lt;/head&gt;&lt;body&gt;\n"</span>).replace(
01758             <span class="stringliteral">"&lt;/qt&gt;"</span>, <span class="stringliteral">"&lt;/body&gt;&lt;/html&gt;"</span>);
01759     
01760     <span class="keywordflow">return</span> <span class="keyword">this</span>;
01761 }
01762 
<a name="l01763"></a><a class="code" href="classDatabase.html#a26">01763</a> <a class="code" href="classDatabase.html">Database</a>* <a class="code" href="classDatabase.html#a26">Database::getJournalTmpReport</a>()
01764 {
01765     QSqlQuery query(<span class="stringliteral">"SELECT * FROM journalTmp ORDER BY key"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
01766     
01767     QDate date = QDate::currentDate();
01768 
01769     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o0">header</a> = <span class="stringliteral">"&lt;center&gt;&lt;h1&gt;"</span>;
01770     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o0">header</a> += <a class="code" href="classDatabase.html#r3">curClient</a>;
01771     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o0">header</a> += <span class="stringliteral">"&lt;/h1&gt;&lt;/center&gt;\n"</span>;
01772     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h2&gt;Journal Entries&lt;/h2&gt;&lt;/center&gt;\n"</span>;
01773     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h3&gt;Entered "</span> + date.toString(<span class="stringliteral">"MMM d, yyyy"</span>) + <span class="stringliteral">"&lt;/h3&gt;&lt;/center&gt;\n"</span>;
01774 
01775     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o0">header</a> += <span class="stringliteral">"&lt;table width=\"100%\"&gt;&lt;tr&gt;&lt;td width=\"10%\"&gt;&lt;b&gt;Date&lt;/b&gt;&lt;/td&gt;"</span>
01776             <span class="stringliteral">"&lt;td width=\"10%\"&gt;&lt;b&gt;Account&lt;/b&gt;&lt;/td&gt;&lt;td width=\"10%\"&gt;&lt;b&gt;Reference&lt;/b&gt;&lt;/td&gt;"</span>
01777             <span class="stringliteral">"&lt;td width=\"50%\"&gt;&lt;b&gt;Description&lt;/b&gt;&lt;/td&gt;&lt;td width\"10%\" align=\"right\"&gt;&lt;b&gt;Debit Amt&lt;/b&gt;&lt;/td&gt;"</span>
01778             <span class="stringliteral">"&lt;td width=\"10%\" align=\"right\"&gt;&lt;b&gt;Credit Amt&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01779 
01780     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o1">data</a> = <span class="stringliteral">"&lt;table width=\"100%\"&gt;"</span>;
01781     
01782     QStringList <a class="code" href="classDatabase.html#a31">reportString</a>;
01783     
01784     <span class="keywordflow">while</span>(query.next())
01785     {
01786         <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"10%\"&gt;"</span> + query.value(1).toString() + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"10%\"&gt;"</span> +
01787                 query.value(2).toString() + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"10%\"&gt;"</span> + query.value(3).toString() +
01788                 <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"50%\"&gt;"</span> + query.value(4).toString() + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"10%\" align=\"right\"&gt;"</span> +
01789                 <a class="code" href="classDatabase.html#a48">addCommas</a>(query.value(5).toString()) + <span class="stringliteral">"&lt;/td&gt;&lt;td width=\"10%\" align=\"right\"&gt;"</span>
01790                 + <a class="code" href="classDatabase.html#a48">addCommas</a>(query.value(6).toString()) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
01791     }
01792 
01793     <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o1">data</a> += <span class="stringliteral">"&lt;/table&gt;"</span>;
01794     
01795     <span class="keywordflow">return</span> <span class="keyword">this</span>;
01796 }
01797 
<a name="l01798"></a><a class="code" href="classDatabase.html#a27">01798</a> <a class="code" href="classDatabase.html">Database</a>* <a class="code" href="classDatabase.html#a27">Database::getIncomeSvcReport</a>(QString periodEnd)
01799 {
01800     QRegExp dateRegexp(<span class="stringliteral">"Period \\d+ \\((\\d\\d)/(\\d\\d)/(\\d\\d)\\)"</span>);
01801 
01802     dateRegexp.search(<a class="code" href="classDatabase.html#a16">getPeriodBegin</a>()[0]);
01803     <span class="keywordtype">int</span> periodBeginMonth = dateRegexp.cap(1).toInt();
01804     QDate periodBeginDate(dateRegexp.cap(3).insert(0, <span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), dateRegexp.cap(2).toInt());
01805 
01806     dateRegexp.search(periodEnd);
01807     QDate periodBeginSingleDate(dateRegexp.cap(3).insert(0, <span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), 1);
01808 
01809     dateRegexp.search(periodEnd);
01810     <span class="keywordtype">int</span> periodEndMonth = dateRegexp.cap(1).toInt();
01811     QDate periodEndDate(dateRegexp.cap(3).insert(0, <span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), dateRegexp.cap(2).toInt());
01812 
01813     QDate curDate = QDate::currentDate();
01814 
01815     QString monthRange;
01816     <span class="keywordtype">int</span> monthRangeInt = periodEndMonth - periodBeginMonth;
01817     <span class="keywordflow">if</span>(monthRangeInt &lt; 0)
01818         monthRangeInt += 12;
01819     monthRangeInt++;
01820 
01821     <span class="keywordflow">if</span>(monthRangeInt == 1)
01822         monthRange = <span class="stringliteral">"One"</span>;
01823     <span class="keywordflow">if</span>(monthRangeInt == 2)
01824         monthRange = <span class="stringliteral">"Two"</span>;
01825     <span class="keywordflow">if</span>(monthRangeInt == 3)
01826         monthRange = <span class="stringliteral">"Three"</span>;
01827     <span class="keywordflow">if</span>(monthRangeInt == 4)
01828         monthRange = <span class="stringliteral">"Four"</span>;
01829     <span class="keywordflow">if</span>(monthRangeInt == 5)
01830         monthRange = <span class="stringliteral">"Five"</span>;
01831     <span class="keywordflow">if</span>(monthRangeInt == 6)
01832         monthRange = <span class="stringliteral">"Six"</span>;
01833     <span class="keywordflow">if</span>(monthRangeInt == 7)
01834         monthRange = <span class="stringliteral">"Seven"</span>;
01835     <span class="keywordflow">if</span>(monthRangeInt == 8)
01836         monthRange = <span class="stringliteral">"Eight"</span>;
01837     <span class="keywordflow">if</span>(monthRangeInt == 9)
01838         monthRange = <span class="stringliteral">"Nine"</span>;
01839     <span class="keywordflow">if</span>(monthRangeInt == 10)
01840         monthRange = <span class="stringliteral">"Ten"</span>;
01841     <span class="keywordflow">if</span>(monthRangeInt == 11)
01842         monthRange = <span class="stringliteral">"Eleven"</span>;
01843     <span class="keywordflow">if</span>(monthRangeInt == 12)
01844         monthRange = <span class="stringliteral">"Twelve"</span>;
01845 
01846     QString entryYear;
01847     QString entryMonth;
01848     QString entryDay;
01849     QDate entryDate;
01850 
01851     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> = <span class="stringliteral">"Account Description,One Month Balance,"</span>;
01852     <span class="keywordflow">if</span>(monthRange == <span class="stringliteral">"One"</span>)
01853         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"One Month Balance\n"</span>;
01854     <span class="keywordflow">else</span>
01855         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += monthRange + <span class="stringliteral">" Months Balance\n"</span>;
01856 
01857     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> = <span class="stringliteral">"&lt;center&gt;&lt;h1&gt;"</span>;
01858     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <a class="code" href="classDatabase.html#r3">curClient</a>;
01859     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;/h1&gt;&lt;/center&gt;\n"</span>;
01860     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h2&gt;Income Statement Service Company&lt;/h2&gt;&lt;/center&gt;\n"</span>;
01861     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h3&gt;For One Month and "</span>;
01862     <span class="keywordflow">if</span>(monthRange == <span class="stringliteral">"One"</span>)
01863         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"One Month"</span>;
01864     <span class="keywordflow">else</span>
01865         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += monthRange + <span class="stringliteral">" Months"</span>;
01866     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">" Ended "</span> + periodEndDate.toString(<span class="stringliteral">"MMM d, yyyy"</span>) + <span class="stringliteral">"&lt;/h3&gt;\n"</span>;
01867 
01868     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;table width=\"80%\"&gt;&lt;tr&gt;"</span>
01869             <span class="stringliteral">"&lt;td width=\"50%\"&gt;&lt;b&gt;Account Description&lt;/b&gt;&lt;/td&gt;"</span>
01870             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;One Month&lt;/b&gt;&lt;/td&gt;"</span>
01871             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span>;
01872     <span class="keywordflow">if</span>(monthRange == <span class="stringliteral">"One"</span>)
01873         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"One Month"</span>;
01874     <span class="keywordflow">else</span>
01875         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += monthRange + <span class="stringliteral">" Months"</span>;
01876     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;"</span>;
01877 
01878     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> = <span class="stringliteral">"&lt;center&gt;&lt;table width=\"80%\"&gt;"</span>;
01879 
01880     QStringList incomeList;
01881     QStringList expensesList;
01882 
01883     QSqlQuery query(<span class="stringliteral">"SELECT * FROM incomeSvcIncome"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
01884     <span class="keywordflow">while</span>(query.next())
01885     {
01886         incomeList &lt;&lt; (query.value(0).toString() + <span class="stringliteral">"\n"</span> + query.value(1).toString()
01887         + <span class="stringliteral">"\n"</span> + query.value(2).toString() + <span class="stringliteral">"\n"</span> + query.value(3).toString()
01888         + <span class="stringliteral">"\n"</span> + query.value(4).toString());
01889     }
01890     incomeList.sort();
01891 
01892     query.prepare(<span class="stringliteral">"SELECT * FROM incomeSvcExpenses"</span>);
01893     query.exec();
01894     <span class="keywordflow">while</span>(query.next())
01895     {
01896         expensesList &lt;&lt; (query.value(0).toString() + <span class="stringliteral">"\n"</span> + query.value(1).toString()
01897         + <span class="stringliteral">"\n"</span> + query.value(2).toString() + <span class="stringliteral">"\n"</span> + query.value(3).toString()
01898         + <span class="stringliteral">"\n"</span> + query.value(4).toString());
01899     }
01900     expensesList.sort();
01901 
01902     QString incomeBalance;
01903     QString incomeBalanceSingle;
01904     QString expensesBalance;
01905     QString expensesBalanceSingle;
01906     QString accountBalance;
01907     QString accountBalanceSingle;
01908 
01909     QString type;
01910     QString desc;
01911     QString accountBegin;
01912     QString accountEnd;
01913 
01914     QRegExp regexp(<span class="stringliteral">".*\n(.*)\n(.*)\n(.*)\n(.*)"</span>);
01915 
01916     incomeBalance = <span class="stringliteral">"0.00"</span>;
01917     incomeBalanceSingle = <span class="stringliteral">"0.00"</span>;
01918     <span class="keywordflow">for</span>(QStringList::Iterator listIt = incomeList.begin(); listIt != incomeList.end(); ++listIt)
01919     {
01920         regexp.search(*listIt);
01921         type = regexp.cap(1);
01922         desc = regexp.cap(2);
01923         accountBegin = regexp.cap(3);
01924         accountEnd = regexp.cap(4);
01925 
01926         accountBalance = <span class="stringliteral">"0.00"</span>;
01927         accountBalanceSingle = <span class="stringliteral">"0.00"</span>;
01928         <span class="keywordflow">if</span>(type == <span class="stringliteral">"0"</span>)
01929         {
01930             query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + accountBegin);
01931             query.exec();
01932             <span class="keywordflow">while</span>(query.next())
01933             {
01934                 entryYear = query.value(0).toString().right(2);
01935 
01936                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01937                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
01938                 <span class="keywordflow">else</span>
01939                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
01940 
01941                 entryMonth = query.value(0).toString().left(2);
01942                 entryDay = query.value(0).toString().mid(3,2);
01943 
01944                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01945                 <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
01946                     <span class="keywordflow">continue</span>;
01947 
01948                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
01949                 {
01950                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
01951                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
01952                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
01953                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
01954                 }
01955                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
01956                 {
01957                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
01958                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
01959                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
01960                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
01961                 }
01962             }
01963         }
01964         <span class="keywordflow">else</span>
01965         {
01966             QStringList accounts;
01967 
01968             query.prepare(<span class="stringliteral">"SELECT id FROM accounts"</span>);
01969             query.exec();
01970             <span class="keywordflow">while</span>(query.next())
01971             {
01972                 <span class="keywordflow">if</span>(query.value(0).toInt() &gt;= accountBegin.toInt()
01973                    &amp;&amp; query.value(0).toInt() &lt;= accountEnd.toInt())
01974                     accounts &lt;&lt; query.value(0).toString();
01975             }
01976 
01977             <span class="keywordflow">for</span>(QStringList::Iterator it = accounts.begin(); it != accounts.end(); ++it)
01978             {
01979                 query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + *it);
01980                 query.exec();
01981                 <span class="keywordflow">while</span>(query.next())
01982                 {
01983                     entryYear = query.value(0).toString().right(2);
01984 
01985                     <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
01986                         entryYear.insert(0, <span class="stringliteral">"20"</span>);
01987                     <span class="keywordflow">else</span>
01988                         entryYear.insert(0, <span class="stringliteral">"19"</span>);
01989 
01990                     entryMonth = query.value(0).toString().left(2);
01991                     entryDay = query.value(0).toString().mid(3,2);
01992 
01993                     entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
01994                     <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
01995                         <span class="keywordflow">continue</span>;
01996 
01997                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
01998                     {
01999                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02000                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
02001                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02002                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02003                     }
02004                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
02005                     {
02006                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02007                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
02008                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02009                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02010                     }
02011                 }
02012             }
02013         }
02014 
02015         incomeBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(accountBalance));
02016         incomeBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(accountBalanceSingle));
02017 
02018         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"50%\"&gt;"</span> + desc + <span class="stringliteral">"&lt;/td&gt;"</span>
02019                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalanceSingle) + <span class="stringliteral">"&lt;/td&gt;"</span>
02020                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02021         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += desc + <span class="stringliteral">","</span> + accountBalanceSingle + <span class="stringliteral">","</span> + accountBalance + <span class="stringliteral">"\n"</span>;
02022     }
02023 
02024     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02025     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td align=\"right\" width=\"50%\"&gt;&lt;b&gt;Total Income&lt;/b&gt;&lt;/td&gt;"</span>
02026             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(incomeBalanceSingle) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;"</span>
02027             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(incomeBalance) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02028     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02029     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Total Income,"</span> + incomeBalanceSingle + <span class="stringliteral">","</span> + incomeBalance + <span class="stringliteral">"\n\n"</span>;
02030 
02031 
02032     expensesBalance = <span class="stringliteral">"0.00"</span>;
02033     expensesBalanceSingle = <span class="stringliteral">"0.00"</span>;
02034     <span class="keywordflow">for</span>(QStringList::Iterator listIt = expensesList.begin(); listIt != expensesList.end(); ++listIt)
02035     {
02036         regexp.search(*listIt);
02037         type = regexp.cap(1);
02038         desc = regexp.cap(2);
02039         accountBegin = regexp.cap(3);
02040         accountEnd = regexp.cap(4);
02041 
02042         accountBalance = <span class="stringliteral">"0.00"</span>;
02043         accountBalanceSingle = <span class="stringliteral">"0.00"</span>;
02044         <span class="keywordflow">if</span>(type == <span class="stringliteral">"0"</span>)
02045         {
02046             query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + accountBegin);
02047             query.exec();
02048             <span class="keywordflow">while</span>(query.next())
02049             {
02050                 entryYear = query.value(0).toString().right(2);
02051 
02052                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
02053                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
02054                 <span class="keywordflow">else</span>
02055                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
02056 
02057                 entryMonth = query.value(0).toString().left(2);
02058                 entryDay = query.value(0).toString().mid(3,2);
02059 
02060                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
02061                 <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
02062                     <span class="keywordflow">continue</span>;
02063 
02064                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
02065                 {
02066                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02067                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
02068                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02069                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02070                 }
02071                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
02072                 {
02073                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02074                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
02075                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02076                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02077                 }
02078             }
02079         }
02080         <span class="keywordflow">else</span>
02081         {
02082             QStringList accounts;
02083 
02084             query.prepare(<span class="stringliteral">"SELECT id FROM accounts"</span>);
02085             query.exec();
02086             <span class="keywordflow">while</span>(query.next())
02087             {
02088                 <span class="keywordflow">if</span>(query.value(0).toInt() &gt;= accountBegin.toInt()
02089                    &amp;&amp; query.value(0).toInt() &lt;= accountEnd.toInt())
02090                     accounts &lt;&lt; query.value(0).toString();
02091             }
02092 
02093             <span class="keywordflow">for</span>(QStringList::Iterator it = accounts.begin(); it != accounts.end(); ++it)
02094             {
02095                 query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + *it);
02096                 query.exec();
02097                 <span class="keywordflow">while</span>(query.next())
02098                 {
02099                     entryYear = query.value(0).toString().right(2);
02100 
02101                     <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
02102                         entryYear.insert(0, <span class="stringliteral">"20"</span>);
02103                     <span class="keywordflow">else</span>
02104                         entryYear.insert(0, <span class="stringliteral">"19"</span>);
02105 
02106                     entryMonth = query.value(0).toString().left(2);
02107                     entryDay = query.value(0).toString().mid(3,2);
02108 
02109                     entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
02110                     <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
02111                         <span class="keywordflow">continue</span>;
02112 
02113                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
02114                     {
02115                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02116                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
02117                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02118                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02119                     }
02120                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
02121                     {
02122                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02123                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
02124                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02125                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02126                     }
02127                 }
02128             }
02129         }
02130 
02131         expensesBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(expensesBalance, accountBalance);
02132         expensesBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(expensesBalanceSingle, accountBalanceSingle);
02133 
02134         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"50%\"&gt;"</span> + desc + <span class="stringliteral">"&lt;/td&gt;"</span>
02135                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalanceSingle) + <span class="stringliteral">"&lt;/td&gt;"</span>
02136                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02137         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += desc + <span class="stringliteral">","</span> + accountBalanceSingle + <span class="stringliteral">","</span> + accountBalance + <span class="stringliteral">"\n"</span>;
02138     }
02139 
02140     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02141     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td align=\"right\" width=\"50%\"&gt;&lt;b&gt;Total Expenses&lt;/b&gt;&lt;/td&gt;"</span>
02142             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(expensesBalanceSingle) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;"</span>
02143             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(expensesBalance) + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02144     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02145     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Total Expenses,"</span> + expensesBalanceSingle + <span class="stringliteral">","</span> + expensesBalance + <span class="stringliteral">"\n"</span>;
02146 
02147     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td align=\"right\" width=\"50%\"&gt;&lt;b&gt;Net Income (Loss)&lt;/b&gt;&lt;/td&gt;"</span>
02148             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(<a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalanceSingle, expensesBalanceSingle))
02149             + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;"</span>
02150             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(<a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalance, expensesBalance))
02151             + <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02152     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Net Income (Loss),"</span> + <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalanceSingle, expensesBalanceSingle)
02153             + <span class="stringliteral">","</span> + <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalance, expensesBalance) + <span class="stringliteral">"\n"</span>;
02154 
02155     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;/table&gt;&lt;/center&gt;"</span>;
02156 
02157     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a> = <span class="stringliteral">"&lt;qt&gt;"</span> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> + <span class="stringliteral">"&lt;/qt&gt;"</span>;
02158 
02159     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o4">html</a> = <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a>.replace(
02160             <span class="stringliteral">"&lt;qt&gt;"</span>, <span class="stringliteral">"&lt;html&gt;&lt;head&gt;&lt;title&gt;"</span> + <a class="code" href="classDatabase.html#r3">curClient</a> +
02161             <span class="stringliteral">" - Income Statement Service Company&lt;/title&gt;&lt;/head&gt;&lt;body&gt;\n"</span>).replace(
02162                     <span class="stringliteral">"&lt;/qt&gt;"</span>, <span class="stringliteral">"&lt;/body&gt;&lt;/html&gt;"</span>);
02163 
02164     <span class="keywordflow">return</span> <span class="keyword">this</span>;
02165 }
02166 
<a name="l02167"></a><a class="code" href="classDatabase.html#a28">02167</a> <a class="code" href="classDatabase.html">Database</a>* <a class="code" href="classDatabase.html#a28">Database::getIncomeRetailReport</a>(QString periodEnd)
02168 {
02169     QRegExp dateRegexp(<span class="stringliteral">"Period \\d+ \\((\\d\\d)/(\\d\\d)/(\\d\\d)\\)"</span>);
02170 
02171     dateRegexp.search(<a class="code" href="classDatabase.html#a16">getPeriodBegin</a>()[0]);
02172     <span class="keywordtype">int</span> periodBeginMonth = dateRegexp.cap(1).toInt();
02173     QDate periodBeginDate(dateRegexp.cap(3).insert(0, <span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), dateRegexp.cap(2).toInt());
02174 
02175     dateRegexp.search(periodEnd);
02176     QDate periodBeginSingleDate(dateRegexp.cap(3).insert(0, <span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), 1);
02177 
02178     dateRegexp.search(periodEnd);
02179     <span class="keywordtype">int</span> periodEndMonth = dateRegexp.cap(1).toInt();
02180     QDate periodEndDate(dateRegexp.cap(3).insert(0, <span class="stringliteral">"20"</span>).toInt(), dateRegexp.cap(1).toInt(), dateRegexp.cap(2).toInt());
02181 
02182     QDate curDate = QDate::currentDate();
02183 
02184     QString monthRange;
02185     <span class="keywordtype">int</span> monthRangeInt = periodEndMonth - periodBeginMonth;
02186     <span class="keywordflow">if</span>(monthRangeInt &lt; 0)
02187         monthRangeInt += 12;
02188     monthRangeInt++;
02189 
02190     <span class="keywordflow">if</span>(monthRangeInt == 1)
02191         monthRange = <span class="stringliteral">"One"</span>;
02192     <span class="keywordflow">if</span>(monthRangeInt == 2)
02193         monthRange = <span class="stringliteral">"Two"</span>;
02194     <span class="keywordflow">if</span>(monthRangeInt == 3)
02195         monthRange = <span class="stringliteral">"Three"</span>;
02196     <span class="keywordflow">if</span>(monthRangeInt == 4)
02197         monthRange = <span class="stringliteral">"Four"</span>;
02198     <span class="keywordflow">if</span>(monthRangeInt == 5)
02199         monthRange = <span class="stringliteral">"Five"</span>;
02200     <span class="keywordflow">if</span>(monthRangeInt == 6)
02201         monthRange = <span class="stringliteral">"Six"</span>;
02202     <span class="keywordflow">if</span>(monthRangeInt == 7)
02203         monthRange = <span class="stringliteral">"Seven"</span>;
02204     <span class="keywordflow">if</span>(monthRangeInt == 8)
02205         monthRange = <span class="stringliteral">"Eight"</span>;
02206     <span class="keywordflow">if</span>(monthRangeInt == 9)
02207         monthRange = <span class="stringliteral">"Nine"</span>;
02208     <span class="keywordflow">if</span>(monthRangeInt == 10)
02209         monthRange = <span class="stringliteral">"Ten"</span>;
02210     <span class="keywordflow">if</span>(monthRangeInt == 11)
02211         monthRange = <span class="stringliteral">"Eleven"</span>;
02212     <span class="keywordflow">if</span>(monthRangeInt == 12)
02213         monthRange = <span class="stringliteral">"Twelve"</span>;
02214 
02215     QString entryYear;
02216     QString entryMonth;
02217     QString entryDay;
02218     QDate entryDate;
02219 
02220     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> = <span class="stringliteral">"Account Description,One Month Balance,"</span>;
02221     <span class="keywordflow">if</span>(monthRange == <span class="stringliteral">"One"</span>)
02222         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"One Month Balance\n"</span>;
02223     <span class="keywordflow">else</span>
02224         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += monthRange + <span class="stringliteral">" Months Balance\n"</span>;
02225 
02226     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> = <span class="stringliteral">"&lt;center&gt;&lt;h1&gt;"</span>;
02227     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <a class="code" href="classDatabase.html#r3">curClient</a>;
02228     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;/h1&gt;&lt;/center&gt;\n"</span>;
02229     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h2&gt;Income Statement Retail&lt;/h2&gt;&lt;/center&gt;\n"</span>;
02230     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;center&gt;&lt;h3&gt;For One Month and "</span>;
02231     <span class="keywordflow">if</span>(monthRange == <span class="stringliteral">"One"</span>)
02232         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"One Month"</span>;
02233     <span class="keywordflow">else</span>
02234         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += monthRange + <span class="stringliteral">" Months"</span>;
02235     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">" Ended "</span> + periodEndDate.toString(<span class="stringliteral">"MMM d, yyyy"</span>) + <span class="stringliteral">"&lt;/h3&gt;\n"</span>;
02236 
02237     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;table width=\"80%\"&gt;&lt;tr&gt;"</span>
02238             <span class="stringliteral">"&lt;td width=\"50%\"&gt;&lt;b&gt;Account Description&lt;/b&gt;&lt;/td&gt;"</span>
02239             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;One Month&lt;/b&gt;&lt;/td&gt;"</span>
02240             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span>;
02241     <span class="keywordflow">if</span>(monthRange == <span class="stringliteral">"One"</span>)
02242         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"One Month"</span>;
02243     <span class="keywordflow">else</span>
02244         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += monthRange + <span class="stringliteral">" Months"</span>;
02245     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> += <span class="stringliteral">"&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/center&gt;"</span>;
02246 
02247     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> = <span class="stringliteral">"&lt;center&gt;&lt;table width=\"80%\"&gt;"</span>;
02248 
02249     QStringList incomeList;
02250     QStringList cosList;
02251     QStringList expensesList;
02252 
02253     QSqlQuery query(<span class="stringliteral">"SELECT * FROM incomeRetailIncome"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
02254     <span class="keywordflow">while</span>(query.next())
02255     {
02256         incomeList &lt;&lt; (query.value(0).toString() + <span class="stringliteral">"\n"</span> + query.value(1).toString()
02257         + <span class="stringliteral">"\n"</span> + query.value(2).toString() + <span class="stringliteral">"\n"</span> + query.value(3).toString()
02258         + <span class="stringliteral">"\n"</span> + query.value(4).toString());
02259     }
02260     incomeList.sort();
02261 
02262     query.prepare(<span class="stringliteral">"SELECT * FROM incomeRetailCOS"</span>);
02263     query.exec();
02264     <span class="keywordflow">while</span>(query.next())
02265     {
02266         cosList &lt;&lt; (query.value(0).toString() + <span class="stringliteral">"\n"</span> + query.value(1).toString()
02267         + <span class="stringliteral">"\n"</span> + query.value(2).toString() + <span class="stringliteral">"\n"</span> + query.value(3).toString()
02268         + <span class="stringliteral">"\n"</span> + query.value(4).toString());
02269     }
02270     cosList.sort();
02271 
02272     query.prepare(<span class="stringliteral">"SELECT * FROM incomeRetailExpenses"</span>);
02273     query.exec();
02274     <span class="keywordflow">while</span>(query.next())
02275     {
02276         expensesList &lt;&lt; (query.value(0).toString() + <span class="stringliteral">"\n"</span> + query.value(1).toString()
02277         + <span class="stringliteral">"\n"</span> + query.value(2).toString() + <span class="stringliteral">"\n"</span> + query.value(3).toString()
02278         + <span class="stringliteral">"\n"</span> + query.value(4).toString());
02279     }
02280     expensesList.sort();
02281 
02282     QString incomeBalance;
02283     QString incomeBalanceSingle;
02284     QString cosBalance;
02285     QString cosBalanceSingle;
02286     QString expensesBalance;
02287     QString expensesBalanceSingle;
02288     QString accountBalance;
02289     QString accountBalanceSingle;
02290 
02291     QString type;
02292     QString desc;
02293     QString accountBegin;
02294     QString accountEnd;
02295 
02296     QRegExp regexp(<span class="stringliteral">".*\n(.*)\n(.*)\n(.*)\n(.*)"</span>);
02297 
02298     incomeBalance = <span class="stringliteral">"0.00"</span>;
02299     incomeBalanceSingle = <span class="stringliteral">"0.00"</span>;
02300     <span class="keywordflow">for</span>(QStringList::Iterator listIt = incomeList.begin(); listIt != incomeList.end(); ++listIt)
02301     {
02302         regexp.search(*listIt);
02303         type = regexp.cap(1);
02304         desc = regexp.cap(2);
02305         accountBegin = regexp.cap(3);
02306         accountEnd = regexp.cap(4);
02307 
02308         accountBalance = <span class="stringliteral">"0.00"</span>;
02309         accountBalanceSingle = <span class="stringliteral">"0.00"</span>;
02310         <span class="keywordflow">if</span>(type == <span class="stringliteral">"0"</span>)
02311         {
02312             query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + accountBegin);
02313             query.exec();
02314             <span class="keywordflow">while</span>(query.next())
02315             {
02316                 entryYear = query.value(0).toString().right(2);
02317 
02318                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
02319                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
02320                 <span class="keywordflow">else</span>
02321                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
02322 
02323                 entryMonth = query.value(0).toString().left(2);
02324                 entryDay = query.value(0).toString().mid(3,2);
02325 
02326                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
02327                 <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
02328                     <span class="keywordflow">continue</span>;
02329 
02330                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
02331                 {
02332                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02333                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
02334                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02335                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02336                 }
02337                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
02338                 {
02339                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02340                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
02341                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02342                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02343                 }
02344             }
02345         }
02346         <span class="keywordflow">else</span>
02347         {
02348             QStringList accounts;
02349 
02350             query.prepare(<span class="stringliteral">"SELECT id FROM accounts"</span>);
02351             query.exec();
02352             <span class="keywordflow">while</span>(query.next())
02353             {
02354                 <span class="keywordflow">if</span>(query.value(0).toInt() &gt;= accountBegin.toInt()
02355                    &amp;&amp; query.value(0).toInt() &lt;= accountEnd.toInt())
02356                     accounts &lt;&lt; query.value(0).toString();
02357             }
02358 
02359             <span class="keywordflow">for</span>(QStringList::Iterator it = accounts.begin(); it != accounts.end(); ++it)
02360             {
02361                 query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + *it);
02362                 query.exec();
02363                 <span class="keywordflow">while</span>(query.next())
02364                 {
02365                     entryYear = query.value(0).toString().right(2);
02366 
02367                     <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
02368                         entryYear.insert(0, <span class="stringliteral">"20"</span>);
02369                     <span class="keywordflow">else</span>
02370                         entryYear.insert(0, <span class="stringliteral">"19"</span>);
02371 
02372                     entryMonth = query.value(0).toString().left(2);
02373                     entryDay = query.value(0).toString().mid(3,2);
02374 
02375                     entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
02376                     <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
02377                         <span class="keywordflow">continue</span>;
02378 
02379                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
02380                     {
02381                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02382                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
02383                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02384                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02385                     }
02386                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
02387                     {
02388                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02389                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
02390                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02391                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02392                     }
02393                 }
02394             }
02395         }
02396 
02397         incomeBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(accountBalance));
02398         incomeBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(accountBalanceSingle));
02399 
02400         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"50%\"&gt;"</span> + desc + <span class="stringliteral">"&lt;/td&gt;"</span>
02401                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalanceSingle) + <span class="stringliteral">"&lt;/td&gt;"</span>
02402                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02403         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += desc + <span class="stringliteral">","</span> + accountBalanceSingle + <span class="stringliteral">","</span> + accountBalance + <span class="stringliteral">"\n"</span>;
02404     }
02405 
02406     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02407     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td align=\"right\" width=\"50%\"&gt;&lt;b&gt;Total Income&lt;/b&gt;&lt;/td&gt;"</span>
02408             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(incomeBalanceSingle) + <span class="stringliteral">"&lt;/b&gt;"</span>
02409                 <span class="stringliteral">"&lt;br&gt;&lt;img src=\""</span> + ICON_PATH + <span class="stringliteral">"/underline_single.gif\" width=\"80\" height=\"1\"&gt;&lt;/td&gt;"</span>
02410             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(incomeBalance) + <span class="stringliteral">"&lt;/b&gt;"</span>
02411                 <span class="stringliteral">"&lt;br&gt;&lt;img src=\""</span> + ICON_PATH + <span class="stringliteral">"/underline_single.gif\" width=\"80\" height=\"1\"&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02412     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02413     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Total Income,"</span> + incomeBalanceSingle + <span class="stringliteral">","</span> + incomeBalance + <span class="stringliteral">"\n\n"</span>;
02414 
02415 
02416     cosBalance = <span class="stringliteral">"0.00"</span>;
02417     cosBalanceSingle = <span class="stringliteral">"0.00"</span>;
02418     <span class="keywordflow">for</span>(QStringList::Iterator listIt = cosList.begin(); listIt != cosList.end(); ++listIt)
02419     {
02420         regexp.search(*listIt);
02421         type = regexp.cap(1);
02422         desc = regexp.cap(2);
02423         accountBegin = regexp.cap(3);
02424         accountEnd = regexp.cap(4);
02425 
02426         accountBalance = <span class="stringliteral">"0.00"</span>;
02427         accountBalanceSingle = <span class="stringliteral">"0.00"</span>;
02428         <span class="keywordflow">if</span>(type == <span class="stringliteral">"0"</span>)
02429         {
02430             query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + accountBegin);
02431             query.exec();
02432             <span class="keywordflow">while</span>(query.next())
02433             {
02434                 entryYear = query.value(0).toString().right(2);
02435 
02436                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
02437                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
02438                 <span class="keywordflow">else</span>
02439                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
02440 
02441                 entryMonth = query.value(0).toString().left(2);
02442                 entryDay = query.value(0).toString().mid(3,2);
02443 
02444                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
02445                 <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
02446                     <span class="keywordflow">continue</span>;
02447 
02448                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
02449                 {
02450                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02451                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
02452                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02453                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02454                 }
02455                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
02456                 {
02457                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02458                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
02459                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02460                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02461                 }
02462             }
02463         }
02464         <span class="keywordflow">else</span>
02465         {
02466             QStringList accounts;
02467 
02468             query.prepare(<span class="stringliteral">"SELECT id FROM accounts"</span>);
02469             query.exec();
02470             <span class="keywordflow">while</span>(query.next())
02471             {
02472                 <span class="keywordflow">if</span>(query.value(0).toInt() &gt;= accountBegin.toInt()
02473                    &amp;&amp; query.value(0).toInt() &lt;= accountEnd.toInt())
02474                     accounts &lt;&lt; query.value(0).toString();
02475             }
02476 
02477             <span class="keywordflow">for</span>(QStringList::Iterator it = accounts.begin(); it != accounts.end(); ++it)
02478             {
02479                 query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + *it);
02480                 query.exec();
02481                 <span class="keywordflow">while</span>(query.next())
02482                 {
02483                     entryYear = query.value(0).toString().right(2);
02484 
02485                     <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
02486                         entryYear.insert(0, <span class="stringliteral">"20"</span>);
02487                     <span class="keywordflow">else</span>
02488                         entryYear.insert(0, <span class="stringliteral">"19"</span>);
02489 
02490                     entryMonth = query.value(0).toString().left(2);
02491                     entryDay = query.value(0).toString().mid(3,2);
02492 
02493                     entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
02494                     <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
02495                         <span class="keywordflow">continue</span>;
02496 
02497                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
02498                     {
02499                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02500                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
02501                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02502                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02503                     }
02504                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
02505                     {
02506                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02507                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
02508                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02509                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02510                     }
02511                 }
02512             }
02513         }
02514 
02515         cosBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(cosBalance, accountBalance);
02516         cosBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(cosBalanceSingle, accountBalanceSingle);
02517 
02518         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"50%\"&gt;"</span> + desc + <span class="stringliteral">"&lt;/td&gt;"</span>
02519                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalanceSingle) + <span class="stringliteral">"&lt;/td&gt;"</span>
02520                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02521         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += desc + <span class="stringliteral">","</span> + accountBalanceSingle + <span class="stringliteral">","</span> + accountBalance + <span class="stringliteral">"\n"</span>;
02522     }
02523 
02524     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02525     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td align=\"right\" width=\"50%\"&gt;&lt;b&gt;Total Cost of Sales&lt;/b&gt;&lt;/td&gt;"</span>
02526             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(cosBalanceSingle) + <span class="stringliteral">"&lt;/b&gt;"</span>
02527                 <span class="stringliteral">"&lt;br&gt;&lt;img src=\""</span> + ICON_PATH + <span class="stringliteral">"/underline_single.gif\" width=\"80\" height=\"1\"&gt;&lt;/td&gt;"</span>
02528             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(cosBalance) + <span class="stringliteral">"&lt;/b&gt;"</span>
02529                 <span class="stringliteral">"&lt;br&gt;&lt;img src=\""</span> + ICON_PATH + <span class="stringliteral">"/underline_single.gif\" width=\"80\" height=\"1\"&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02530     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td align=\"right\" width=\"50%\"&gt;&lt;b&gt;Gross Profit&lt;/b&gt;&lt;/td&gt;"</span>
02531             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(
02532                                                       <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(cosBalanceSingle)))
02533                                                     + <span class="stringliteral">"&lt;/b&gt;"</span>
02534                                                         <span class="stringliteral">"&lt;br&gt;&lt;img src=\""</span> + ICON_PATH + 
02535                                                         <span class="stringliteral">"/underline_single.gif\" width=\"80\" height=\"1\"&gt;&lt;/td&gt;"</span>
02536             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(
02537                                                       <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(cosBalance)))
02538                                                     + <span class="stringliteral">"&lt;/b&gt;"</span>
02539                                                         <span class="stringliteral">"&lt;br&gt;&lt;img src=\""</span> + ICON_PATH +
02540                                                         <span class="stringliteral">"/underline_single.gif\" width=\"80\" height=\"1\"&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02541     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02542     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Total Cost of Sales,"</span> + cosBalanceSingle + <span class="stringliteral">","</span> + cosBalance + <span class="stringliteral">"\n"</span>;
02543     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Gross Profit,"</span> + <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(cosBalanceSingle))
02544                 + <span class="stringliteral">","</span> + <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(cosBalance)) + <span class="stringliteral">"\n\n"</span>;
02545 
02546 
02547     expensesBalance = <span class="stringliteral">"0.00"</span>;
02548     expensesBalanceSingle = <span class="stringliteral">"0.00"</span>;
02549     <span class="keywordflow">for</span>(QStringList::Iterator listIt = expensesList.begin(); listIt != expensesList.end(); ++listIt)
02550     {
02551         regexp.search(*listIt);
02552         type = regexp.cap(1);
02553         desc = regexp.cap(2);
02554         accountBegin = regexp.cap(3);
02555         accountEnd = regexp.cap(4);
02556 
02557         accountBalance = <span class="stringliteral">"0.00"</span>;
02558         accountBalanceSingle = <span class="stringliteral">"0.00"</span>;
02559         <span class="keywordflow">if</span>(type == <span class="stringliteral">"0"</span>)
02560         {
02561             query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + accountBegin);
02562             query.exec();
02563             <span class="keywordflow">while</span>(query.next())
02564             {
02565                 entryYear = query.value(0).toString().right(2);
02566 
02567                 <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
02568                     entryYear.insert(0, <span class="stringliteral">"20"</span>);
02569                 <span class="keywordflow">else</span>
02570                     entryYear.insert(0, <span class="stringliteral">"19"</span>);
02571 
02572                 entryMonth = query.value(0).toString().left(2);
02573                 entryDay = query.value(0).toString().mid(3,2);
02574 
02575                 entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
02576                 <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
02577                     <span class="keywordflow">continue</span>;
02578 
02579                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
02580                 {
02581                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02582                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
02583                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02584                         accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02585                 }
02586                 <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
02587                 {
02588                     <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02589                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
02590                     <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02591                         accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02592                 }
02593             }
02594         }
02595         <span class="keywordflow">else</span>
02596         {
02597             QStringList accounts;
02598 
02599             query.prepare(<span class="stringliteral">"SELECT id FROM accounts"</span>);
02600             query.exec();
02601             <span class="keywordflow">while</span>(query.next())
02602             {
02603                 <span class="keywordflow">if</span>(query.value(0).toInt() &gt;= accountBegin.toInt()
02604                    &amp;&amp; query.value(0).toInt() &lt;= accountEnd.toInt())
02605                     accounts &lt;&lt; query.value(0).toString();
02606             }
02607 
02608             <span class="keywordflow">for</span>(QStringList::Iterator it = accounts.begin(); it != accounts.end(); ++it)
02609             {
02610                 query.prepare(<span class="stringliteral">"SELECT date, debit, credit FROM journal WHERE account = "</span> + *it);
02611                 query.exec();
02612                 <span class="keywordflow">while</span>(query.next())
02613                 {
02614                     entryYear = query.value(0).toString().right(2);
02615 
02616                     <span class="keywordflow">if</span>(entryYear.toInt() &lt; (curDate.toString(<span class="stringliteral">"yy"</span>).toInt() + 2))
02617                         entryYear.insert(0, <span class="stringliteral">"20"</span>);
02618                     <span class="keywordflow">else</span>
02619                         entryYear.insert(0, <span class="stringliteral">"19"</span>);
02620 
02621                     entryMonth = query.value(0).toString().left(2);
02622                     entryDay = query.value(0).toString().mid(3,2);
02623 
02624                     entryDate.setYMD(entryYear.toInt(), entryMonth.toInt(), entryDay.toInt());
02625                     <span class="keywordflow">if</span>(entryDate &gt; periodEndDate || entryDate &lt; periodBeginDate)
02626                         <span class="keywordflow">continue</span>;
02627 
02628                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginDate)
02629                     {
02630                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02631                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, query.value(1).toString());
02632                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02633                             accountBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02634                     }
02635                     <span class="keywordflow">if</span>(entryDate &gt;= periodBeginSingleDate)
02636                     {
02637                         <span class="keywordflow">if</span>(query.value(1).toString() != <span class="stringliteral">""</span>)
02638                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, query.value(1).toString());
02639                         <span class="keywordflow">if</span>(query.value(2).toString() != <span class="stringliteral">""</span>)
02640                             accountBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(accountBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(query.value(2).toString()));
02641                     }
02642                 }
02643             }
02644         }
02645 
02646         expensesBalance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(expensesBalance, accountBalance);
02647         expensesBalanceSingle = <a class="code" href="classDatabase.html#a46">addCurrency</a>(expensesBalanceSingle, accountBalanceSingle);
02648 
02649         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td width=\"50%\"&gt;"</span> + desc + <span class="stringliteral">"&lt;/td&gt;"</span>
02650                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalanceSingle) + <span class="stringliteral">"&lt;/td&gt;"</span>
02651                 <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(accountBalance) + <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02652         <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += desc + <span class="stringliteral">","</span> + accountBalanceSingle + <span class="stringliteral">","</span> + accountBalance + <span class="stringliteral">"\n"</span>;
02653     }
02654 
02655     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02656     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td align=\"right\" width=\"50%\"&gt;&lt;b&gt;Total Expenses&lt;/b&gt;&lt;/td&gt;"</span>
02657             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(expensesBalanceSingle) + <span class="stringliteral">"&lt;/b&gt;"</span>
02658                 <span class="stringliteral">"&lt;br&gt;&lt;img src=\""</span> + ICON_PATH + <span class="stringliteral">"/underline_single.gif\" width=\"80\" height=\"1\"&gt;&lt;/td&gt;"</span>
02659             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(expensesBalance) + <span class="stringliteral">"&lt;/b&gt;"</span>
02660                 <span class="stringliteral">"&lt;br&gt;&lt;img src=\""</span> + ICON_PATH + <span class="stringliteral">"/underline_single.gif\" width=\"80\" height=\"1\"&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02661     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td align=\"right\" width=\"50%\"&gt;&lt;b&gt;Net Income (Loss)&lt;/b&gt;&lt;/td&gt;"</span>
02662             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(
02663                                                       <a class="code" href="classDatabase.html#a46">addCurrency</a>(
02664                                                           <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(cosBalanceSingle)),
02665                                                           <a class="code" href="classDatabase.html#a47">negCurrency</a>(expensesBalanceSingle)))
02666                                                     + <span class="stringliteral">"&lt;/b&gt;&lt;br&gt;&lt;img src=\""</span>
02667                                                         + ICON_PATH +
02668                                                         <span class="stringliteral">"/underline_double.gif\" width=\"80\" height=\"3\"&gt;"</span>
02669                                                     <span class="stringliteral">"&lt;/td&gt;"</span>
02670             <span class="stringliteral">"&lt;td align=\"right\" width=\"25%\"&gt;&lt;b&gt;"</span> + <a class="code" href="classDatabase.html#a49">formatCurrency</a>(
02671                                                       <a class="code" href="classDatabase.html#a46">addCurrency</a>(
02672                                                           <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(cosBalance)),
02673                                                           <a class="code" href="classDatabase.html#a47">negCurrency</a>(expensesBalance)))
02674                                                     + <span class="stringliteral">"&lt;/b&gt;&lt;br&gt;&lt;img src=\""</span>
02675                                                         + ICON_PATH +
02676                                                         <span class="stringliteral">"/underline_double.gif\" width=\"80\" height=\"3\"&gt;"</span>
02677                                                     <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;\n"</span>;
02678     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;/td&gt;&lt;/tr&gt;\n"</span>;
02679     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Total Expenses,"</span> + expensesBalanceSingle + <span class="stringliteral">","</span> + expensesBalance + <span class="stringliteral">"\n"</span>;
02680     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a> += <span class="stringliteral">"Net Income (Loss),"</span> + <a class="code" href="classDatabase.html#a46">addCurrency</a>(
02681                                               <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalanceSingle, <a class="code" href="classDatabase.html#a47">negCurrency</a>(cosBalanceSingle)),
02682                                               <a class="code" href="classDatabase.html#a47">negCurrency</a>(expensesBalanceSingle))
02683                 + <span class="stringliteral">","</span> + <a class="code" href="classDatabase.html#a46">addCurrency</a>(
02684                             <a class="code" href="classDatabase.html#a46">addCurrency</a>(incomeBalance, <a class="code" href="classDatabase.html#a47">negCurrency</a>(cosBalance)),
02685                             <a class="code" href="classDatabase.html#a47">negCurrency</a>(expensesBalanceSingle))
02686                 + <span class="stringliteral">"\n\n"</span>;
02687 
02688 
02689     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> += <span class="stringliteral">"&lt;/table&gt;&lt;/center&gt;"</span>;
02690 
02691     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a> = <span class="stringliteral">"&lt;qt&gt;"</span> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a> + <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a> + <span class="stringliteral">"&lt;/qt&gt;"</span>;
02692 
02693     <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o4">html</a> = <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a>.replace(
02694             <span class="stringliteral">"&lt;qt&gt;"</span>, <span class="stringliteral">"&lt;html&gt;&lt;head&gt;&lt;title&gt;"</span> + <a class="code" href="classDatabase.html#r3">curClient</a> +
02695             <span class="stringliteral">" - Income Statement Retail&lt;/title&gt;&lt;/head&gt;&lt;/body&gt;\n"</span>).replace(
02696                     <span class="stringliteral">"&lt;/qt&gt;"</span>, <span class="stringliteral">"&lt;/body&gt;&lt;/html&gt;"</span>);
02697 
02698     <span class="keywordflow">return</span> <span class="keyword">this</span>;
02699 }
02700 
<a name="l02701"></a><a class="code" href="classDatabase.html#a29">02701</a> QString&amp; <a class="code" href="classDatabase.html#a29">Database::reportHeader</a>()
02702 {
02703     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o0">header</a>;
02704 }
02705 
<a name="l02706"></a><a class="code" href="classDatabase.html#a30">02706</a> QString&amp; <a class="code" href="classDatabase.html#a30">Database::reportData</a>()
02707 {
02708     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o1">data</a>;
02709 }
02710 
<a name="l02711"></a><a class="code" href="classDatabase.html#a31">02711</a> QString&amp; <a class="code" href="classDatabase.html#a31">Database::reportString</a>()
02712 {
02713     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o2">string</a>;
02714 }
02715 
<a name="l02716"></a><a class="code" href="classDatabase.html#a32">02716</a> QString&amp; <a class="code" href="classDatabase.html#a32">Database::reportCSV</a>()
02717 {
02718     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o3">csv</a>;
02719 }
02720 
<a name="l02721"></a><a class="code" href="classDatabase.html#a33">02721</a> QString&amp; <a class="code" href="classDatabase.html#a33">Database::reportHTML</a>()
02722 {
02723     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#r5">report</a>-&gt;<a class="code" href="structDatabase_1_1ReportStruct.html#o4">html</a>;
02724 }
02725 
<a name="l02726"></a><a class="code" href="classDatabase.html#a34">02726</a> QString&amp; <a class="code" href="classDatabase.html#a34">Database::journalTmpReportHeader</a>()
02727 {
02728     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o0">header</a>;
02729 }
02730 
<a name="l02731"></a><a class="code" href="classDatabase.html#a35">02731</a> QString&amp; <a class="code" href="classDatabase.html#a35">Database::journalTmpReportData</a>()
02732 {
02733     <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#r6">journalTmpReport</a>-&gt;<a class="code" href="structDatabase_1_1JournalTmpReport.html#o1">data</a>;
02734 }
02735 
<a name="l02736"></a><a class="code" href="classDatabase.html#a36">02736</a> QStringList&amp; <a class="code" href="classDatabase.html#a36">Database::getAccountsList</a>()
02737 {
02738     <a class="code" href="classDatabase.html#r7">accountsList</a>-&gt;clear();
02739     
02740     QSqlQuery query(<span class="stringliteral">"SELECT * FROM accounts ORDER BY id"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
02741     <span class="keywordflow">while</span>(query.next())
02742         <a class="code" href="classDatabase.html#r7">accountsList</a>-&gt;append(query.value(1).toString() + <span class="stringliteral">" - "</span> + query.value(2).toString());
02743 
02744     <span class="keywordflow">return</span> *<a class="code" href="classDatabase.html#r7">accountsList</a>;
02745     
02746 }
02747 
<a name="l02748"></a><a class="code" href="classDatabase.html#a37">02748</a> QPtrList&lt;QStringList&gt;* <a class="code" href="classDatabase.html#a37">Database::getAccountsData</a>()
02749 {
02750     QPtrList&lt;QStringList&gt;* data = <span class="keyword">new</span> QPtrList&lt;QStringList&gt;;
02751     
02752     QSqlQuery query(<span class="stringliteral">"SELECT * FROM accounts ORDER BY id"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
02753     <span class="keywordflow">while</span>(query.next())
02754     {
02755         QStringList *list = <span class="keyword">new</span> QStringList;
02756         *list &lt;&lt; query.value(0).toString() &lt;&lt; query.value(1).toString()
02757                 &lt;&lt; query.value(2).toString() &lt;&lt; query.value(3).toString();
02758         data-&gt;append(list);
02759     }
02760     <span class="keywordflow">return</span> data;
02761 }
02762 
<a name="l02763"></a><a class="code" href="classDatabase.html#a38">02763</a> QPtrList&lt;QStringList&gt;* <a class="code" href="classDatabase.html#a38">Database::getJournalTmpData</a>()
02764 {
02765     QPtrList&lt;QStringList&gt;* data = <span class="keyword">new</span> QPtrList&lt;QStringList&gt;;
02766     
02767     QSqlQuery query(<span class="stringliteral">"SELECT * FROM journalTmp ORDER BY key"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
02768     <span class="keywordflow">while</span>(query.next())
02769     {
02770         QStringList *list = <span class="keyword">new</span> QStringList;
02771         *list &lt;&lt; query.value(0).toString() &lt;&lt; query.value(1).toString() &lt;&lt; query.value(2).toString()
02772                 &lt;&lt; query.value(3).toString() &lt;&lt; query.value(4).toString() &lt;&lt; query.value(5).toString()
02773                 &lt;&lt; query.value(6).toString();
02774         data-&gt;append(list);
02775     }
02776     <span class="keywordflow">return</span> data;
02777 }
02778 
<a name="l02779"></a><a class="code" href="classDatabase.html#a39">02779</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a39">Database::updateAccount</a>(QString key, QString <span class="keywordtype">id</span>, QString desc)
02780 {
02781     QSqlQuery query(<span class="stringliteral">"SELECT key FROM accounts WHERE key = "</span> + key, <a class="code" href="classDatabase.html#r2">connection</a>);
02782     
02783     QString queryString;
02784     
02785     <span class="keywordflow">if</span>(query.first())
02786         queryString = <span class="stringliteral">"UPDATE accounts SET id = "</span> + <span class="keywordtype">id</span> + <span class="stringliteral">", desc = \""</span> + desc + <span class="stringliteral">"\" WHERE key = "</span> + key;
02787     <span class="keywordflow">else</span>
02788         queryString = <span class="stringliteral">"INSERT INTO accounts VALUES(\""</span> + key + <span class="stringliteral">"\", \""</span> + <span class="keywordtype">id</span> + <span class="stringliteral">"\", \""</span> + desc + <span class="stringliteral">"\")"</span>;
02789     
02790     query.prepare(queryString);
02791     query.exec();
02792     
02793     emit <a class="code" href="classDatabase.html#l0">accountsChanged</a>();
02794 }
02795 
<a name="l02796"></a><a class="code" href="classDatabase.html#a40">02796</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a40">Database::deleteAccount</a>(QString key)
02797 {
02798     QSqlQuery query(<span class="stringliteral">"DELETE FROM accounts WHERE key = \""</span> + key + <span class="stringliteral">"\""</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
02799     
02800     emit <a class="code" href="classDatabase.html#l0">accountsChanged</a>();
02801 }
02802 
<a name="l02803"></a><a class="code" href="classDatabase.html#a41">02803</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a41">Database::updateJournalTmp</a>(QString key, QString date, QString account,
02804                                 QString reference, QString desc, QString debit, QString credit)
02805 {
02806     QSqlQuery query(<span class="stringliteral">"SELECT key FROM journalTmp WHERE key = "</span> + key, <a class="code" href="classDatabase.html#r2">connection</a>);
02807     
02808     QString queryString;
02809     
02810     <span class="keywordflow">if</span>(query.first())
02811         queryString = <span class="stringliteral">"UPDATE journalTmp SET date = \""</span> + date + <span class="stringliteral">"\", account = \""</span> + account +
02812                 <span class="stringliteral">"\", reference = \""</span> + reference + <span class="stringliteral">"\", desc = \""</span> + desc + <span class="stringliteral">"\", debit = \""</span> +
02813                 debit + <span class="stringliteral">"\", credit = \""</span> + credit + <span class="stringliteral">"\" WHERE key =  "</span> + key;
02814     <span class="keywordflow">else</span>
02815         queryString = <span class="stringliteral">"INSERT INTO journalTmp VALUES(\""</span> + key + <span class="stringliteral">"\", \""</span> + date + <span class="stringliteral">"\", \""</span> +
02816                 account + <span class="stringliteral">"\", \""</span> + reference + <span class="stringliteral">"\", \""</span> + desc + <span class="stringliteral">"\", \""</span> + debit +
02817                 <span class="stringliteral">"\", \""</span> + credit + <span class="stringliteral">"\")"</span>;
02818     
02819     query.prepare(queryString);
02820     query.exec();
02821     
02822     emit <a class="code" href="classDatabase.html#l1">journalTmpChanged</a>();
02823 }
02824 
<a name="l02825"></a><a class="code" href="classDatabase.html#a42">02825</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a42">Database::deleteJournalTmp</a>(QString key)
02826 {
02827     QSqlQuery query(<span class="stringliteral">"DELETE FROM journalTmp WHERE key = "</span> + key, <a class="code" href="classDatabase.html#r2">connection</a>);
02828 }
02829 
<a name="l02830"></a><a class="code" href="classDatabase.html#a43">02830</a> QString <a class="code" href="classDatabase.html#a43">Database::journalTmpDebit</a>()
02831 {
02832     QString debit(<span class="stringliteral">"0.00"</span>);
02833     
02834     QSqlQuery query(<span class="stringliteral">"SELECT debit FROM journalTmp"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
02835     
02836     <span class="keywordflow">while</span>(query.next())
02837         debit = <a class="code" href="classDatabase.html#a46">addCurrency</a>(debit, query.value(0).toString());
02838     
02839     <span class="keywordflow">return</span> debit;
02840 }
02841 
<a name="l02842"></a><a class="code" href="classDatabase.html#a44">02842</a> QString <a class="code" href="classDatabase.html#a44">Database::journalTmpCredit</a>()
02843 {
02844     QString credit(<span class="stringliteral">"0.00"</span>);
02845     
02846     QSqlQuery query(<span class="stringliteral">"SELECT credit FROM journalTmp"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
02847     
02848     <span class="keywordflow">while</span>(query.next())
02849         credit = <a class="code" href="classDatabase.html#a46">addCurrency</a>(credit, query.value(0).toString());
02850     
02851     <span class="keywordflow">return</span> credit;
02852 }
02853 
<a name="l02854"></a><a class="code" href="classDatabase.html#a45">02854</a> QString <a class="code" href="classDatabase.html#a45">Database::journalTmpBalance</a>()
02855 {
02856     QString balance;
02857     
02858     balance = <a class="code" href="classDatabase.html#a46">addCurrency</a>(<a class="code" href="classDatabase.html#a43">journalTmpDebit</a>(), <a class="code" href="classDatabase.html#a44">journalTmpCredit</a>().insert(0, <span class="stringliteral">"-"</span>));
02859     
02860     <span class="keywordflow">return</span> balance;
02861 }
02862 
<a name="l02863"></a><a class="code" href="classDatabase.html#a46">02863</a> QString <a class="code" href="classDatabase.html#a46">Database::addCurrency</a>(QString base, QString add)<span class="keyword"> const</span>
02864 <span class="keyword"></span>{
02865     <span class="comment">// code adopted from "moncls.h" by donpa@linuxledgers.com</span>
02866     
02867     QString resultCents;
02868     QString resultDollars;
02869     <span class="keywordtype">int</span> cents;
02870     <span class="keywordtype">int</span> dollars;
02871     
02872     QString baseCents;
02873     QString baseDollars;
02874     QString addCents;
02875     QString addDollars;
02876     
02877     baseCents = base.right(2);
02878     base.truncate(base.length() - 3);
02879     baseDollars = base;
02880     
02881     addCents = add.right(2);
02882     add.truncate(add.length() - 3);
02883     addDollars = add;
02884     
02885     <span class="keywordflow">if</span>(baseDollars.left(1) == <span class="stringliteral">"-"</span>)
02886     {
02887         baseCents.setNum(baseCents.toInt() + 100);
02888         baseCents.insert(0, <span class="stringliteral">"-"</span>);
02889         baseDollars.setNum(baseDollars.toInt() + 1);
02890     }
02891     <span class="keywordflow">if</span>(addDollars.left(1) == <span class="stringliteral">"-"</span>)
02892     {
02893         addCents.setNum(addCents.toInt() + 100);
02894         addCents.insert(0, <span class="stringliteral">"-"</span>);
02895         addDollars.setNum(addDollars.toInt() + 1);
02896     }
02897     
02898     dollars = (baseDollars.toInt() + addDollars.toInt());
02899     cents = (baseCents.toInt() + addCents.toInt());
02900     
02901     <span class="keywordflow">while</span>(dollars &gt; 0 &amp;&amp; cents &lt; 0)
02902     {
02903         dollars -= 1;
02904         cents += 100;
02905     }
02906     <span class="keywordflow">while</span>(cents &gt;= 100)
02907     {
02908         dollars += 1;
02909         cents -= 100;
02910     }
02911     <span class="keywordflow">while</span>(cents &lt;= -100)
02912     {
02913         dollars -= 1;
02914         cents += 100;
02915     }
02916 
02917     resultDollars.setNum(dollars);
02918 
02919     <span class="keywordflow">if</span>(cents &lt; 0)
02920     {
02921         cents = 0 - cents;
02922         <span class="keywordflow">if</span>(dollars &gt;= 0)
02923             resultDollars.insert(0, <span class="stringliteral">"-"</span>);
02924     }
02925 
02926     resultCents.setNum(cents);
02927 
02928     <span class="keywordflow">if</span>(cents &lt; 10)
02929         resultCents.insert(0, <span class="stringliteral">"0"</span>);
02930     
02931     <span class="keywordflow">return</span> QString(resultDollars + <span class="stringliteral">"."</span> + resultCents);   
02932 }
02933 
<a name="l02934"></a><a class="code" href="classDatabase.html#a47">02934</a> QString <a class="code" href="classDatabase.html#a47">Database::negCurrency</a>(QString currency)<span class="keyword"> const</span>
02935 <span class="keyword"></span>{
02936     QString result(currency);
02937 
02938     <span class="keywordflow">if</span>(result.left(1) == <span class="stringliteral">"-"</span>)
02939         result = result.mid(1);
02940     <span class="keywordflow">else</span>
02941         result = <span class="stringliteral">"-"</span> + result;
02942 
02943     <span class="keywordflow">return</span> result;
02944 }
02945 
<a name="l02946"></a><a class="code" href="classDatabase.html#a48">02946</a> QString <a class="code" href="classDatabase.html#a48">Database::addCommas</a>(QString currency)<span class="keyword"> const</span>
02947 <span class="keyword"></span>{
02948     <span class="keywordtype">bool</span> neg = <span class="keyword">false</span>;
02949     QString result;
02950     <span class="keywordflow">if</span>(currency.left(1) == <span class="stringliteral">"-"</span>)
02951     {
02952         neg = <span class="keyword">true</span>;
02953         result = currency.mid(1);
02954     }
02955     <span class="keywordflow">else</span>
02956         result = currency;
02957 
02958     std::div_t divResult = div(result.length() - 3, 3);
02959     <span class="keywordtype">int</span> start = divResult.rem;
02960     <span class="keywordtype">int</span> times = divResult.quot;
02961 
02962     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; times; i++)
02963     {
02964         <span class="keywordflow">if</span>(start == 0)
02965             <span class="keywordflow">continue</span>;
02966 
02967         result.insert(start + i, <span class="stringliteral">","</span>);
02968 
02969         start += 3;
02970     }
02971 
02972     <span class="keywordflow">if</span>(neg)
02973         <span class="keywordflow">return</span> <a class="code" href="classDatabase.html#a47">negCurrency</a>(result);
02974     <span class="keywordflow">else</span>
02975         <span class="keywordflow">return</span> result;
02976 }
02977 
<a name="l02978"></a><a class="code" href="classDatabase.html#a49">02978</a> QString <a class="code" href="classDatabase.html#a49">Database::formatCurrency</a>(QString currency)<span class="keyword"> const</span>
02979 <span class="keyword"></span>{
02980     QString result = <a class="code" href="classDatabase.html#a48">addCommas</a>(currency);
02981 
02982     <span class="keywordflow">if</span>(result.left(1) == <span class="stringliteral">"-"</span>)
02983         result = <span class="stringliteral">"("</span> + result.mid(1) + <span class="stringliteral">")"</span>;
02984 
02985     <span class="keywordflow">return</span> result;
02986 }
02987 
<a name="l02988"></a><a class="code" href="classDatabase.html#a50">02988</a> <span class="keywordtype">void</span> <a class="code" href="classDatabase.html#a50">Database::commitJournalTmp</a>()
02989 {
02990     QStringList data;
02991     
02992     QSqlQuery query(<span class="stringliteral">"SELECT * FROM journalTmp"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
02993     <span class="keywordflow">while</span>(query.next())
02994     {
02995         data &lt;&lt; (<span class="stringliteral">"\""</span> + query.value(1).toString() + <span class="stringliteral">"\", \""</span> + query.value(2).toString()
02996                 + <span class="stringliteral">"\", \""</span> + query.value(3).toString() + <span class="stringliteral">"\", \""</span> + query.value(4).toString()
02997                 + <span class="stringliteral">"\", \""</span> + query.value(5).toString() + <span class="stringliteral">"\", \""</span> + query.value(6).toString() + <span class="stringliteral">"\""</span>);
02998     }
02999     
03000     <span class="keywordflow">for</span>(QStringList::Iterator it = data.begin(); it != data.end(); ++it)
03001     {
03002         query.prepare(<span class="stringliteral">"INSERT INTO journal VALUES("</span> + *it + <span class="stringliteral">")"</span>);
03003         query.exec();
03004     }
03005     
03006     query.prepare(<span class="stringliteral">"DROP TABLE journalTmp"</span>);
03007     query.exec();
03008     
03009     query.prepare(<span class="stringliteral">"CREATE TABLE journalTmp (key, date, account, reference, "</span>
03010             <span class="stringliteral">"desc, debit, credit, PRIMARY KEY (key))"</span>);
03011     query.exec();
03012     
03013     emit <a class="code" href="classDatabase.html#l1">journalTmpChanged</a>();
03014 }
03015 
<a name="l03016"></a><a class="code" href="classDatabase.html#a51">03016</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#a51">Database::journalTmpEmpty</a>()
03017 {
03018     QSqlQuery query(<span class="stringliteral">"SELECT * FROM journalTmp"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
03019     <span class="keywordflow">if</span>(query.next())
03020         <span class="keywordflow">return</span> <span class="keyword">false</span>;
03021     <span class="keywordflow">else</span>
03022         <span class="keywordflow">return</span> <span class="keyword">true</span>;
03023 }
03024 
<a name="l03025"></a><a class="code" href="classDatabase.html#a52">03025</a> QString <a class="code" href="classDatabase.html#a52">Database::nextAccountKey</a>()
03026 {
03027     QSqlQuery query(<span class="stringliteral">"SELECT MAX(key) FROM accounts"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
03028     
03029     <span class="keywordtype">int</span> key = 0;
03030     <span class="keywordflow">if</span>(query.first())
03031         key = query.value(0).toInt();
03032     
03033     <span class="keywordflow">return</span> QString::number(++key);
03034 }
03035 
<a name="l03036"></a><a class="code" href="classDatabase.html#a53">03036</a> QString <a class="code" href="classDatabase.html#a53">Database::nextJournalTmpKey</a>()
03037 {
03038     QSqlQuery query(<span class="stringliteral">"SELECT MAX(key) FROM journalTmp"</span>, <a class="code" href="classDatabase.html#r2">connection</a>);
03039     
03040     <span class="keywordtype">int</span> key = 0;
03041     <span class="keywordflow">if</span>(query.first())
03042         key = query.value(0).toInt();
03043     
03044     <span class="keywordflow">return</span> QString::number(++key);
03045 }
03046 
<a name="l03047"></a><a class="code" href="classDatabase.html#a54">03047</a> QString <a class="code" href="classDatabase.html#a54">Database::getAccountDesc</a>(QString account)
03048 {
03049     QSqlQuery query(<span class="stringliteral">"SELECT desc FROM accounts WHERE id = "</span> + account, <a class="code" href="classDatabase.html#r2">connection</a>);
03050     <span class="keywordflow">if</span>(query.next())
03051         <span class="keywordflow">return</span> query.value(0).toString();
03052     <span class="keywordflow">else</span>
03053         <span class="keywordflow">return</span> QString::null;
03054 }
03055 
<a name="l03056"></a><a class="code" href="classDatabase.html#a55">03056</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#a55">Database::accountExists</a>(QString account)
03057 {
03058     QSqlQuery query(<span class="stringliteral">"SELECT * FROM accounts WHERE id = "</span> + account, <a class="code" href="classDatabase.html#r2">connection</a>);
03059     <span class="keywordflow">if</span>(query.first())
03060         <span class="keywordflow">return</span> <span class="keyword">true</span>;
03061     <span class="keywordflow">else</span>
03062         <span class="keywordflow">return</span> <span class="keyword">false</span>;
03063 }
03064 
<a name="l03065"></a><a class="code" href="classDatabase.html#a56">03065</a> <span class="keywordtype">bool</span> <a class="code" href="classDatabase.html#a56">Database::accountHasEntries</a>(QString account)
03066 {
03067     QSqlQuery query(<span class="stringliteral">"SELECT * FROM journal WHERE account = "</span> + account, <a class="code" href="classDatabase.html#r2">connection</a>);
03068     <span class="keywordflow">if</span>(query.first())
03069         <span class="keywordflow">return</span> <span class="keyword">true</span>;
03070     <span class="keywordflow">else</span>
03071         <span class="keywordflow">return</span> <span class="keyword">false</span>;
03072 }
03073 
<a name="l03074"></a><a class="code" href="classDatabase.html#v0">03074</a> <a class="code" href="classDatabase.html">Database</a> *<a class="code" href="classDatabase.html#v0">Database::db</a> = 0;
03075 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Fri Sep 17 18:11:39 2004 for General Ledger by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
