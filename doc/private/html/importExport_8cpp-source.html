<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>General Ledger: importExport.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>importExport.cpp</h1><a href="importExport_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* General Ledger, Copyright (C) 2004  Joshua Eckroth &lt;josh@eckroth.net&gt;</span>
00002 <span class="comment"> * http://www.eckroth.net/software/genledg</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
00005 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment"> * (at your option) any later version.</span>
00008 <span class="comment"> * </span>
00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment"> * GNU General Public License for more details.</span>
00013 <span class="comment"> * </span>
00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00015 <span class="comment"> * along with this program; if not, write to the Free Software</span>
00016 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  US</span>
00017 <span class="comment">*/</span>
00018 
00019 <span class="preprocessor">#include &lt;vector&gt;</span>
00020 <span class="keyword">using</span> std::vector;
00021 
00022 <span class="preprocessor">#include &lt;qobject.h&gt;</span>
00023 <span class="preprocessor">#include &lt;qstring.h&gt;</span>
00024 <span class="preprocessor">#include &lt;qstringlist.h&gt;</span>
00025 <span class="preprocessor">#include &lt;qfiledialog.h&gt;</span>
00026 <span class="preprocessor">#include &lt;qtextstream.h&gt;</span>
00027 <span class="preprocessor">#include &lt;qdialog.h&gt;</span>
00028 <span class="preprocessor">#include &lt;qlayout.h&gt;</span>
00029 <span class="preprocessor">#include &lt;qlabel.h&gt;</span>
00030 <span class="preprocessor">#include &lt;qpushbutton.h&gt;</span>
00031 <span class="preprocessor">#include &lt;qdialog.h&gt;</span>
00032 <span class="preprocessor">#include &lt;qtable.h&gt;</span>
00033 <span class="preprocessor">#include &lt;qptrlist.h&gt;</span>
00034 <span class="preprocessor">#include &lt;qradiobutton.h&gt;</span>
00035 <span class="preprocessor">#include &lt;qvbuttongroup.h&gt;</span>
00036 
00037 <span class="preprocessor">#include "<a class="code" href="importExport_8h.html">importExport.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="settings_8h.html">settings.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="accountsData_8h.html">accountsData.h</a>"</span>
00040 <span class="preprocessor">#include "<a class="code" href="journalData_8h.html">journalData.h</a>"</span>
00041 <span class="preprocessor">#include "<a class="code" href="reportsGenerator_8h.html">reportsGenerator.h</a>"</span>
00042 <span class="preprocessor">#include "config.h"</span>
00043 
<a name="l00044"></a><a class="code" href="classImportExport.html#e0">00044</a> <span class="keywordtype">bool</span> <a class="code" href="classImportExport.html#e0">ImportExport::importCSV</a>(<span class="keyword">const</span> ImportExport::DataCategory cat)
00045 {
00046     <a class="code" href="classSettings.html">Settings</a> *settings = <a class="code" href="classSettings.html#e0">Settings::instance</a>();
00047         
00048     <a class="codeRef" doxygen="doxy-qt.tag:" href="qstring.html">QString</a> fileName = QFileDialog::getOpenFileName(
00049                     settings-&gt;<a class="code" href="classSettings.html#a5">getImportPath</a>(),
00050                     <span class="stringliteral">"Comma Separated Values (*.*)"</span>,
00051                     0, <span class="stringliteral">"importExport::import_file_dialog"</span>,
00052                     <span class="stringliteral">"Import CSV Data"</span>);
00053 
00054     <span class="keywordflow">if</span>(fileName != QString::null)
00055     {
00056         <span class="keywordtype">int</span> dirPos = fileName.findRev(<span class="stringliteral">"/"</span>);
00057         <span class="keywordflow">if</span>(dirPos == -1)
00058             dirPos = fileName.findRev(<span class="stringliteral">"\\"</span>);
00059 
00060         settings-&gt;<a class="code" href="classSettings.html#a6">setImportPath</a>(fileName.left(dirPos));
00061 
00062         <a class="codeRef" doxygen="doxy-qt.tag:" href="qfile.html">QFile</a> file(fileName);
00063         <span class="keywordflow">if</span>(file.open(IO_ReadOnly))
00064         {
00065             <a class="codeRef" doxygen="doxy-qt.tag:" href="qtextstream.html">QTextStream</a> in(&amp;file);
00066             in.setEncoding(QTextStream::Locale);
00067 
00068             <span class="comment">// Determine if the first line is data or field descriptors</span>
00069             <span class="keywordtype">bool</span> skipFirst = <span class="keyword">false</span>;
00070 
00071             <a class="codeRef" doxygen="doxy-qt.tag:" href="qstringlist.html">QStringList</a> data;
00072             <a class="codeRef" doxygen="doxy-qt.tag:" href="qptrlist.html">QPtrList&lt;QStringList&gt;</a> values;
00073             <a class="codeRef" doxygen="doxy-qt.tag:" href="qstringlist.html">QStringList</a> *list;
00074 
00075             <span class="keywordtype">int</span> i = 0;
00076             <a class="codeRef" doxygen="doxy-qt.tag:" href="qstring.html">QString</a> line;
00077             <span class="keywordflow">while</span>(!in.atEnd())
00078             {
00079                 line = in.readLine();
00080                 data &lt;&lt; line;
00081 
00082                 <span class="keywordflow">if</span>(i &lt; 3)
00083                 {
00084                     list = <span class="keyword">new</span> <a class="codeRef" doxygen="doxy-qt.tag:" href="qstringlist.html">QStringList</a>(QStringList::split(<span class="stringliteral">","</span>, line));
00085                     values.append(list);
00086                 }
00087                 ++i;
00088             }
00089             
00090             <span class="keywordflow">if</span>(!values.isEmpty())
00091             {
00092                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qdialog.html">QDialog</a> dialog;
00093                 dialog.setCaption(<span class="stringliteral">"Import CSV Data"</span>);
00094 
00095                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qvboxlayout.html">QVBoxLayout</a> vBoxLayout(&amp;dialog, 5, 5);
00096                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qlabel.html">QLabel</a> label(<span class="stringliteral">"&lt;nobr&gt;The first three records of the file "</span>
00097                              <span class="stringliteral">"are shown.&lt;/nobr&gt;&lt;br&gt;"</span>
00098                              <span class="stringliteral">"&lt;nobr&gt;Choose whether the first row is "</span>
00099                              <span class="stringliteral">"a header or data.&lt;/nobr&gt;"</span>, &amp;dialog);
00100 
00101                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qtable.html">QTable</a> dataTable(3, values.first()-&gt;count(), &amp;dialog);
00102                 dataTable.setLeftMargin(0);
00103                 dataTable.setTopMargin(0);
00104                 dataTable.setSelectionMode(QTable::NoSelection);
00105 
00106                 <span class="keywordtype">int</span> row = 0;
00107                 <span class="keywordtype">int</span> col = 0;
00108                 <span class="keywordflow">for</span>(list = values.first(); list; list = values.next())
00109                 {
00110                     col = 0;
00111                     <span class="keywordflow">for</span>(QStringList::Iterator it = list-&gt;begin();
00112                         it != list-&gt;end(); ++it)
00113                     {
00114                         dataTable.setItem(row, col,
00115                             <span class="keyword">new</span> <a class="codeRef" doxygen="doxy-qt.tag:" href="qtableitem.html">QTableItem</a>(&amp;dataTable, QTableItem::Never, *it));
00116                         ++col;
00117                     }
00118                     ++row;
00119                 }
00120                 dataTable.setColumnStretchable((col - 1), <span class="keyword">true</span>);
00121 
00122                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qvbuttongroup.html">QVButtonGroup</a> buttonGroup(&amp;dialog);
00123                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qradiobutton.html">QRadioButton</a> headerButton(<span class="stringliteral">"The first row is a header"</span>,
00124                                 &amp;buttonGroup);
00125                 headerButton.setChecked(<span class="keyword">true</span>);
00126                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qradiobutton.html">QRadioButton</a> dataButton(<span class="stringliteral">"The first row is data"</span>,
00127                                 &amp;buttonGroup);
00128                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qwidget.html">QWidget</a> okCancelWidget(&amp;dialog);
00129                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qhboxlayout.html">QHBoxLayout</a> okCancelLayout(&amp;okCancelWidget);
00130                 okCancelLayout.setSpacing(5);
00131 
00132                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qpushbutton.html">QPushButton</a> okButton(<a class="codeRef" doxygen="doxy-qt.tag:" href="qiconset.html">QIconSet</a>(QPixmap::fromMimeSource(
00133                                 ICON_PATH + <span class="stringliteral">"/okButton.png"</span>)),
00134                                 <span class="stringliteral">"OK"</span>, &amp;okCancelWidget);
00135                 connect(&amp;okButton, SIGNAL(clicked()),
00136                                 &amp;dialog, SLOT(accept()));
00137                 <a class="codeRef" doxygen="doxy-qt.tag:" href="qpushbutton.html">QPushButton</a> cancelButton(<a class="codeRef" doxygen="doxy-qt.tag:" href="qiconset.html">QIconSet</a>(QPixmap::fromMimeSource(
00138                                 ICON_PATH + <span class="stringliteral">"/cancelButton.png"</span>)),
00139                                 <span class="stringliteral">"Cancel"</span>, &amp;okCancelWidget);
00140                 connect(&amp;cancelButton, SIGNAL(clicked()),
00141                                 &amp;dialog, SLOT(reject()));
00142 
00143                 okCancelLayout.addStretch();
00144                 okCancelLayout.addWidget(&amp;okButton);
00145                 okCancelLayout.addWidget(&amp;cancelButton);
00146 
00147                 vBoxLayout.addWidget(&amp;label);
00148                 vBoxLayout.addWidget(&amp;dataTable);
00149                 vBoxLayout.addWidget(&amp;buttonGroup);
00150                 vBoxLayout.addSpacing(10);
00151                 vBoxLayout.addWidget(&amp;okCancelWidget);
00152 
00153                 <span class="keywordflow">if</span>(dialog.exec())
00154                 {
00155                     <span class="keywordflow">if</span>(headerButton.isChecked())
00156                         skipFirst = <span class="keyword">true</span>;
00157                 }
00158                 <span class="keywordflow">else</span>
00159                 {
00160                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00161                 }
00162             }
00163 
00164             file.reset();
00165             <span class="keywordflow">if</span>(skipFirst)
00166                 in.readLine();  <span class="comment">// throw-away line</span>
00167 
00168             <span class="keywordflow">if</span>(cat == <a class="code" href="classImportExport.html#w2w0">Accounts</a>)
00169             {
00170                 <a class="code" href="classAccountsData.html">AccountsData</a> *accountsData = <a class="code" href="classAccountsData.html#e0">AccountsData::instance</a>();
00171                 accountsData-&gt;<a class="code" href="classAccountsData.html#a18">importCSV</a>(in);
00172             }
00173             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cat == <a class="code" href="classImportExport.html#w2w1">JournalTmp</a>)
00174             {
00175                 <a class="code" href="classJournalData.html">JournalData</a> *journalData = <a class="code" href="classJournalData.html#e0">JournalData::instance</a>();
00176                 journalData-&gt;<a class="code" href="classJournalData.html#a19">importCSV</a>(in);
00177             }
00178 
00179             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00180         }
00181 
00182         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00183     }
00184 
00185     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00186 }
00187 
<a name="l00188"></a><a class="code" href="classImportExport.html#e1">00188</a> <span class="keywordtype">void</span> <a class="code" href="classImportExport.html#e1">ImportExport::exportCSV</a>(<span class="keyword">const</span> ImportExport::DataCategory cat)
00189 {
00190     <a class="code" href="classSettings.html">Settings</a> *settings = <a class="code" href="classSettings.html#e0">Settings::instance</a>();
00191 
00192     <a class="codeRef" doxygen="doxy-qt.tag:" href="qstring.html">QString</a> fileName = QFileDialog::getSaveFileName(
00193                     settings-&gt;<a class="code" href="classSettings.html#a3">getExportPath</a>(),
00194                     <span class="stringliteral">"Comma Separated Values (*.*)"</span>,
00195                     0, <span class="stringliteral">"importExport::export_file_dialog"</span>,
00196                     <span class="stringliteral">"Export CSV Data"</span>);
00197 
00198     <span class="keywordflow">if</span>(fileName != QString::null)
00199     {
00200         <span class="keywordtype">int</span> dirPos = fileName.findRev(<span class="stringliteral">"/"</span>);
00201         <span class="keywordflow">if</span>(dirPos == -1)
00202             dirPos = fileName.findRev(<span class="stringliteral">"\\"</span>);
00203 
00204         settings-&gt;<a class="code" href="classSettings.html#a4">setExportPath</a>(fileName.left(dirPos));
00205 
00206         <a class="codeRef" doxygen="doxy-qt.tag:" href="qfile.html">QFile</a> file(fileName);
00207 
00208         <span class="keywordflow">if</span>(file.exists())
00209         {
00210             <span class="keywordflow">if</span>(!<a class="code" href="classImportExport.html#h0">overwriteDialog</a>())
00211             {
00212                 <span class="keywordflow">return</span> <a class="code" href="classImportExport.html#e1">exportCSV</a>(cat);
00213             }
00214         }
00215         <span class="keywordflow">if</span>(file.open(IO_WriteOnly))
00216         {
00217             <a class="codeRef" doxygen="doxy-qt.tag:" href="qtextstream.html">QTextStream</a> out(&amp;file);
00218             out.setEncoding(QTextStream::Locale);
00219 
00220             <span class="keywordflow">if</span>(cat == <a class="code" href="classImportExport.html#w2w0">Accounts</a>)
00221             {
00222                 <a class="code" href="classAccountsData.html">AccountsData</a> *accountsData = <a class="code" href="classAccountsData.html#e0">AccountsData::instance</a>();
00223                 accountsData-&gt;<a class="code" href="classAccountsData.html#a19">exportCSV</a>(out);
00224             }
00225             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cat == <a class="code" href="classImportExport.html#w2w1">JournalTmp</a>)
00226             {
00227                 <a class="code" href="classJournalData.html">JournalData</a> *journalData = <a class="code" href="classJournalData.html#e0">JournalData::instance</a>();
00228                 journalData-&gt;<a class="code" href="classJournalData.html#a20">exportCSV</a>(out);
00229             }
00230         }
00231     }
00232 }
00233 
<a name="l00234"></a><a class="code" href="classImportExport.html#e2">00234</a> <span class="keywordtype">void</span> <a class="code" href="classImportExport.html#e1">ImportExport::exportCSV</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="doxy-qt.tag:" href="qstring.html">QString</a> data)
00235 {
00236     <a class="code" href="classSettings.html">Settings</a> *settings = <a class="code" href="classSettings.html#e0">Settings::instance</a>();
00237 
00238     <a class="codeRef" doxygen="doxy-qt.tag:" href="qstring.html">QString</a> fileName = QFileDialog::getSaveFileName(
00239                     settings-&gt;<a class="code" href="classSettings.html#a3">getExportPath</a>(),
00240                     <span class="stringliteral">"Comma Separated Values (*.*)"</span>,
00241                     0, <span class="stringliteral">"importExport::export_file_dialog"</span>,
00242                     <span class="stringliteral">"Export CSV Data"</span>);
00243 
00244     <span class="keywordflow">if</span>(fileName != QString::null)
00245     {
00246         <span class="keywordtype">int</span> dirPos = fileName.findRev(<span class="stringliteral">"/"</span>);
00247         <span class="keywordflow">if</span>(dirPos == -1)
00248             dirPos = fileName.findRev(<span class="stringliteral">"\\"</span>);
00249 
00250         settings-&gt;<a class="code" href="classSettings.html#a4">setExportPath</a>(fileName.left(dirPos));
00251 
00252         <a class="codeRef" doxygen="doxy-qt.tag:" href="qfile.html">QFile</a> file(fileName);
00253 
00254         <span class="keywordflow">if</span>(file.exists())
00255         {
00256             <span class="keywordflow">if</span>(!<a class="code" href="classImportExport.html#h0">overwriteDialog</a>())
00257             {
00258                 <span class="keywordflow">return</span> <a class="code" href="classImportExport.html#e1">exportCSV</a>(data);
00259             }
00260         }
00261         <span class="keywordflow">if</span>(file.open(IO_WriteOnly))
00262         {
00263             <a class="codeRef" doxygen="doxy-qt.tag:" href="qtextstream.html">QTextStream</a> out(&amp;file);
00264             out.setEncoding(QTextStream::Locale);
00265 
00266             out &lt;&lt; data;
00267         }
00268         file.close();
00269     }
00270 }
00271 
<a name="l00272"></a><a class="code" href="classImportExport.html#e3">00272</a> <span class="keywordtype">void</span> <a class="code" href="classImportExport.html#e3">ImportExport::exportPDF</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="doxy-qt.tag:" href="qstring.html">QString</a> &amp;text)
00273 {}
00274 
00275 <span class="comment">// Private</span>
00276 
<a name="l00277"></a><a class="code" href="classImportExport.html#d0">00277</a> <a class="code" href="classImportExport.html#d0">ImportExport::ImportExport</a>() {}
00278 
<a name="l00279"></a><a class="code" href="classImportExport.html#d1">00279</a> <a class="code" href="classImportExport.html#d1">ImportExport::~ImportExport</a>() {}
00280 
<a name="l00281"></a><a class="code" href="classImportExport.html#h0">00281</a> <span class="keywordtype">bool</span> <a class="code" href="classImportExport.html#h0">ImportExport::overwriteDialog</a>()
00282 {
00283     <a class="codeRef" doxygen="doxy-qt.tag:" href="qdialog.html">QDialog</a> *dialog  = <span class="keyword">new</span> <a class="codeRef" doxygen="doxy-qt.tag:" href="qdialog.html">QDialog</a>(0, <span class="stringliteral">"importExport::dialog"</span>);
00284     dialog-&gt;setCaption(<span class="stringliteral">"File Exists"</span>);
00285 
00286     <a class="codeRef" doxygen="doxy-qt.tag:" href="qvboxlayout.html">QVBoxLayout</a> *vBoxLayout = <span class="keyword">new</span> <a class="codeRef" doxygen="doxy-qt.tag:" href="qvboxlayout.html">QVBoxLayout</a>(dialog, 5, 5,
00287         <span class="stringliteral">"importExport::vBoxLayout"</span>);
00288 
00289     <a class="codeRef" doxygen="doxy-qt.tag:" href="qlabel.html">QLabel</a> *label = <span class="keyword">new</span> <a class="codeRef" doxygen="doxy-qt.tag:" href="qlabel.html">QLabel</a>(<span class="stringliteral">"&lt;nobr&gt;The file you chose already exists.&lt;/nobr&gt;&lt;br&gt;"</span>
00290         <span class="stringliteral">"&lt;nobr&gt;Would you like to overwrite this file?&lt;/nobr&gt;"</span>, dialog,
00291         <span class="stringliteral">"importExport::label"</span>);
00292     vBoxLayout-&gt;addWidget(label);
00293 
00294     vBoxLayout-&gt;addSpacing(10);
00295 
00296     <a class="codeRef" doxygen="doxy-qt.tag:" href="qhboxlayout.html">QHBoxLayout</a> *hBoxLayout = <span class="keyword">new</span> <a class="codeRef" doxygen="doxy-qt.tag:" href="qhboxlayout.html">QHBoxLayout</a>(vBoxLayout, 5,
00297         <span class="stringliteral">"importExport::hBoxLayout"</span>);
00298 
00299     <a class="codeRef" doxygen="doxy-qt.tag:" href="qpushbutton.html">QPushButton</a> *overwriteButton = <span class="keyword">new</span> <a class="codeRef" doxygen="doxy-qt.tag:" href="qpushbutton.html">QPushButton</a>(<a class="codeRef" doxygen="doxy-qt.tag:" href="qiconset.html">QIconSet</a>(
00300         QPixmap::fromMimeSource(ICON_PATH + <span class="stringliteral">"/deleteButton.png"</span>)),
00301         <span class="stringliteral">"Overwrite"</span>, dialog, <span class="stringliteral">"importExport::overwriteButton"</span>);
00302     connect(overwriteButton, SIGNAL(clicked()), dialog, SLOT(accept()));
00303     overwriteButton-&gt;setDefault(<span class="keyword">false</span>);
00304 
00305     QPushButton *cancelButton = <span class="keyword">new</span> QPushButton(<a class="codeRef" doxygen="doxy-qt.tag:" href="qiconset.html">QIconSet</a>(
00306         QPixmap::fromMimeSource(ICON_PATH + <span class="stringliteral">"/cancelButton.png"</span>)),
00307         <span class="stringliteral">"Cancel"</span>, dialog, <span class="stringliteral">"importExport::cancelButton"</span>);
00308     connect(cancelButton, SIGNAL(clicked()), dialog, SLOT(reject()));
00309     cancelButton-&gt;setDefault(<span class="keyword">true</span>);
00310 
00311     hBoxLayout-&gt;addStretch();
00312     hBoxLayout-&gt;addWidget(overwriteButton);
00313     hBoxLayout-&gt;addWidget(cancelButton);
00314 
00315     <span class="keywordtype">bool</span> retVal = dialog-&gt;exec();
00316     <span class="keyword">delete</span> dialog;
00317     <span class="keywordflow">return</span> retVal;
00318 }
00319 
00320 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sun Jan 16 16:23:28 2005 for General Ledger by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
